<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --green: #005a2b;
  --gold: #d4af37;
  --light-bg: #f7f7f5;
  --white: #fff;
}
body {
  font-family: "Inter", sans-serif;
  margin: 0;
  background: var(--light-bg);
  color: #1b1b1b;
}
header {
  background: var(--green);
  color: var(--gold);
  text-align: center;
  padding: 20px;
  font-size: 1.8rem;
  font-weight: 700;
}
.container {
  max-width: 1100px;
  margin: 30px auto;
  background: var(--white);
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.hidden { display: none; }
button {
  background: var(--green);
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s;
}
button:hover { background: #0a6b34; }
button.secondary {
  background: var(--gold);
  color: #000;
}
nav.admin-nav {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
  margin-bottom: 20px;
}
nav.admin-nav button {
  background: #eee;
  color: #000;
}
nav.admin-nav button.active {
  background: var(--green);
  color: var(--gold);
}
#toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--green);
  color: var(--gold);
  padding: 10px 20px;
  border-radius: 8px;
  opacity: 0;
  transition: opacity 0.4s;
}
.section {
  display: none;
}
.section.active {
  display: block;
}
input[type=password] {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
h2 {
  color: var(--green);
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #eee;
  text-align: left;
}
th {
  background: var(--green);
  color: var(--gold);
}
.tt-group {
  background: #f8f8f8;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
}
.tt-time {
  font-weight: 600;
  color: var(--green);
}
.small {
  font-size: 0.9rem;
  color: #666;
}
</style>
</head>
<body>
<header>üèåÔ∏è Barford Golf Society ‚Äì Admin Portal</header>

<div class="container" id="loginContainer">
  <h2>Admin Access</h2>
  <p>Please enter the admin password to access management tools.</p>
  <input type="password" id="adminPassword" placeholder="Enter password" />
  <button id="loginBtn">Unlock Admin</button>
</div>

<div class="container hidden" id="adminContainer">
  <h2>Admin Dashboard</h2>
  <nav class="admin-nav">
    <button id="rsvpTabBtn" class="active">üìã RSVP Manager</button>
    <button id="teeTimeTabBtn">‚õ≥ Tee Time Organiser</button>
  </nav>

  <!-- RSVP Manager Section -->
  <section id="rsvpSection" class="section active">
    <h3>RSVP Manager</h3>
    <p>Select an event below to view or edit RSVPs.</p>
    <select id="rsvpEventSelect">
      <option value="">Select Event</option>
    </select>
    <div id="rsvpTableContainer"></div>
  </section>

  <!-- Tee Time Organiser Section -->
  <section id="teeTimeSection" class="section">
    <div id="teeTimeLogin">
      <h3>‚õ≥ Tee Time Organiser (Restricted)</h3>
      <p>Enter secondary password to access tee time tools.</p>
      <input type="password" id="teePw" placeholder="Enter Tee Time Password" />
      <button id="teeUnlockBtn">Unlock</button>
    </div>

    <div id="teeTools" class="hidden">
      <h3>Generate Tee Times</h3>
      <p class="small">
        Select an event to organise tee times. Buggies go first.  
        Buggy groups will show phone numbers so partners can contact each other.
      </p>
      <select id="teeEventSelect">
        <option value="">Select Event</option>
      </select>
      <button id="generateBtn">Generate Tee Times</button>
      <button id="saveBtn" class="secondary hidden">Save Tee Times to Supabase</button>
      <div id="teePreview" style="margin-top:20px;"></div>
    </div>
  </section>
</div>

<div id="toast"></div>

<script>
/* =========================
   SUPABASE SETUP
   ========================= */
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const ADMIN_PASSWORD = "westbrom1997";
const TEE_PASSWORD   = "oxford1";

let teeSheetCache = [];

/* =========================
   TOAST POPUP
   ========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.opacity = 1;
  setTimeout(() => t.style.opacity = 0, 2500);
}

/* =========================
   LOGIN
   ========================= */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const pw = document.getElementById("adminPassword").value.trim();
  if (pw === ADMIN_PASSWORD) {
    document.getElementById("loginContainer").classList.add("hidden");
    document.getElementById("adminContainer").classList.remove("hidden");
    showToast("‚úÖ Admin access granted");
    await loadEvents();
  } else alert("Incorrect password");
});

/* =========================
   TABS
   ========================= */
document.getElementById("rsvpTabBtn").addEventListener("click", () => setActiveTab("rsvp"));
document.getElementById("teeTimeTabBtn").addEventListener("click", () => setActiveTab("tee"));

function setActiveTab(tab) {
  document.getElementById("rsvpSection").classList.toggle("active", tab === "rsvp");
  document.getElementById("teeTimeSection").classList.toggle("active", tab === "tee");
  document.getElementById("rsvpTabBtn").classList.toggle("active", tab === "rsvp");
  document.getElementById("teeTimeTabBtn").classList.toggle("active", tab === "tee");
}

/* =========================
   LOAD EVENTS (for both tabs)
   ========================= */
async function loadEvents() {
  const { data, error } = await supabase
    .from("events")
    .select("id, name, date")
    .order("date", { ascending: true });

  if (error) {
    console.error(error);
    alert("Error loading events");
    return;
  }

  const rsvpSelect = document.getElementById("rsvpEventSelect");
  const teeSelect  = document.getElementById("teeEventSelect");

  [rsvpSelect, teeSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Select Event</option>' +
      data.map(ev => `<option value="${ev.id}">${ev.name} ‚Äî ${ev.date}</option>`).join('');
  });

  rsvpSelect.onchange = () => loadRSVPs(rsvpSelect.value);
}

/* =========================
   RSVP MANAGER
   ========================= */
async function loadRSVPs(eventId) {
  if (!eventId) return;
  const container = document.getElementById("rsvpTableContainer");
  container.innerHTML = "<p>Loading RSVPs...</p>";

  const { data, error } = await supabase
    .from("rsvps")
    .select("*")
    .eq("event_id", eventId)
    .order("name", { ascending: true });

  if (error) {
    console.error(error);
    container.innerHTML = "<p style='color:red'>Error fetching RSVPs.</p>";
    return;
  }
  if (!data.length) {
    container.innerHTML = "<p>No RSVPs yet for this event.</p>";
    return;
  }

  let html = `<table><thead><tr>
    <th>Name</th><th>Phone</th><th>Buggy</th><th>Flexibility</th><th>Attending</th>
  </tr></thead><tbody>`;
  data.forEach(r => {
    html += `<tr>
      <td>${r.name}</td>
      <td>${r.phone || ""}</td>
      <td>${r.buggy ? "Yes" : "No"}</td>
      <td>${r.flexibility || ""}</td>
      <td>
        <input type="checkbox" ${r.attending ? "checked" : ""} onchange="toggleAttend(${r.id}, this.checked)">
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  container.innerHTML = html;
}

// Called from inline onchange
async function toggleAttend(id, attending) {
  const { error } = await supabase
    .from("rsvps")
    .update({ attending })
    .eq("id", id);
  if (error) {
    console.error(error);
    showToast("‚ö†Ô∏è Error updating attendance");
  } else showToast("‚úÖ RSVP updated");
}

/* =========================
   TEE TIME PASSWORD GATE
   ========================= */
document.getElementById("teeUnlockBtn").addEventListener("click", () => {
  const pw = document.getElementById("teePw").value.trim();
  if (pw === TEE_PASSWORD) {
    document.getElementById("teeTimeLogin").classList.add("hidden");
    document.getElementById("teeTools").classList.remove("hidden");
    showToast("‚úÖ Tee Time tools unlocked");
  } else {
    alert("Incorrect Tee Time password");
  }
});

/* =========================
   TEE TIME GENERATION
   ========================= */
document.getElementById("generateBtn").addEventListener("click", async () => {
  const eventId = document.getElementById("teeEventSelect").value;
  if (!eventId) return alert("Select an event first");

  const { data: rsvps, error } = await supabase
    .from("rsvps")
    .select("name, phone, buggy, attending, flexibility, event_id")
    .eq("event_id", eventId)
    .eq("attending", true);

  if (error) {
    console.error(error);
    return alert("Error fetching RSVPs for tee time generation");
  }
  if (!rsvps.length) {
    return alert("No attending RSVPs for this event.");
  }

  // Separate buggy and walkers (buggy is boolean)
  let buggyPlayers = rsvps.filter(p => p.buggy === true);
  let walkers      = rsvps.filter(p => !p.buggy);

  // If odd number of buggy players, try move a flexible one to walkers
  if (buggyPlayers.length % 2 === 1) {
    const idx = buggyPlayers.findIndex(p =>
      (p.flexibility || "").toLowerCase().includes("happy")
    );
    if (idx !== -1) {
      walkers.push(buggyPlayers[idx]);
      buggyPlayers.splice(idx, 1);
    }
  }

  const groups = [];

  // Buggy pairs first
  for (let i = 0; i < buggyPlayers.length; i += 2) {
    const grp = buggyPlayers.slice(i, i + 2);
    if (grp.length) groups.push(grp);
  }

  // Remaining walkers into 3- or 4-balls
  let remaining = walkers.slice();
  while (remaining.length > 0) {
    if (remaining.length === 3 || remaining.length === 5 || remaining.length === 7) {
      groups.push(remaining.splice(0, 3));
    } else {
      groups.push(remaining.splice(0, 4));
    }
  }

  // Build tee sheet with times
  teeSheetCache = [];
  const start = new Date();
  start.setHours(9, 0, 0, 0); // 09:00 start
  const intervalMins = 8;

  groups.forEach((grp, idx) => {
    const d = new Date(start.getTime() + idx * intervalMins * 60000);
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    const timeStr = `${hh}:${mm}`;
    teeSheetCache.push({
      groupNumber: idx + 1,
      time: timeStr,
      players: grp.map(p => p.name)
    });
  });

  await renderTeePreview(eventId);
  document.getElementById("saveBtn").classList.remove("hidden");
});

/* =========================
   RENDER PREVIEW (with phones for buggy groups)
   ========================= */
async function renderTeePreview(eventId) {
  const preview = document.getElementById("teePreview");
  if (!teeSheetCache.length) {
    preview.innerHTML = "<p class='small'>No tee times generated yet.</p>";
    return;
  }

  // Fetch RSVP data again to map name -> buggy/phone
  const { data: rsvpData, error } = await supabase
    .from("rsvps")
    .select("name, buggy, phone")
    .eq("event_id", eventId);

  if (error) {
    console.error(error);
    preview.innerHTML = "<p class='small'>Error loading player info.</p>";
    return;
  }

  let html = "<h4>Proposed Tee Times</h4>";
  teeSheetCache.forEach(g => {
    const playerData = g.players.map(name => rsvpData.find(r => r.name === name) || {});
    const isBuggyGroup = playerData.length > 0 && playerData.every(p => p.buggy === true);

    const line = playerData.map(p => {
      if (isBuggyGroup && p.phone) {
        return `${p.name} (${p.phone})`;
      }
      return p.name;
    }).join(", ");

    html += `
      <div class="tt-group">
        <div class="tt-time">Group ${g.groupNumber} ‚Äî ${g.time}</div>
        <div>${line}</div>
      </div>
    `;
  });

  preview.innerHTML = html;
}

/* =========================
   SAVE TEE TIMES
   ========================= */
document.getElementById("saveBtn").addEventListener("click", async () => {
  const eventId = document.getElementById("teeEventSelect").value;
  if (!eventId || !teeSheetCache.length) {
    return alert("Nothing to save.");
  }

  // Clear existing tee times for this event then insert new
  const { error: delErr } = await supabase
    .from("tee_times")
    .delete()
    .eq("event_id", eventId);
  if (delErr) {
    console.error(delErr);
    showToast("‚ö†Ô∏è Error clearing old tee times");
    return;
  }

  const rows = teeSheetCache.map(g => ({
    event_id: parseInt(eventId, 10),
    group_number: g.groupNumber,
    tee_time: g.time,
    players: g.players
  }));

  const { error: insErr } = await supabase.from("tee_times").insert(rows);
  if (insErr) {
    console.error(insErr);
    showToast("‚ö†Ô∏è Error saving tee times");
  } else {
    showToast("‚úÖ Tee times saved to Supabase!");
  }
}
);
</script>
</body>
</html>
