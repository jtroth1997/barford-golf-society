<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --green: #083d0b;
  --gold: #d4af37;
  --cream: #f7f7f5;
  --dark: #1b1b1b;
  --white: #ffffff;
}
body {
  font-family: "Inter", sans-serif;
  margin: 0;
  background: var(--cream);
  color: var(--dark);
}
header {
  background: linear-gradient(to right, var(--green), #145214);
  color: var(--gold);
  text-align: center;
  padding: 20px;
  font-size: 1.8rem;
  font-weight: 700;
}
.navbar {
  display: flex;
  justify-content: center;
  gap: 30px;
  background: var(--white);
  padding: 12px 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.navbar a {
  color: var(--green);
  text-decoration: none;
  font-weight: 600;
}
.navbar a:hover { color: var(--gold); }
main {
  max-width: 1100px;
  margin: 40px auto;
  background: var(--white);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
h2 {
  text-align: center;
  color: var(--green);
}
.tabs {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}
.tab-btn {
  background: #ddd;
  border: none;
  padding: 10px 15px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
}
.tab-btn.active {
  background: var(--gold);
  color: var(--dark);
}
.hidden { display: none; }
button {
  background: var(--green);
  color: var(--white);
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  margin-top: 10px;
}
button:hover { background: #0a5a0a; }
select, input {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-family: inherit;
}
.group {
  background: #f9f9f9;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
}
.phone {
  color: #555;
  font-size: 0.9rem;
}
.notice {
  background: #fff8dc;
  padding: 10px;
  border-radius: 6px;
  color: #555;
  margin-bottom: 10px;
}
footer {
  background: var(--green);
  color: var(--gold);
  text-align: center;
  padding: 20px;
  margin-top: 40px;
}
</style>
</head>
<body>
<header>Admin Panel - Barford Golf Society</header>
<div class="navbar">
  <a href="index.html">Home</a>
  <a href="events.html">Events</a>
  <a href="scores.html">Scores</a>
  <a href="admin.html" class="active">Admin</a>
</div>

<main>
  <div class="tabs">
    <button class="tab-btn active" id="rsvpTab">RSVP Manager</button>
    <button class="tab-btn" id="teeTab">Tee Time Organiser</button>
  </div>

  <div id="loginSection">
    <h3>Admin Login</h3>
    <input type="password" id="adminPassword" placeholder="Enter password">
    <button id="loginBtn">Login</button>
  </div>

  <div id="rsvpSection" class="hidden">
    <h2>RSVP Manager</h2>
    <label>Select Event:</label>
    <select id="eventSelect"></select>
    <div id="rsvpList"></div>
  </div>

  <div id="teeSection" class="hidden">
    <h2>Tee Time Organiser</h2>
    <div id="teeLogin">
      <input type="password" id="teePassword" placeholder="Enter Tee Password">
      <button id="teeLoginBtn">Unlock</button>
    </div>

    <div id="teeControls" class="hidden">
      <label>Select Event:</label>
      <select id="teeEventSelect"></select>
      <br><br>
      <label>First Tee Time:</label>
      <input type="time" id="firstTeeTime" value="09:00">
      <label>Interval (mins):</label>
      <input type="number" id="intervalMins" value="8" min="4" max="15">
      <br><br>
      <button id="generateTeeTimes">Generate Tee Times</button>
      <div id="teeOutput"></div>
    </div>
  </div>
</main>
<footer>Â© 2025 Barford Golf Society</footer>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_PW = "westbrom1997";
const TEE_PW = "oxford1";

// ========== LOGIN HANDLERS ==========
document.addEventListener("DOMContentLoaded", () => {
  const adminLogin = document.getElementById("adminLogin");
  const adminSection = document.getElementById("adminSection");
  const teeLogin = document.getElementById("teeLogin");
  const teeSection = document.getElementById("teeSection");

  // Hide both sections by default
  adminSection.classList.add("hidden");
  teeSection.classList.add("hidden");

  // --- Admin Unlock ---
  document.getElementById("adminUnlockBtn").addEventListener("click", () => {
    const pw = document.getElementById("adminPw").value.trim();
    if (pw === ADMIN_PW) {
      adminLogin.classList.add("hidden");
      adminSection.classList.remove("hidden");
      alert("âœ… Admin access granted!");
    } else {
      alert("âŒ Incorrect admin password");
    }
  });

  // --- Tee Time Unlock ---
  document.getElementById("teeUnlockBtn").addEventListener("click", () => {
    const pw = document.getElementById("teePw").value.trim();
    if (pw === TEE_PW) {
      teeLogin.classList.add("hidden");
      teeSection.classList.remove("hidden");
      alert("âœ… Tee Time Organiser access granted!");
    } else {
      alert("âŒ Incorrect tee organiser password");
    }
  });

  // Optional lock buttons (if youâ€™ve added them)
  document.querySelectorAll(".lockBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      adminSection.classList.add("hidden");
      adminLogin.classList.remove("hidden");
      document.getElementById("adminPw").value = "";
      alert("ðŸ”’ Locked admin access.");
    });
  });
});


// Generate Tee Times (fixed pairing logic)
document.getElementById("generateBtn").addEventListener("click", async () => {
  const eventId = document.getElementById("eventSelect").value;
  if (!eventId) return alert("Select an event first.");

  const startTime = document.getElementById("startTime").value || "09:00";
  const interval = parseInt(document.getElementById("interval").value || "8");

  const { data: rsvps, error } = await supabase
    .from("rsvps")
    .select("*")
    .eq("event_id", eventId)
    .eq("attending", true);

  if (error || !rsvps?.length) {
    alert("No RSVPs found for this event.");
    return;
  }

  // Separate buggy and walkers
  let buggy = rsvps.filter(r => r.buggy);
  let walkers = rsvps.filter(r => !r.buggy);

  // Handle flexibility (move flexible buggy people to walkers if odd)
  if (buggy.length % 2 === 1) {
    const flexible = buggy.find(r => r.flexibility?.includes("happy to walk"));
    if (flexible) {
      buggy = buggy.filter(r => r.id !== flexible.id);
      walkers.push(flexible);
    }
  }

  const teeTimes = [];
  let currentTime = startTime;
  let groupNum = 1;

  function addMinutes(time, mins) {
    const [h, m] = time.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m + mins);
    return d.toTimeString().slice(0,5);
  }

  // Group buggy pairs first
  for (let i = 0; i < buggy.length; i += 2) {
    const pair = buggy.slice(i, i + 2);
    if (pair.length === 2) {
      teeTimes.push({
        event_id: eventId,
        group_number: groupNum++,
        tee_time: currentTime,
        players: pair.map(p => p.name),
      });
    } else {
      // Single buggy (will add walkers later)
      teeTimes.push({
        event_id: eventId,
        group_number: groupNum++,
        tee_time: currentTime,
        players: [pair[0].name],
      });
    }
    currentTime = addMinutes(currentTime, interval);
  }

  // Fill single buggy groups with walkers
  for (let g of teeTimes.filter(g => g.players.length === 1)) {
    const needed = 3;
    const addWalkers = walkers.splice(0, needed);
    g.players = g.players.concat(addWalkers.map(w => w.name));
  }

  // Add remaining walkers (3 or 4 balls)
  while (walkers.length > 0) {
    const groupSize = walkers.length === 3 || walkers.length % 4 === 3 ? 3 : 4;
    const group = walkers.splice(0, groupSize);
    teeTimes.push({
      event_id: eventId,
      group_number: groupNum++,
      tee_time: currentTime,
      players: group.map(p => p.name),
    });
    currentTime = addMinutes(currentTime, interval);
  }

  // Save to Supabase
  await supabase.from("tee_times").delete().eq("event_id", eventId);
  const { error: insertErr } = await supabase.from("tee_times").insert(teeTimes);

  if (insertErr) {
    console.error(insertErr);
    alert("Error saving tee times.");
  } else {
    alert("âœ… Tee times generated successfully!");
    loadTeeTimes(eventId);
  }
});


  // Assign tee times
  const firstTee=document.getElementById("firstTeeTime").value;
  const interval=parseInt(document.getElementById("intervalMins").value)||8;
  const [h,m]=firstTee.split(":").map(Number);
  let teeDate=new Date(0,0,0,h,m);
  groups.forEach((g,i)=>{
    const timeStr=teeDate.toTimeString().slice(0,5);
    g.teeTime=timeStr;
    teeDate.setMinutes(teeDate.getMinutes()+interval);
  });

  // Output display
  const out=document.getElementById("teeOutput");
  out.innerHTML=groups.map((g,i)=>{
    return `
      <div class='group'>
        <strong>Group ${i+1} â€” ${g.teeTime}</strong><br>
        <em>${g.type}</em><ul>
        ${g.players.map(p=>{
          const phoneText=p.buggy && p.phone ? ` <span class='phone'>(${p.phone})</span>` : "";
          return `<li>${p.name}${phoneText}</li>`;
        }).join("")}
        </ul>
      </div>
    `;
  }).join("");

  // Save to Supabase
  await supabase.from("tee_times").delete().eq("event_id", eventId);
  for(let i=0;i<groups.length;i++){
    const g=groups[i];
    await supabase.from("tee_times").insert({
      event_id: eventId,
      group_number: i+1,
      tee_time: g.teeTime,
      players: g.players.map(p=>p.name)
    });
  }

  alert("âœ… Tee times generated and saved!");
});
</script>
</body>
</html>


