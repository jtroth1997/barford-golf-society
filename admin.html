<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root {
  --green: #005a2b;
  --gold: #d4af37;
  --light-bg: #f7f7f5;
}
body {
  font-family: "Inter", sans-serif;
  margin: 0;
  background: var(--light-bg);
  color: #1b1b1b;
}
header, footer {
  background: var(--green);
  color: white;
  padding: 15px 0;
}
.header-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 20px;
}
.site-title { color: var(--gold); }
.container {
  max-width: 1100px;
  margin: 40px auto;
  padding: 0 20px;
}
button {
  background: var(--green);
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
}
button:hover { background: #0a6b34; }
.hidden { display: none; }
.tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.tab-btn {
  background: #ccc; color: #333; padding: 10px 16px; border-radius: 6px; cursor: pointer;
}
.tab-btn.active { background: var(--gold); color: #000; font-weight: 600; }
.section { display: none; }
.section.active { display: block; }
.event-select { padding: 6px; border-radius: 4px; margin-top: 10px; }
.tee-settings { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
.result-box {
  background: white;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.group {
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}
.group:last-child { border: none; }
</style>
</head>
<body>

<header>
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society â€” Admin</h1>
    <nav>
      <a href="index.html" style="color:white;">Home</a>
    </nav>
  </div>
</header>

<div class="container">
  <div id="loginSection">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Enter admin password">
    <button id="loginBtn">Login</button>
    <p class="small">Access restricted to admins.</p>
  </div>

  <div id="adminPanel" class="hidden">
    <div class="tabs">
      <div class="tab-btn active" data-tab="rsvpTab">RSVP Manager</div>
      <div class="tab-btn" data-tab="teeTab">Tee Time Organiser</div>
    </div>

    <!-- RSVP Manager -->
    <div id="rsvpTab" class="section active">
      <h2>RSVP Manager</h2>
      <select id="rsvpEventSelect" class="event-select"></select>
      <button id="loadRsvpsBtn">Load RSVPs</button>
      <div id="rsvpList" class="result-box"></div>
    </div>

    <!-- Tee Time Organiser -->
    <div id="teeTab" class="section">
      <h2>Tee Time Organiser</h2>
      <div id="teePasswordSection">
        <input type="password" id="teePassword" placeholder="Enter Tee Time password">
        <button id="unlockTeeBtn">Unlock</button>
        <p class="small">Password required: oxford1</p>
      </div>
      <div id="teePanel" class="hidden">
        <select id="teeEventSelect" class="event-select"></select>
        <div class="tee-settings">
          <label>First Tee Time: <input type="time" id="firstTeeTime" value="09:00"></label>
          <label>Interval (mins): <input type="number" id="intervalMins" value="8" min="5" max="15"></label>
        </div>
        <button id="generateTeeBtn">Generate Tee Times</button>
        <div id="teeResults" class="result-box"></div>
      </div>
    </div>
  </div>
</div>

<footer><p style="text-align:center;color:var(--gold);">Â© 2025 Barford Golf Society</p></footer>

<script>
// ========== CONFIG ==========
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co
";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ
";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const ADMIN_PW = "westbrom1997";
const TEE_PW = "oxford1";

// ========== LOGIN ==========
const loginBtn = document.getElementById("loginBtn");
const adminPanel = document.getElementById("adminPanel");
loginBtn.addEventListener("click", () => {
  const val = document.getElementById("adminPassword").value.trim();
  if (val === ADMIN_PW) {
    document.getElementById("loginSection").classList.add("hidden");
    adminPanel.classList.remove("hidden");
    loadEvents();
  } else alert("Incorrect password");
});

// Tabs
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// ========== LOAD EVENTS ==========
async function loadEvents() {
  const { data, error } = await supabase.from("events").select("*").order("date");
  if (error) { console.error(error); return; }
  const opts = data.map(e=>`<option value="${e.id}">${e.name} (${e.date})</option>`).join("");
  document.getElementById("rsvpEventSelect").innerHTML = opts;
  document.getElementById("teeEventSelect").innerHTML = opts;
}

// ========== RSVP MANAGER ==========
document.getElementById("loadRsvpsBtn").addEventListener("click", async ()=>{
  const id = document.getElementById("rsvpEventSelect").value;
  const { data, error } = await supabase.from("rsvps").select("*").eq("event_id", id);
  if (error) { alert("Error fetching RSVPs"); return; }
  if (!data.length) return document.getElementById("rsvpList").innerHTML = "<p>No RSVPs yet.</p>";
  let html = "<h3>RSVP List</h3><ul>";
  data.forEach(r=>{
    html += `<li><strong>${r.name}</strong> â€” ${r.attending ? "Attending" : "Not attending"} ${r.buggy ? "ðŸ›º" : ""} (${r.flexibility||""})</li>`;
  });
  html += "</ul>";
  document.getElementById("rsvpList").innerHTML = html;
});
// ========== TEE TIME PASSWORD ==========
document.getElementById("unlockTeeBtn").addEventListener("click", () => {
  const val = document.getElementById("teePassword").value.trim();
  if (val === TEE_PW) {
    document.getElementById("teePasswordSection").classList.add("hidden");
    document.getElementById("teePanel").classList.remove("hidden");
  } else alert("Incorrect tee time password");
});

// ========== TEE TIME GENERATOR ==========
document.getElementById("generateTeeBtn").addEventListener("click", async ()=>{
  const eventId = document.getElementById("teeEventSelect").value;
  const firstTee = document.getElementById("firstTeeTime").value || "09:00";
  const interval = parseInt(document.getElementById("intervalMins").value) || 8;

  // Get RSVPs
  const { data: rsvps, error } = await supabase.from("rsvps").select("*").eq("event_id", eventId);
  if (error) return alert("Error fetching RSVPs");

  const players = rsvps.filter(r=>r.attending);
  if (!players.length) return alert("No RSVPs found for this event");

  // Categorise players
  let buggies = players.filter(p=>p.buggy);
  let walkers = players.filter(p=>!p.buggy);

  // Handle buggy flexibility
  let flexible = buggies.filter(p=>p.flexibility && p.flexibility.toLowerCase().includes("happy"));
  if (buggies.length % 2 !== 0 && flexible.length) {
    const move = flexible.shift();
    buggies = buggies.filter(p=>p.name !== move.name);
    walkers.push(move);
  }

  // Pair buggies
  let buggyPairs = [];
  for (let i=0; i<buggies.length; i+=2) {
    if (buggies[i+1]) buggyPairs.push([buggies[i], buggies[i+1]]);
    else buggyPairs.push([buggies[i]]); // single buggy
  }

  // Handle lone buggy case (paired with walkers)
  let singleBuggy = buggyPairs.find(p=>p.length===1);
  if (singleBuggy) {
    buggyPairs = buggyPairs.filter(p=>p.length>1);
  }

  // Group walkers
  let walkerGroups = [];
  const walkerCount = walkers.length;
  let walkerIndex = 0;

  while (walkerIndex < walkerCount) {
    let remaining = walkerCount - walkerIndex;
    if (remaining === 3) {
      walkerGroups.push(walkers.slice(walkerIndex, walkerIndex+3));
      walkerIndex += 3;
    } else if (remaining >= 4) {
      walkerGroups.push(walkers.slice(walkerIndex, walkerIndex+4));
      walkerIndex += 4;
    } else {
      walkerGroups.push(walkers.slice(walkerIndex));
      walkerIndex = walkerCount;
    }
  }

  // Combine tee groups
  let groups = [];

  // Add buggy pairs first
  buggyPairs.forEach(pair => {
    if (pair.length === 2) groups.push({ buggies: [pair], walkers: [] });
  });

  // Add single buggy if exists
  if (singleBuggy) {
    // attach to first walker 3-ball if possible
    if (walkerGroups.length && walkerGroups[0].length === 3) {
      groups.push({ buggies: [singleBuggy], walkers: walkerGroups.shift() });
    } else if (walkerGroups.length) {
      groups.push({ buggies: [singleBuggy], walkers: walkerGroups.shift() });
    } else {
      groups.push({ buggies: [singleBuggy], walkers: [] });
    }
  }

  // Add remaining walker groups
  walkerGroups.forEach(g=>{
    groups.push({ buggies: [], walkers: g });
  });

  // Generate tee times
  let current = new Date(`2024-01-01T${firstTee}`);
  let formattedGroups = [];
  groups.forEach((g,i)=>{
    const teeTime = current.toTimeString().slice(0,5);
    formattedGroups.push({ group_number: i+1, tee_time: teeTime, buggies: g.buggies, walkers: g.walkers });
    current.setMinutes(current.getMinutes() + interval);
  });

  // Save to Supabase
  await supabase.from("tee_times").delete().eq("event_id", eventId);
  for (const g of formattedGroups) {
    const players = [];
    g.buggies.forEach(bp=>bp.forEach(p=>players.push(p.name)));
    g.walkers.forEach(p=>players.push(p.name));
    await supabase.from("tee_times").insert({
      event_id: eventId,
      group_number: g.group_number,
      tee_time: g.tee_time,
      players
    });
  }

  // Display
  let html = "<h3>Tee Times</h3>";
  formattedGroups.forEach(g=>{
    html += `<div class="group"><strong>Group ${g.group_number} â€” ${g.tee_time}</strong><br>`;
    if (g.buggies.length) {
      g.buggies.forEach((pair,idx)=>{
        if (pair.length === 2) {
          html += `Buggy Pair ${idx+1}: ${pair[0].name} (${pair[0].phone||'N/A'}), ${pair[1].name} (${pair[1].phone||'N/A'})<br>`;
        } else {
          html += `Single Buggy: ${pair[0].name} (${pair[0].phone||'N/A'})<br>`;
        }
      });
    }
    if (g.walkers.length) {
      html += `Walkers: ${g.walkers.map(p=>p.name).join(", ")}<br>`;
    }
    html += "</div>";
  });
  document.getElementById("teeResults").innerHTML = html;
  alert("âœ… Tee times generated and saved to Supabase!");
});
</script>
</body>
</html>
