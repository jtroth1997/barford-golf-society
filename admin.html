<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root{
  --green:#005a2b;--gold:#d4af37;--light-bg:#f7f7f5;--card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.hidden{display:none;}
button{background:var(--green);color:#fff;font-weight:600;padding:8px 16px;border:none;border-radius:6px;cursor:pointer;}
button:hover{background:#0a6b34;}
input[type="password"],input[type="time"],input[type="number"],select{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
h2{color:var(--green);}
.notice{background:#fffbe0;border:1px solid #d4af37;padding:10px;border-radius:6px;margin-bottom:10px;}
ul{padding-left:20px;}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="admin.html" class="active">Admin</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <h2>Admin Dashboard</h2>

  <!-- Admin Login -->
  <div id="adminLogin" class="card">
    <h3>RSVP Manager Login</h3>
    <input type="password" id="adminPw" placeholder="Enter admin password">
    <button id="adminUnlockBtn">Unlock</button>
  </div>

  <!-- RSVP Manager Section -->
  <div id="adminSection" class="card hidden">
    <h3>RSVP Manager</h3>
    <p>Welcome to the RSVP Management area. From here you can view event RSVPs and manage attendance lists.</p>
    <button id="openTeeSectionBtn">Go to Tee Time Organiser</button>
  </div>

  <!-- Tee Time Login -->
  <div id="teeLogin" class="card hidden">
    <h3>Tee Time Organiser Login</h3>
    <input type="password" id="teePw" placeholder="Enter organiser password">
    <button id="teeUnlockBtn">Unlock</button>
  </div>

  <!-- Tee Time Section -->
  <div id="teeSection" class="card hidden">
    <h3>Tee Time Organiser</h3>
    <div class="notice">‚õ≥ Note: Any buggy pairs should contact each other directly to organise booking of the buggy.</div>
    <p>Select the event and generate tee times. Buggies will be paired automatically and walkers placed afterwards.</p>

    <label>Select Event:</label>
    <select id="eventSelect"></select>

    <label>First Tee Time:</label>
    <input type="time" id="startTime" value="09:00">

    <label>Interval (mins):</label>
    <input type="number" id="interval" value="8" min="5" max="20">

    <button id="generateBtn">Generate Tee Times</button>

    <div id="teeTimesDisplay" style="margin-top:20px;"></div>
  </div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_PW = "westbrom1997";
const TEE_PW = "oxford1";

document.addEventListener("DOMContentLoaded", async () => {
  const adminLogin = document.getElementById("adminLogin");
  const adminSection = document.getElementById("adminSection");
  const teeLogin = document.getElementById("teeLogin");
  const teeSection = document.getElementById("teeSection");
  const eventSelect = document.getElementById("eventSelect");

  // Hide all sections initially
  adminSection.classList.add("hidden");
  teeLogin.classList.add("hidden");
  teeSection.classList.add("hidden");

  // --- ADMIN LOGIN ---
  const adminUnlockBtn = document.getElementById("adminUnlockBtn");
  if (adminUnlockBtn) {
    adminUnlockBtn.addEventListener("click", async () => {
      const pw = document.getElementById("adminPw").value.trim();
      if (pw === ADMIN_PW) {
        adminLogin.classList.add("hidden");
        adminSection.classList.remove("hidden");
        alert("‚úÖ Admin access granted!");
        await loadRSVPEvents();
      } else {
        alert("‚ùå Incorrect admin password");
      }
    });
  }

  // --- GO TO TEE ORGANISER LOGIN ---
  const openTeeSectionBtn = document.getElementById("openTeeSectionBtn");
  if (openTeeSectionBtn) {
    openTeeSectionBtn.addEventListener("click", () => {
      adminSection.classList.add("hidden");
      teeLogin.classList.remove("hidden");
    });
  }

  // --- TEE TIME ORGANISER LOGIN ---
  const teeUnlockBtn = document.getElementById("teeUnlockBtn");
  if (teeUnlockBtn) {
    teeUnlockBtn.addEventListener("click", () => {
      const pw = document.getElementById("teePw").value.trim();
      if (pw === TEE_PW) {
        teeLogin.classList.add("hidden");
        teeSection.classList.remove("hidden");
        alert("‚úÖ Tee Time Organiser access granted!");
        loadTeeEvents();
      } else {
        alert("‚ùå Incorrect organiser password");
      }
    });
  }

  /* =========================
     RSVP MANAGER FUNCTIONS
     ========================= */
  async function loadRSVPEvents() {
    const { data: events } = await supabase.from("events").select("*").order("date");
    const container = document.createElement("div");
    container.innerHTML = `
      <label>Select Event:</label>
      <select id="rsvpEventSelect">
        ${events.map(e => `<option value="${e.id}">${e.name} (${e.date})</option>`).join("")}
      </select>
      <div id="rsvpList" style="margin-top:20px;"></div>
    `;
    adminSection.appendChild(container);

    document.getElementById("rsvpEventSelect").addEventListener("change", e => {
      loadRSVPList(e.target.value);
    });

    if (events.length) loadRSVPList(events[0].id);
  }

  async function loadRSVPList(eventId) {
    const { data, error } = await supabase.from("rsvps").select("*").eq("event_id", eventId);
    const div = document.getElementById("rsvpList");
    if (error || !data?.length) {
      div.innerHTML = "<p>No RSVPs found for this event.</p>";
      return;
    }

    let html = `
      <table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse;width:100%;">
        <thead style="background:#eee;">
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Attending</th>
            <th>Buggy</th>
            <th>Flexibility</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(r => `
            <tr>
              <td>${r.name}</td>
              <td>${r.phone || ""}</td>
              <td>${r.attending ? "‚úÖ Yes" : "‚ùå No"}</td>
              <td>${r.buggy ? "üõ∫ Yes" : "üö∂ No"}</td>
              <td>${r.flexibility || ""}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    `;
    div.innerHTML = html;
  }

  /* =========================
     TEE ORGANISER FUNCTIONS
     ========================= */
  async function loadTeeEvents() {
    const { data: events } = await supabase.from("events").select("*").order("date");
    if (events?.length) {
      eventSelect.innerHTML = events.map(e => `<option value="${e.id}">${e.name} (${e.date})</option>`).join("");
    }
  }

  // Tee Time Generator
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.addEventListener("click", async () => {
      const eventId = eventSelect.value;
      if (!eventId) return alert("Select an event first.");

      const startTime = document.getElementById("startTime").value || "09:00";
      const interval = parseInt(document.getElementById("interval").value || "8");

      const { data: rsvps, error } = await supabase
        .from("rsvps")
        .select("*")
        .eq("event_id", eventId)
        .eq("attending", true);

      if (error || !rsvps?.length) return alert("‚ö†Ô∏è No RSVPs found for this event.");

      let buggy = rsvps.filter(r => r.buggy);
      let walkers = rsvps.filter(r => !r.buggy);

      // ‚úÖ FIXED FLEXIBILITY: make buggy list even and remove solo flexible players
let flexiblePlayers = buggy.filter(r => r.flexibility?.toLowerCase().includes("happy to walk"));

// Step 1: Keep moving flexible players to walkers until buggy count is even
while (buggy.length % 2 !== 0 && flexiblePlayers.length > 0) {
  const mover = flexiblePlayers.shift();
  buggy = buggy.filter(r => r.id !== mover.id);
  walkers.push(mover);
}

// Step 2: If after pairing there's still a single flexible buggy person left, move them too
if (buggy.length === 1 && buggy[0].flexibility?.toLowerCase().includes("happy to walk")) {
  walkers.push(buggy[0]);
  buggy = [];
}

      
      const teeTimes = [];
      let currentTime = startTime;
      let groupNum = 1;

      function addMinutes(time, mins) {
        const [h, m] = time.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m + mins);
        return d.toTimeString().slice(0,5);
      }

      // Group buggy pairs first (4 buggy players per group max)
      for (let i = 0; i < buggy.length; i += 4) {
        const group = buggy.slice(i, i + 4);
        teeTimes.push({
          event_id: eventId,
          group_number: groupNum++,
          tee_time: currentTime,
          players: group.map(p => p.name)
        });
        currentTime = addMinutes(currentTime, interval);
      }

      // Add walkers (3 balls first then 4 balls)
      while (walkers.length > 0) {
        const groupSize = walkers.length === 3 || walkers.length % 4 === 3 ? 3 : 4;
        const group = walkers.splice(0, groupSize);
        teeTimes.push({
          event_id: eventId,
          group_number: groupNum++,
          tee_time: currentTime,
          players: group.map(p => p.name)
        });
        currentTime = addMinutes(currentTime, interval);
      }

      // Save to Supabase
      await supabase.from("tee_times").delete().eq("event_id", eventId);
      const { error: insertErr } = await supabase.from("tee_times").insert(teeTimes);
      if (insertErr) {
        console.error(insertErr);
        alert("Error saving tee times.");
      } else {
        alert("‚úÖ Tee times generated successfully!");
        displayTeeTimes(eventId);
      }
    });
  }

  async function displayTeeTimes(eventId) {
    const { data } = await supabase
      .from("tee_times")
      .select("*")
      .eq("event_id", eventId)
      .order("group_number");
    const { data: rsvps } = await supabase.from("rsvps").select("*").eq("event_id", eventId);
    const div = document.getElementById("teeTimesDisplay");
    div.innerHTML = "";
    data.forEach(group => {
      const players = group.players.map(name => {
        const r = rsvps.find(p => p.name === name);
        const phone = r?.phone ? ` (${r.phone})` : "";
        return `${r?.buggy ? "üõ∫" : ""} ${name}${phone}`;
      });
      const buggyPairs = players.filter(p => p.includes("üõ∫"));
      const walkers = players.filter(p => !p.includes("üõ∫"));
      div.innerHTML += `
        <div class="card">
          <h4>Group ${group.group_number} ‚Äî ${group.tee_time}</h4>
          ${buggyPairs.length ? `<strong>Buggy Pairs:</strong><ul>${buggyPairs.map(b=>`<li>${b}</li>`).join("")}</ul>` : ""}
          ${walkers.length ? `<strong>Walkers:</strong><ul>${walkers.map(w=>`<li>${w}</li>`).join("")}</ul>` : ""}
        </div>`;
    });
  }
});
</script>
</body>
</html>
