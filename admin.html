<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Barford Golf Handicap Calculator</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<h1>Barford Golf Handicap Calculator</h1>

<!-- Controls -->
<input type="password" id="pw" placeholder="Password">
<button onclick="unlock()">Unlock</button>
<button onclick="lock()">Lock</button>
<button onclick="calculate()">Calculate</button>
<button onclick="prevRound()">Prev Round</button>
<button onclick="nextRound()">Next Round</button>
<button onclick="addPlayer()">Add Player</button>
<button onclick="resetLeague()">Reset</button>

<h3 id="roundHeader">Round 1 of 7</h3>

<table border="1" cellpadding="5">
  <thead>
    <tr>
      <th>Player</th>
      <th>Handicap</th>
      <th>Points</th>
      <th>Adj</th>
      <th>Next Handicap</th>
      <th>Total</th>
      <th>DNP</th>
    </tr>
  </thead>
  <tbody id="players"></tbody>
</table>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let PASSWORD = "westbrom1997";
let unlocked = false;
let currentRound = 1;
const maxRounds = 7;
let players = [];

// ======== CORE FUNCTIONS ========

async function loadPlayers() {
  const { data, error } = await supabase.from("scores").select("*").order("id",{ascending:true});
  if (error) return console.error(error);
  players = data || [];
  render();
}
supabase.channel("scores_realtime")
  .on("postgres_changes", { event: "*", schema: "public", table: "scores" }, loadPlayers)
  .subscribe();

function render() {
  const tbody = document.getElementById("players");
  tbody.innerHTML = "";
  players.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.player}</td>
      <td><input id="hcp_${p.id}" type="number" value="${p.handicap||0}" ${unlocked?"":"disabled"}></td>
      <td><input id="pts_${p.id}" type="number" value="${p.points??""}" ${unlocked?"":"disabled"}></td>
      <td>${p.adj ?? ""}</td>
      <td>${p.next_handicap ?? ""}</td>
      <td>${p.total ?? 0}</td>
      <td><input type="checkbox" ${p.points==null?"checked":""} disabled></td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("roundHeader").textContent = `Round ${currentRound} of ${maxRounds}`;
}

function stablefordAdj(points) {
  if (points >= 43) return -3;
  if (points >= 38) return -2;
  if (points >= 31) return -1;
  if (points >= 26) return 0;
  if (points >= 21) return +1;
  if (points >= 16) return +2;
  return +3;
}

async function calculate() {
  if (!unlocked) return alert("Unlock first.");
  const valid = players.map(p => parseInt(document.getElementById(`pts_${p.id}`).value)||0);
  const top = Math.max(...valid);

  for (const p of players) {
    const hcp = parseFloat(document.getElementById(`hcp_${p.id}`).value) || 0;
    const pts = parseInt(document.getElementById(`pts_${p.id}`).value);
    if (isNaN(pts)) {
      p.points = null; p.adj = null; p.next_handicap = hcp;
    } else {
      const adj = stablefordAdj(pts) - (pts === top ? 1 : 0);
      p.adj = adj;
      p.next_handicap = Math.max(0, Math.round(hcp + adj));
      p.points = pts;
    }
    p.round = currentRound;
    p.updated_at = new Date().toISOString();
    await supabase.from("scores").upsert(p);
  }
  alert("Calculated and updated.");
  loadPlayers();
}

// ======== ROUNDS ========

async function nextRound() {
  if (currentRound < maxRounds) {
    currentRound++;
    for (const p of players) {
      p.handicap = p.next_handicap ?? p.handicap;
      p.points = null; p.adj = null;
      await supabase.from("scores").update({
        handicap: p.handicap, round: currentRound
      }).eq("id", p.id);
    }
    unlocked = false;
    loadPlayers();
  } else alert("League finished!");
}

function prevRound() {
  if (currentRound > 1) {
    currentRound--;
    loadPlayers();
  }
}

// ======== PASSWORD / LOCKING ========

function unlock() {
  const val = document.getElementById("pw").value;
  if (val === PASSWORD) { unlocked = true; alert("Unlocked."); render(); }
  else alert("Wrong password!");
}
function lock() { unlocked = false; alert("Locked."); render(); }

// ======== ADMIN ACTIONS ========

async function addPlayer() {
  const name = prompt("Enter player name:");
  if (!name) return;
  await supabase.from("scores").insert([{ player: name, handicap: 0, points: null, adj: null, next_handicap: 0, total: 0, round: currentRound }]);
  loadPlayers();
}

async function resetLeague() {
  const pw = prompt("Enter password to reset:");
  if (pw !== PASSWORD) return alert("Incorrect password");
  await supabase.from("scores").delete().neq("id", 0);
  currentRound = 1;
  loadPlayers();
}

// ======== INIT ========
loadPlayers();
</script>
</body>
</html>
