<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Barford Handicap Calculator - Minimal</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>Barford Golf Handicap Calculator</h2>

<!-- Controls -->
<label>Password: <input type="password" id="pw"></label>
<button onclick="unlock()">Unlock</button>
<button onclick="lock()">Lock</button>
<button onclick="calculate()">Calculate</button>
<button onclick="nextRound()">Next Round</button>
<button onclick="prevRound()">Prev Round</button>
<button onclick="addPlayer()">Add Player</button>
<button onclick="resetLeague()">Reset</button>

<p id="roundInfo">Round 1 of 7</p>

<pre id="output"></pre>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co
";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ
";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PASSWORD = "westbrom1997";
let unlocked = false;
let currentRound = 1;
const maxRounds = 7;
let players = [];

// === Load players ===
async function loadPlayers() {
  const { data, error } = await supabase.from("scores").select("*").order("id",{ascending:true});
  if (error) console.error(error);
  players = data || [];
  display();
}

// === Realtime sync ===
supabase.channel("scores")
  .on("postgres_changes", { event: "*", schema: "public", table: "scores" }, loadPlayers)
  .subscribe();

// === Display ===
function display() {
  let text = "Player | HCP | Points | Adj | Next HCP | Total\n";
  text += "-------------------------------------------------\n";
  players.forEach(p => {
    text += `${p.player.padEnd(12)} | ${String(p.handicap??"").padEnd(3)} | ${String(p.points??"").padEnd(6)} | ${String(p.adj??"").padEnd(4)} | ${String(p.next_handicap??"").padEnd(8)} | ${String(p.total??"").padEnd(5)}\n`;
  });
  document.getElementById("output").textContent = text;
  document.getElementById("roundInfo").textContent = "Round " + currentRound + " of " + maxRounds;
}

// === Handicap adjustment ===
function adjFromPoints(pts) {
  if (pts >= 43) return -3;
  if (pts >= 38) return -2;
  if (pts >= 31) return -1;
  if (pts >= 26) return 0;
  if (pts >= 21) return 1;
  if (pts >= 16) return 2;
  return 3;
}

// === Calculate ===
async function calculate() {
  if (!unlocked) return alert("Unlock first.");

  // Input loop
  for (const p of players) {
    const pts = parseInt(prompt("Enter points for " + p.player + ":", p.points ?? "")) || 0;
    const adj = adjFromPoints(pts);
    const topScore = Math.max(...players.map(x => x.points ?? pts));
    const topAdj = pts === topScore ? adj - 1 : adj;

    p.points = pts;
    p.adj = topAdj;
    p.next_handicap = Math.max(0, Math.round((p.handicap ?? 0) + topAdj));
    p.round = currentRound;
    p.updated_at = new Date().toISOString();
    await supabase.from("scores").upsert(p);
  }
  alert("Round calculated and saved.");
  loadPlayers();
}

// === Next Round ===
async function nextRound() {
  if (currentRound >= maxRounds) return alert("League complete.");
  currentRound++;
  for (const p of players) {
    p.handicap = p.next_handicap ?? p.handicap;
    p.points = null;
    p.adj = null;
    await supabase.from("scores").update({handicap:p.handicap,round:currentRound}).eq("id",p.id);
  }
  unlocked = false;
  loadPlayers();
}

// === Previous Round ===
function prevRound() {
  if (currentRound > 1) currentRound--;
  display();
}

// === Unlock / Lock ===
function unlock() {
  const val = document.getElementById("pw").value;
  if (val === PASSWORD) { unlocked = true; alert("Unlocked."); }
  else alert("Wrong password.");
}
function lock() { unlocked = false; alert("Locked."); }

// === Add Player ===
async function addPlayer() {
  const name = prompt("Enter new player name:");
  if (!name) return;
  await supabase.from("scores").insert([{player:name,handicap:0,points:null,adj:null,next_handicap:0,total:0,round:currentRound}]);
  loadPlayers();
}

// === Reset ===
async function resetLeague() {
  const pw = prompt("Enter password to confirm reset:");
  if (pw !== PASSWORD) return alert("Wrong password.");
  await supabase.from("scores").delete().neq("id",0);
  currentRound = 1;
  loadPlayers();
}

// === Init ===
loadPlayers();
</script>
</body>
</html>
