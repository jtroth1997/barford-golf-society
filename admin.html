<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --green: #005a2b;
  --gold: #d4af37;
  --light-bg: #f7f7f5;
  --white: #fff;
}
body {
  font-family: "Inter", sans-serif;
  margin: 0;
  background: var(--light-bg);
  color: #1b1b1b;
}
header {
  background: var(--green);
  color: var(--gold);
  text-align: center;
  padding: 20px;
  font-size: 1.8rem;
  font-weight: 700;
}
.container {
  max-width: 1100px;
  margin: 30px auto;
  background: var(--white);
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.hidden { display: none; }
button {
  background: var(--green);
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s;
}
button:hover { background: #0a6b34; }
button.secondary {
  background: var(--gold);
  color: #000;
}
nav.admin-nav {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
  margin-bottom: 20px;
}
nav.admin-nav button {
  background: #eee;
  color: #000;
}
nav.admin-nav button.active {
  background: var(--green);
  color: var(--gold);
}
#toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--green);
  color: var(--gold);
  padding: 10px 20px;
  border-radius: 8px;
  opacity: 0;
  transition: opacity 0.4s;
}
.section {
  display: none;
}
.section.active {
  display: block;
}
input[type=password] {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
h2 {
  color: var(--green);
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #eee;
  text-align: left;
}
th {
  background: var(--green);
  color: var(--gold);
}
</style>
</head>
<body>
<header>üèåÔ∏è Barford Golf Society ‚Äì Admin Portal</header>

<div class="container" id="loginContainer">
  <h2>Admin Access</h2>
  <p>Please enter the admin password to access management tools.</p>
  <input type="password" id="adminPassword" placeholder="Enter password" />
  <button id="loginBtn">Unlock Admin</button>
</div>

<div class="container hidden" id="adminContainer">
  <h2>Admin Dashboard</h2>
  <nav class="admin-nav">
    <button id="rsvpTabBtn" class="active">üìã RSVP Manager</button>
    <button id="teeTimeTabBtn">‚õ≥ Tee Time Organiser</button>
  </nav>

  <!-- RSVP Manager Section -->
  <section id="rsvpSection" class="section active">
    <h3>RSVP Manager</h3>
    <p>Select an event below to view or edit RSVPs.</p>
    <select id="rsvpEventSelect">
      <option value="">Select Event</option>
    </select>
    <div id="rsvpTableContainer"></div>
  </section>

  <!-- Tee Time Organiser Section -->
  <section id="teeTimeSection" class="section">
    <div id="teeTimeLogin">
      <h3>‚õ≥ Tee Time Organiser (Restricted)</h3>
      <p>Enter secondary password to access tee time tools.</p>
      <input type="password" id="teePw" placeholder="Enter Tee Time Password" />
      <button id="teeUnlockBtn">Unlock</button>
    </div>

    <div id="teeTools" class="hidden">
      <h3>Generate Tee Times</h3>
      <p>Select an event to organise tee times.</p>
      <select id="teeEventSelect">
        <option value="">Select Event</option>
      </select>
      <button id="generateBtn">Generate Tee Times</button>
      <button id="saveBtn" class="secondary hidden">Save to Supabase</button>
      <div id="teeOutput"></div>
    </div>
  </section>
</div>

<div id="toast"></div>

<script>
/* =========================
   SUPABASE SETUP
   ========================= */
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   TOAST POPUP
   ========================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.opacity = 1;
  setTimeout(() => t.style.opacity = 0, 2500);
}

/* =========================
   LOGIN
   ========================= */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const pw = document.getElementById("adminPassword").value.trim();
  if (pw === "westbrom1997") {
    document.getElementById("loginContainer").classList.add("hidden");
    document.getElementById("adminContainer").classList.remove("hidden");
    showToast("‚úÖ Admin access granted");
    await loadEvents();
  } else alert("Incorrect password");
});

/* =========================
   TAB SWITCHING
   ========================= */
document.getElementById("rsvpTabBtn").addEventListener("click", () => setActiveTab("rsvp"));
document.getElementById("teeTimeTabBtn").addEventListener("click", () => setActiveTab("teeTime"));
function setActiveTab(tab) {
  document.getElementById("rsvpSection").classList.toggle("active", tab === "rsvp");
  document.getElementById("teeTimeSection").classList.toggle("active", tab === "teeTime");
  document.getElementById("rsvpTabBtn").classList.toggle("active", tab === "rsvp");
  document.getElementById("teeTimeTabBtn").classList.toggle("active", tab === "teeTime");
}

/* =========================
   LOAD EVENTS
   ========================= */
async function loadEvents() {
  const { data, error } = await supabase.from("events").select("id, name, date").order("date", { ascending: true });
  if (error) { console.error(error); return alert("Error loading events"); }

  const rsvpSelect = document.getElementById("rsvpEventSelect");
  const teeSelect = document.getElementById("teeEventSelect");
  [rsvpSelect, teeSelect].forEach(sel => {
    sel.innerHTML = '<option value="">Select Event</option>' +
      data.map(ev => `<option value="${ev.id}">${ev.name} ‚Äî ${ev.date}</option>`).join('');
  });

  rsvpSelect.addEventListener("change", () => loadRSVPs(rsvpSelect.value));
}

/* =========================
   RSVP MANAGER
   ========================= */
async function loadRSVPs(eventId) {
  if (!eventId) return;
  const container = document.getElementById("rsvpTableContainer");
  container.innerHTML = "<p>Loading RSVPs...</p>";

  const { data, error } = await supabase
    .from("rsvps")
    .select("*")
    .eq("event_id", eventId)
    .order("name", { ascending: true });

  if (error) {
    console.error(error);
    container.innerHTML = "<p style='color:red'>Error fetching RSVPs.</p>";
    return;
  }
  if (!data.length) {
    container.innerHTML = "<p>No RSVPs yet for this event.</p>";
    return;
  }

  let html = `<table><thead><tr>
    <th>Name</th><th>Phone</th><th>Buggy</th><th>Flexibility</th><th>Attending</th>
  </tr></thead><tbody>`;
  data.forEach(r => {
    html += `<tr>
      <td>${r.name}</td>
      <td>${r.phone || ""}</td>
      <td>${r.buggy}</td>
      <td>${r.flexibility || ""}</td>
      <td>
        <input type="checkbox" ${r.attending ? "checked" : ""} onchange="toggleAttend(${r.id}, this.checked)">
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  container.innerHTML = html;
}

// Toggle attendance status
async function toggleAttend(id, attending) {
  const { error } = await supabase.from("rsvps").update({ attending }).eq("id", id);
  if (error) showToast("‚ö†Ô∏è Error updating attendance");
  else showToast("‚úÖ RSVP updated");
}

/* =========================
   TEE TIME PASSWORD
   ========================= */
document.getElementById("teeUnlockBtn").addEventListener("click", async () => {
  const pw = document.getElementById("teePw").value.trim();
  if (pw === "oxford1") {
    document.getElementById("teeTimeLogin").classList.add("hidden");
    document.getElementById("teeTools").classList.remove("hidden");
    showToast("‚úÖ Tee Time tools unlocked");
  } else alert("Incorrect Tee Time password");
});

/* =========================
   TEE TIME GENERATION
   ========================= */
document.getElementById("generateBtn").addEventListener("click", async () => {
  const eventId = document.getElementById("teeEventSelect").value;
  if (!eventId) return alert("Select an event first");

  const { data, error } = await supabase
    .from("rsvps")
    .select("*")
    .eq("event_id", eventId)
    .eq("attending", true);
  console.log("RSVP data:", data);


  if (error || !data.length) {
    console.error(error);
    return alert("Error fetching RSVPs for tee time generation");
  }

  const buggy = data.filter(p => p.buggy === "Yes");
  const walkers = data.filter(p => p.buggy !== "Yes");
  const pairs = [];
  const unpaired = [];

  for (let i = 0; i < buggy.length; i += 2) {
    if (buggy[i + 1]) pairs.push([buggy[i], buggy[i + 1]]);
    else unpaired.push(buggy[i]);
  }

  let allPlayers = [...pairs, ...unpaired.map(u => [u]), ...chunkArray(walkers, 4)];

  const output = document.getElementById("teeOutput");
  let html = "<h4>Proposed Tee Times</h4>";
  let teeTime = 9 * 60;
  const groupList = [];

  allPlayers.forEach((group, idx) => {
    const hh = Math.floor(teeTime / 60);
    const mm = teeTime % 60;
    const tStr = `${hh.toString().padStart(2, "0")}:${mm.toString().padStart(2, "0")}`;
    html += `<h5>Group ${idx + 1} ‚Äî ${tStr}</h5><ul>`;
    group.forEach(p => {
  let phoneDisplay = "";
  if (p.buggy === "Yes" && p.phone && p.phone.trim() !== "") {
    phoneDisplay = ` (${p.phone})`;
  } else if (p.buggy === "Yes") {
    phoneDisplay = " (No phone)";
  }
  html += `<li>${p.name}${phoneDisplay}</li>`;
});

    html += "</ul>";
    groupList.push({ event_id: eventId, group_number: idx + 1, tee_time: tStr, players: group.map(p => p.name) });
    teeTime += 8;
  });

  output.innerHTML = html;
  document.getElementById("saveBtn").classList.remove("hidden");
  document.getElementById("saveBtn").onclick = () => saveTeeTimes(groupList);
});

function chunkArray(arr, size) {
  const res = [];
  for (let i = 0; i < arr.length; i += size) res.push(arr.slice(i, i + size));
  return res;
}

/* =========================
   SAVE TEE TIMES
   ========================= */
async function saveTeeTimes(groups) {
  const { error } = await supabase.from("tee_times").insert(groups);
  if (error) showToast("‚ö†Ô∏è Error saving tee times");
  else showToast("‚úÖ Tee times saved to Supabase!");
}
</script>
</body>
</html>
