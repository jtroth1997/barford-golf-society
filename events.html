<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- SortableJS for drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
:root{
  --green:#005a2b;
  --gold:#d4af37;
  --light-bg:#f7f7f5;
  --card:#fff;
}
body{
  font-family:"Inter",sans-serif;
  margin:0;
  background:var(--light-bg);
  color:#1b1b1b;
}
header,footer{
  background:var(--green);
  color:#fff;
  padding:15px 0;
}
.header-container{
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1100px;
  margin:0 auto;
  padding:0 20px;
}
.site-title{color:var(--gold);}
.site-nav ul{
  list-style:none;
  display:flex;
  gap:20px;
  margin:0;
  padding:0;
}
.site-nav a{
  color:#fff;
  text-decoration:none;
  font-weight:600;
}
.site-nav a:hover,.active{color:var(--gold);}
.container{
  max-width:1100px;
  margin:40px auto;
  padding:0 20px;
}
.event-card{
  background:var(--card);
  padding:20px;
  border-radius:10px;
  margin-bottom:25px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.event-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:10px;
}
.event-name{
  color:var(--green);
  font-size:1.4rem;
  font-weight:700;
}
.event-image{
  width:100%;
  max-height:350px;
  object-fit:cover;
  border-radius:10px;
  margin-top:10px;
}
.event-links{margin-top:10px;}
.event-links a{
  margin-right:10px;
  color:var(--green);
  font-weight:600;
  text-decoration:none;
}
.event-links a:hover{text-decoration:underline;}
.event-description{
  margin-top:10px;
  white-space:pre-line;
}
.rsvp-form{
  margin-top:15px;
  border-top:1px solid #ccc;
  padding-top:15px;
}
label{
  display:block;
  margin-top:8px;
  font-weight:600;
}
select,
input[type="text"],
input[type="date"],
input[type="number"],
textarea,
button{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  font-family:inherit;
}
button{
  background:var(--green);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  margin-top:10px;
}
button:hover{background:#0a6b34;}
.hidden{display:none;}
.notice{
  background:#ffeecc;
  color:#333;
  padding:10px;
  border-radius:6px;
  margin:10px 0;
  font-size:0.95rem;
}
footer{
  text-align:center;
  color:var(--gold);
  border-top:4px solid var(--gold);
  margin-top:40px;
  padding:20px;
}
.admin-panel{
  background:#fff;
  border:2px solid var(--gold);
  border-radius:10px;
  padding:20px;
  margin-bottom:30px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.admin-panel h3{color:var(--green);}
input[type="file"]{margin-top:5px;}
img.preview{
  margin-top:10px;
  max-width:200px;
  border-radius:8px;
}

/* Tee times display */
.tee-times{
  margin-top:20px;
  padding-top:10px;
  border-top:2px solid #eee;
}
.group{
  background:#f9f9f9;
  margin:10px 0;
  padding:10px;
  border-radius:8px;
}
.group strong{color:var(--green);}
.phone{
  font-size:0.9rem;
  color:#666;
}

/* Tee time generator cards */
#teeTimeList{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.tee-card{
  background:#fff;
  border:1px solid #ddd;
  border-radius:10px;
  padding:10px 12px;
  box-shadow:0 2px 4px rgba(0,0,0,0.08);
  cursor:move;
}
.tee-card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.tee-card-header span{
  font-size:0.9rem;
  color:#555;
}
.tee-card ul{
  margin:0;
  padding-left:18px;
}
.tee-player{
  list-style:none;
  padding:2px 0;
}
.tee-player-buggy{
  color:#8a6200;
}
.tee-player-walker{
  color:#005a2b;
}
@media (max-width:700px){
  .event-header{
    flex-direction:column;
    align-items:flex-start;
  }
}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="#" class="active">Events</a></li>
        <li><a href="#" onclick="showAdminLogin()">Admin Login</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="admin-panel hidden">
    <h3>Admin Control Panel</h3>

    <!-- ADD EVENT -->
    <form id="eventForm" onsubmit="submitEvent(event)">
      <h4>Add New Event</h4>
      <label>Event Title</label>
      <input type="text" id="title" required>

      <label>Location</label>
      <input type="text" id="location" required>

      <label>Date</label>
      <input type="date" id="date" required>

      <label>Price (¬£)</label>
      <input type="number" id="price" required>

      <label>Description</label>
      <textarea id="description" placeholder="Event details..."></textarea>

      <label>Course Website Link</label>
      <input type="text" id="course_link" placeholder="https://">

      <label>Upload Image</label>
      <input type="file" id="image" accept="image/*" onchange="previewImage(event)">
      <img id="preview" class="preview hidden" alt="Preview"/>

      <button type="submit">Save Event</button>
      <div id="message"></div>
    </form>

    <!-- TEE TIME GENERATOR -->
    <div id="teeTimeGenerator" style="margin-top:40px;">
      <h4>üïì Organise Tee Times & Groups</h4>
      <p>Generate random groups and tee times once RSVPs are finalised. Drag cards to reorder before saving.</p>

      <label>Select Event</label>
      <select id="teeEventSelect" style="width:100%;max-width:400px;padding:8px;border-radius:6px;border:1px solid #ccc;">
        <option value="">Loading events...</option>
      </select>

      <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:15px;align-items:center;">
        <div>
          <label>Starting Tee Time</label>
          <input type="text" id="startTime" placeholder="e.g. 9:00am" style="width:150px;">
        </div>
        <div>
          <label>Gap (mins)</label>
          <input type="number" id="gapMins" value="7" style="width:80px;">
        </div>
      </div>

      <div style="margin-top:15px;">
        <button type="button" onclick="generateTeeTimes()">Generate Tee Times</button>
        <button type="button" onclick="saveTeeTimes()" style="background:#d4af37;margin-left:10px;">Save Tee Times</button>
      </div>

      <div id="teeTimeOutput" style="margin-top:20px;">
        <p><em>No tee times generated yet.</em></p>
      </div>
    </div>
  </div>

  <!-- PUBLIC EVENTS -->
  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const ADMIN_PASSWORD = "westbrom1997"; // 
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// globals for tee time generator
let currentTeeEventId = null;
let currentStartTime = null;
let currentGap = 7;
let currentRsvpLookup = {};

// --- Admin login ---
function showAdminLogin(){
  const pass = prompt("Enter admin password:");
  if(pass === ADMIN_PASSWORD){
    localStorage.setItem("isAdmin", "true");
    document.getElementById("adminPanel").classList.remove("hidden");
    alert("‚úÖ Admin access granted");
  } else {
    alert("‚ùå Incorrect password");
  }
}

window.onload = () => {
  if(localStorage.getItem("isAdmin") === "true"){
    document.getElementById("adminPanel").classList.remove("hidden");
  }
  loadEvents();
  loadTeeTimeEvents();
};

// --- Admin: Add Event ---
function previewImage(e){
  const file = e.target.files[0];
  const preview = document.getElementById("preview");
  if(file){
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
  }
}

function generateWeatherLink(location, date){
  if(!location || !date) return "";
  const cleanLocation = encodeURIComponent(location.trim());
  return `https://www.bbc.co.uk/weather/search?q=${cleanLocation}#${date}`;
}

async function submitEvent(e){
  e.preventDefault();
  const title = document.getElementById("title").value.trim();
  const location = document.getElementById("location").value.trim();
  const date = document.getElementById("date").value;
  const price = document.getElementById("price").value.trim();
  const description = document.getElementById("description").value.trim();
  const course_link = document.getElementById("course_link").value.trim();
  const file = document.getElementById("image").files[0];
  const message = document.getElementById("message");
  message.innerHTML = "";

  let image_url = null;
  if(file){
    const fileName = `${Date.now()}_${file.name}`;
    const { data, error: uploadError } = await supabase.storage.from("event-images").upload(fileName, file);
    if(uploadError){ message.innerHTML = "<div class='error'>Image upload failed.</div>"; return; }
    const { data: publicURLData } = supabase.storage.from("event-images").getPublicUrl(fileName);
    image_url = publicURLData.publicUrl;
  }

  const weather_link = generateWeatherLink(location, date);
  const { error } = await supabase.from("events").insert([{
    name: title, location, date, price, description, course_link, image_url, weather_link
  }]);

  if(error){ console.error(error); message.innerHTML = "<div class='error'>Error saving event.</div>"; return; }

  message.innerHTML = "<div class='notice'>‚úÖ Event added successfully!</div>";
  document.getElementById("eventForm").reset();
  document.getElementById("preview").classList.add("hidden");
  loadEvents();
  loadTeeTimeEvents();
}

// --- Load events for public + RSVP ---
async function loadEvents(){
  const { data: events, error } = await supabase.from("events").select("*").order("date",{ascending:true});
  const container = document.getElementById("eventList");
  if(error || !events?.length){
    container.innerHTML = "<p>No events found.</p>";
    return;
  }

  container.innerHTML = "";
  for(const ev of events){
    const card = document.createElement("div");
    card.className = "event-card";

    const imgHTML = ev.image_url ? `<img src="${ev.image_url}" class="event-image">` : "";
    const descHTML = ev.description ? `<div class="event-description">${ev.description}</div>` : "";
    const linksHTML = `
      <div class="event-links">
        ${ev.course_link ? `<a href="${ev.course_link}" target="_blank">üåê Course Website</a>` : ""}
        ${ev.weather_link ? `<a href="${ev.weather_link}" target="_blank">‚òÄÔ∏è BBC Weather</a>` : ""}
      </div>`;

    card.innerHTML = `
      <div class="event-header">
        <div>
          <div class="event-name">${ev.name}</div>
          <div>${ev.location} ‚Äî ${ev.date}</div>
        </div>
        <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
      </div>
      ${imgHTML}
      ${descHTML}
      ${linksHTML}

      <form class="rsvp-form" onsubmit="submitRSVP(event, '${ev.id}')">
        <h4>RSVP for this Event</h4>
        <label>Full Name</label>
        <input type="text" id="name_${ev.id}" placeholder="Your name" required>

        <label>Email (optional)</label>
        <input type="text" id="email_${ev.id}" placeholder="Your email">

        <label>Would you like to use a buggy?</label>
        <select id="buggy_${ev.id}" onchange="togglePhoneRequirement('${ev.id}')">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>

        <label>If there‚Äôs an odd number of buggy requests, are you willing to walk instead?</label>
        <select id="flex_${ev.id}">
          <option value="Yes, happy to walk if needed">Yes, I‚Äôm happy to walk</option>
          <option value="No, need buggy">No, I need a buggy</option>
        </select>

        <label id="phoneLabel_${ev.id}" class="hidden">Phone (required for buggy pairing)</label>
        <input type="text" id="phone_${ev.id}" placeholder="Your phone number" class="hidden">

        <label>Need a specific tee time? (optional)</label>
        <input type="text" id="tee_pref_${ev.id}" placeholder="e.g. early, after 11am">

        <label>Will you be attending?</label>
        <select id="attending_${ev.id}">
          <option value="true">Yes, I‚Äôll be playing</option>
          <option value="false">No, I can‚Äôt attend</option>
        </select>

        <small>If you request a buggy, please include your phone number so your potential partner can contact you directly to arrange booking.</small>

        <button type="submit">Submit RSVP</button>
      </form>

      <div class="tee-times" id="tee_${ev.id}">
        <em>Tee times will appear here once published.</em>
      </div>
    `;

    container.appendChild(card);
    loadTeeTimes(ev.id);
  }
}

// toggle phone requirement if buggy selected
function togglePhoneRequirement(eventId){
  const buggySelect = document.getElementById(`buggy_${eventId}`);
  const phoneField = document.getElementById(`phone_${eventId}`);
  const phoneLabel = document.getElementById(`phoneLabel_${eventId}`);
  if(buggySelect.value === "true"){
    phoneField.classList.remove("hidden");
    phoneLabel.classList.remove("hidden");
    phoneField.required = true;
  } else {
    phoneField.classList.add("hidden");
    phoneLabel.classList.add("hidden");
    phoneField.required = false;
  }
}

// Save RSVP
async function submitRSVP(e, eventId){
  e.preventDefault();
  const name = document.getElementById(`name_${eventId}`).value.trim();
  const email = document.getElementById(`email_${eventId}`).value.trim();
  const phone = document.getElementById(`phone_${eventId}`).value.trim();
  const tee_pref = document.getElementById(`tee_pref_${eventId}`).value.trim();
  const attending = document.getElementById(`attending_${eventId}`).value === "true";
  const buggy = document.getElementById(`buggy_${eventId}`).value === "true";
  const flexibility = document.getElementById(`flex_${eventId}`).value;

  if(!name){ alert("Please enter your name."); return; }
  if(buggy && !phone){ alert("Please enter your phone number if you require a buggy."); return; }

  const { error } = await supabase.from("rsvps").upsert({
    event_id: eventId,
    name,
    email,
    phone,
    attending,
    buggy,
    flexibility,
    tee_pref
  }, { onConflict: ['event_id','name'] });

  if(error){ console.error(error); alert("Error saving RSVP."); return; }

  alert("‚úÖ RSVP saved successfully!");
  loadTeeTimes(eventId); // refresh tee times in case admin already generated
}

// Load tee times for a given event (public view)
async function loadTeeTimes(eventId){
  const container = document.getElementById(`tee_${eventId}`);
  if(!container) return;

  const { data: tees, error } = await supabase
    .from("tee_times")
    .select("*")
    .eq("event_id", eventId)
    .order("group_number",{ascending:true});

  if(error){
    console.error(error);
    container.innerHTML = "Error loading tee times.";
    return;
  }
  if(!tees || !tees.length){
    container.innerHTML = "<em>Tee times will appear here once published.</em>";
    return;
  }

  const { data: rsvps } = await supabase
    .from("rsvps")
    .select("name,buggy,phone")
    .eq("event_id", eventId)
    .eq("attending", true);

  const lookup = {};
  rsvps?.forEach(r=>{
    lookup[r.name.trim().toLowerCase()] = r;
  });

  let html = "<h4>Tee Times</h4>";
  tees.forEach(g=>{
    html += `<div class="group"><strong>Group ${g.group_number} ‚Äî ${g.tee_time}</strong><ul>`;
    g.players.forEach(name=>{
      const r = lookup[name.trim().toLowerCase()];
      const icon = r?.buggy ? "üõ∫" : "üö∂";
      const phone = r?.phone ? ` <span class="phone">(${r.phone})</span>` : "";
      html += `<li>${icon} ${name}${phone}</li>`;
    });
    html += "</ul></div>`;
  });

  container.innerHTML = html;
}

// realtime tee_time updates
supabase.channel('tee_times_changes')
  .on('postgres_changes', { event:'*', schema:'public', table:'tee_times' }, payload => {
    if(payload.new?.event_id){ loadTeeTimes(payload.new.event_id); }
  })
  .subscribe();

// ================= TEE TIME GENERATOR (ADMIN) =================

// load events into dropdown
async function loadTeeTimeEvents(){
  const { data: events, error } = await supabase.from("events").select("id,name,date").order("date",{ascending:true});
  const select = document.getElementById("teeEventSelect");
  if(!select) return;
  if(error || !events?.length){
    select.innerHTML = "<option value=''>No events found</option>";
    return;
  }
  select.innerHTML = events.map(ev => `<option value="${ev.id}">${ev.name} (${ev.date})</option>`).join("");
}

// helper: add minutes to a 12-hour time string
function addMinutesToTime(start, minsToAdd){
  let lower = start.toLowerCase().replace(/\s+/g,'');
  let mer = lower.endsWith("am") ? "am" : lower.endsWith("pm") ? "pm" : null;
  if(!mer) return start; // fallback
  let time = lower.replace(/(am|pm)/,'');
  let [hStr,mStr] = time.split(":");
  let h = parseInt(hStr,10);
  let m = parseInt(mStr || "0",10);
  if(mer==="pm" && h<12) h+=12;
  if(mer==="am" && h===12) h=0;

  const date = new Date();
  date.setHours(h);
  date.setMinutes(m + minsToAdd);

  const hr = date.getHours();
  const min = date.getMinutes().toString().padStart(2,"0");
  const suffix = hr>=12 ? "pm" : "am";
  const displayHr = ((hr+11)%12)+1;
  return `${displayHr}:${min}${suffix}`;
}

// shuffle helper
function shuffleArray(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

// generate tee times using buggy logic
async function generateTeeTimes(){
  const eventId = document.getElementById("teeEventSelect").value;
  const startTime = document.getElementById("startTime").value.trim();
  const gap = parseInt(document.getElementById("gapMins").value,10) || 7;
  const output = document.getElementById("teeTimeOutput");

  if(!eventId || !startTime){
    alert("Please select an event and enter a starting time.");
    return;
  }

  const { data: rsvps, error } = await supabase
    .from("rsvps")
    .select("name,buggy,flexibility")
    .eq("event_id", eventId)
    .eq("attending", true);

  if(error || !rsvps?.length){
    output.innerHTML = "<p>No RSVPs found for this event.</p>";
    return;
  }

  // build lookup for icons later
  currentRsvpLookup = {};
  rsvps.forEach(r=>{
    currentRsvpLookup[r.name.trim().toLowerCase()] = r;
  });

  // separate buggy players and walkers
  let buggyPlayers = rsvps.filter(r=>r.buggy);
  const flexibleBuggy = buggyPlayers.filter(r=> (r.flexibility||"").toLowerCase().includes("happy"));
  const mustBuggy = buggyPlayers.filter(r=> !((r.flexibility||"").toLowerCase().includes("happy")));
  buggyPlayers = [...mustBuggy, ...flexibleBuggy];

  let walkers = rsvps.filter(r=>!r.buggy);

  // if odd buggy count, move one flexible buggy to walkers
  if(buggyPlayers.length % 2 !== 0 && flexibleBuggy.length > 0){
    const move = flexibleBuggy[0];
    walkers.push(move);
    buggyPlayers = buggyPlayers.filter(r=>r.name !== move.name);
  }

  buggyPlayers = shuffleArray(buggyPlayers);
  walkers = shuffleArray(walkers);

  // create buggy groups (2 buggies = 4 players)
  const buggyGroups = [];
  for(let i=0;i<buggyPlayers.length;i+=4){
    buggyGroups.push(buggyPlayers.slice(i,i+4));
  }

  // walker groups: first may be 3-ball if needed
  const walkerGroups = [];
  let idx = 0;
  if(walkers.length % 4 === 3){
    walkerGroups.push(walkers.slice(0,3));
    idx = 3;
  }
  for(; idx<walkers.length; idx+=4){
    walkerGroups.push(walkers.slice(idx,idx+4));
  }

  const groups = [...buggyGroups, ...walkerGroups].filter(g=>g.length);

  currentTeeEventId = eventId;
  currentStartTime = startTime;
  currentGap = gap;

  const teeData = groups.map((group,i)=>({
    group_number: i+1,
    tee_time: addMinutesToTime(startTime, i*gap),
    players: group.map(p=>p.name)
  }));

  renderTeeTimeCards(teeData);
}

// render draggable cards
function renderTeeTimeCards(data){
  const container = document.getElementById("teeTimeOutput");
  container.innerHTML = "";
  const list = document.createElement("div");
  list.id = "teeTimeList";
  container.appendChild(list);

  data.forEach(g=>{
    const card = document.createElement("div");
    card.className = "tee-card";

    const header = document.createElement("div");
    header.className = "tee-card-header";
    header.innerHTML = `<div><strong>Group ${g.group_number}</strong> ‚Äî ${g.tee_time}</div><span>Drag to reorder</span>`;
    card.appendChild(header);

    const ul = document.createElement("ul");
    g.players.forEach(name=>{
      const r = currentRsvpLookup[name.trim().toLowerCase()];
      const isBuggy = r?.buggy;
      const li = document.createElement("li");
      li.className = "tee-player " + (isBuggy ? "tee-player-buggy" : "tee-player-walker");
      li.dataset.name = name;
      li.textContent = `${isBuggy ? "üõ∫" : "üö∂"} ${name}`;
      ul.appendChild(li);
    });
    card.appendChild(ul);

    list.appendChild(card);
  });

  new Sortable(list,{animation:150});
}

// save tee times into Supabase
async function saveTeeTimes(){
  const list = document.getElementById("teeTimeList");
  if(!currentTeeEventId || !list){
    alert("No tee times to save.");
    return;
  }
  const gap = currentGap || 7;
  const start = currentStartTime;

  const cards = Array.from(list.children);
  const groups = cards.map((card,idx)=>{
    const names = Array.from(card.querySelectorAll(".tee-player")).map(li=>li.dataset.name);
    return {
      group_number: idx+1,
      tee_time: addMinutesToTime(start, idx*gap),
      players: names
    };
  });

  // delete old tee times for this event
  await supabase.from("tee_times").delete().eq("event_id", currentTeeEventId);

  const { error } = await supabase.from("tee_times").insert(
    groups.map(g=>({
      event_id: parseInt(currentTeeEventId),
      group_number: g.group_number,
      tee_time: g.tee_time,
      players: g.players
    }))
  );

  if(error){
    console.error(error);
    alert("Error saving tee times.");
    return;
  }

  alert("‚úÖ Tee times saved successfully!");
  loadTeeTimes(currentTeeEventId); // refresh public display
}
</script>
</body>
</html>
