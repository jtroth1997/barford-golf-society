<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barford Golf Society | Events</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --green:#005a2b;
      --gold:#d4af37;
      --light-bg:#f7f7f5;
      --card:#fff;
    }
    body {font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
    header,footer{background:var(--green);color:#fff;padding:15px 0;}
    .header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
    .site-title{color:var(--gold);font-size:1.5rem;font-weight:700;}
    .site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
    .site-nav a{color:#fff;text-decoration:none;font-weight:600;}
    .site-nav a:hover{color:var(--gold);}
    .container{max-width:1100px;margin:40px auto;padding:0 20px;}
    .event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
    .event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
    .event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
    .event-image{width:100%;max-height:350px;object-fit:cover;border-radius:10px;margin-top:10px;}
    .event-links{margin-top:10px;}
    .event-links a{margin-right:10px;color:var(--green);font-weight:600;text-decoration:none;}
    .event-links a:hover{text-decoration:underline;}
    footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}

    .admin-btn{display:inline-block;background:var(--gold);color:#1b1b1b;font-weight:600;padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin-bottom:25px;}
    .admin-btn:hover{background:#e0c35a;}
    .admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
    .admin-panel h3{color:var(--green);}
    .hidden{display:none;}
  </style>
</head>

<body>
  <header>
    <div class="header-container">
      <div class="site-title">Barford Golf Society</div>
      <nav class="site-nav">
        <ul>
          <li><a href="#" class="active">Events</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Admin Access Button -->
    <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel hidden">
      <h3>Admin Control Panel</h3>
      <label>Select Event</label>
      <select id="eventSelect" style="width:100%;max-width:400px;"></select>

      <div id="playerPool" style="margin-top:10px;"><em>Players will load once you select an event...</em></div>
      <div id="teeGroups" style="margin-top:20px;"></div>
    </div>

    <!-- Event List -->
    <div id="eventList"></div>
  </main>

  <footer>
    <p>¬© 2025 Barford Golf Society</p>
  </footer>

  <!-- JS logic -->
  <script>
    const ADMIN_PASSWORD = "westbrom1997";
    const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = () => {
      if (localStorage.getItem("isAdmin") === "true") {
        document.getElementById("adminPanel").classList.remove("hidden");
        document.getElementById("adminToggle").textContent = "‚¨ÖÔ∏è Back to Events";
        loadAdminEvents();
      }
      loadEvents();
    };

    // =========================
    // ADMIN ACCESS
    // =========================
    function toggleAdminAccess() {
      const panel = document.getElementById("adminPanel");
      const btn = document.getElementById("adminToggle");
      const isAdmin = localStorage.getItem("isAdmin") === "true";

      if (!isAdmin) {
        const pass = prompt("Enter admin password:");
        if (pass === ADMIN_PASSWORD) {
          localStorage.setItem("isAdmin", "true");
          panel.classList.remove("hidden");
          btn.textContent = "‚¨ÖÔ∏è Back to Events";
          loadAdminEvents();
          alert("‚úÖ Admin access granted");
        } else alert("‚ùå Incorrect password");
      } else {
        localStorage.removeItem("isAdmin");
        panel.classList.add("hidden");
        btn.textContent = "üîê Admin Access";
      }
    }

    // =========================
    // LOAD EVENTS (Public)
    // =========================
    async function loadEvents() {
      const { data: events, error } = await supabase
        .from("events")
        .select("*")
        .order("date", { ascending: true });
      const container = document.getElementById("eventList");

      if (error || !events?.length) {
        container.innerHTML = "<p>No events found.</p>";
        return;
      }

      container.innerHTML = "";
      for (const ev of events) {
        const img = ev.image_url ? `<img src="${ev.image_url}" class="event-image">` : "";
        const desc = ev.description ? `<div class='event-description'>${ev.description}</div>` : "";
        const links = `<div class="event-links">
          ${ev.course_link ? `<a href="${ev.course_link}" target="_blank">üåê Course Website</a>` : ""}
          ${ev.weather_link ? `<a href="${ev.weather_link}" target="_blank">‚òÄÔ∏è BBC Weather</a>` : ""}
        </div>`;

        container.innerHTML += `
  <div class="event-card">
    <div class="event-header">
      <div><div class="event-name">${ev.name}</div><div>${ev.location} ‚Äî ${ev.date}</div></div>
      <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
    </div>
    ${img}${desc}${links}

    <button class="admin-btn" id="rsvpBtn_${ev.id}" onclick="showRSVPForm(${ev.id})">üìù RSVP to this event</button>
    <div id="rsvpForm_${ev.id}" class="hidden"></div>
  </div>`;
      }
    }

    // =========================
    // LOAD EVENTS (Admin dropdown)
    // =========================
    async function loadAdminEvents() {
      const { data: events, error } = await supabase
        .from("events")
        .select("id,name,date")
        .order("date", { ascending: true });

      const select = document.getElementById("eventSelect");
      if (error || !events?.length) {
        select.innerHTML = "<option>No events found</option>";
        return;
      }

      select.innerHTML = `<option value="">Select Event</option>` + 
        events.map(e => `<option value="${e.id}">${e.name} (${e.date})</option>`).join("");

      select.onchange = () => loadRSVPs(select.value);
    }

    // =========================
    // LOAD RSVPS
    // =========================
    async function loadRSVPs(eventId) {
      const pool = document.getElementById("playerPool");
      pool.innerHTML = "<em>Loading RSVPs...</em>";

      const { data: rsvps, error } = await supabase
        .from("rsvps")
        .select("name, buggy, flexibility, phone, attending")
        .eq("event_id", eventId)
        .eq("attending", true);

      if (error || !rsvps?.length) {
        pool.innerHTML = "<em>No RSVPs found for this event.</em>";
        return;
      }

      let list = `<h4>Players (${rsvps.length})</h4><ul style="list-style:none;padding:0;">`;
      rsvps.forEach(p => {
        list += `<li>${p.buggy ? "üõ∫" : "üö∂"} ${p.name} ${p.phone ? `(${p.phone})` : ""}</li>`;
      });
      list += `</ul><button onclick="generateTeeTimes(${eventId})" class="admin-btn">‚öôÔ∏è Generate Tee Times</button>`;
      pool.innerHTML = list;

      window.currentPlayers = rsvps;
    }

    // =========================
    // GENERATE TEE TIMES
    // =========================
    function generateTeeTimes(eventId) {
      const rsvps = window.currentPlayers || [];
      if (!rsvps.length) {
        alert("No RSVPs loaded!");
        return;
      }

      let buggy = rsvps.filter(p => p.buggy);
      let walkers = rsvps.filter(p => !p.buggy);

      if (buggy.length % 2 !== 0) {
        const flex = buggy.find(p => (p.flexibility || "").toLowerCase().includes("happy"));
        if (flex) {
          walkers.push(flex);
          buggy = buggy.filter(b => b.name !== flex.name);
        }
      }

      const shuffle = (a) => a.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
      buggy = shuffle(buggy);
      walkers = shuffle(walkers);

      const groups = [];
      for (let i = 0; i < buggy.length; i += 4) groups.push(buggy.slice(i, i + 4));
      for (let i = 0; i < walkers.length; i += 4) groups.push(walkers.slice(i, i + 4));

      const area = document.getElementById("teeGroups");
      area.innerHTML = "<h4>Generated Tee Times</h4>";

      groups.forEach((g, i) => {
        const time = `9:${String(i * 7).padStart(2, "0")}am`;
        area.innerHTML += `<div><strong>Group ${i + 1} ‚Äî ${time}</strong><ul style="list-style:none;padding:0;">${g
          .map(p => `<li>${p.buggy ? "üõ∫" : "üö∂"} ${p.name}</li>`)
          .join("")}</ul></div>`;
      });

      area.innerHTML += `<button onclick="saveTeeTimes(${eventId})" class="admin-btn">üíæ Save Tee Times</button>`;
      window.generatedGroups = groups;
    }

    // =========================
    // SAVE TEE TIMES
    // =========================
    async function saveTeeTimes(eventId) {
      const groups = window.generatedGroups || [];
      if (!groups.length) return alert("Generate groups first!");

      const data = groups.map((g, i) => ({
        event_id: eventId,
        group_number: i + 1,
        tee_time: `9:${String(i * 7).padStart(2, "0")}am`,
        players: g.map(p => ({
          name: p.name,
          phone: p.phone,
          type: p.buggy ? "buggy" : "walker",
        })),
      }));

      await supabase.from("tee_times").delete().eq("event_id", eventId);
      const { error } = await supabase.from("tee_times").insert(data);
      if (error) alert("‚ùå Error saving tee times.");
      else alert("‚úÖ Tee times saved successfully!");
    }
    // =========================
// RSVP FORM SYSTEM
// =========================
function showRSVPForm(eventId) {
  const formContainer = document.getElementById(`rsvpForm_${eventId}`);
  const btn = document.getElementById(`rsvpBtn_${eventId}`);

  if (!formContainer.classList.contains("hidden")) {
    formContainer.classList.add("hidden");
    btn.textContent = "üìù RSVP to this event";
    return;
  }

  formContainer.classList.remove("hidden");
  btn.textContent = "‚¨ÜÔ∏è Hide RSVP Form";

  formContainer.innerHTML = `
    <form onsubmit="submitRSVP(event, ${eventId})" class="rsvp-list">
      <label>Name*</label>
      <input type="text" id="name_${eventId}" required>

      <label>Are you playing?*</label>
      <select id="playing_${eventId}" required>
        <option value="">Select</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>

      <label>Do you need a buggy?*</label>
      <select id="buggy_${eventId}" onchange="handleBuggyChange(${eventId})" required>
        <option value="">Select</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>

      <div id="buggyOptions_${eventId}" class="hidden">
        <label>Buggy preference</label>
        <select id="flexibility_${eventId}">
          <option value="need">I need a buggy</option>
          <option value="happy">Happy to walk if odd numbers</option>
        </select>

        <label>Phone number*</label>
        <input type="text" id="phone_${eventId}" placeholder="07123 456789">
        <small>Your phone number will be displayed with your buggy partner so you can contact each other to organise booking.</small>
      </div>

      <label>Preferred Tee Time (optional)</label>
      <select id="preferred_${eventId}">
        <option value="">No preference</option>
        <option value="first">First</option>
        <option value="middle">Middle</option>
        <option value="end">Near the end</option>
      </select>

      <button type="submit" style="margin-top:10px;">Submit RSVP</button>
      <div id="rsvpMsg_${eventId}" style="margin-top:10px;font-weight:600;"></div>
    </form>
  `;
}

function handleBuggyChange(eventId) {
  const val = document.getElementById(`buggy_${eventId}`).value;
  const section = document.getElementById(`buggyOptions_${eventId}`);
  if (val === "yes") section.classList.remove("hidden");
  else section.classList.add("hidden");
}

async function submitRSVP(e, eventId) {
  e.preventDefault();

  const name = document.getElementById(`name_${eventId}`).value.trim();
  const playing = document.getElementById(`playing_${eventId}`).value;
  const buggy = document.getElementById(`buggy_${eventId}`).value;
  const flexibility = buggy === "yes" ? document.getElementById(`flexibility_${eventId}`).value : null;
  const phone = buggy === "yes" ? document.getElementById(`phone_${eventId}`).value.trim() : null;
  const preferred = document.getElementById(`preferred_${eventId}`).value;
  const msg = document.getElementById(`rsvpMsg_${eventId}`);

  if (!name || !playing || !buggy) {
    msg.textContent = "‚ö†Ô∏è Please fill out all required fields.";
    msg.style.color = "red";
    return;
  }

  if (buggy === "yes" && !phone) {
    msg.textContent = "‚ö†Ô∏è Please enter your phone number if you need a buggy.";
    msg.style.color = "red";
    return;
  }

  const attending = playing === "yes";

  const { error } = await supabase.from("rsvps").insert([
    {
      event_id: eventId,
      name,
      attending,
      buggy: buggy === "yes",
      flexibility,
      phone,
      preferred_time: preferred
    }
  ]);

  if (error) {
    msg.textContent = "‚ùå Error saving RSVP. Please try again.";
    msg.style.color = "red";
  } else {
    msg.textContent = "‚úÖ RSVP saved successfully!";
    msg.style.color = "green";
    e.target.reset();
  }
}
  </script>
</body>
</html>
