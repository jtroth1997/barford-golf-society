<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#005a2b;--gold:#d4af37;--light-bg:#f7f7f5;--card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
.event-image{width:100%;max-height:350px;object-fit:cover;border-radius:10px;margin-top:10px;}
.event-links{margin-top:10px;}
.event-links a{margin-right:10px;color:var(--green);font-weight:600;text-decoration:none;}
.event-links a:hover{text-decoration:underline;}
.event-description{margin-top:10px;white-space:pre-line;}
.rsvp-form{margin-top:15px;border-top:1px solid #ccc;padding-top:15px;}
label{display:block;margin-top:8px;font-weight:600;}
select,input[type="text"],input[type="date"],input[type="number"],textarea,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
button{background:var(--green);color:#fff;font-weight:600;cursor:pointer;margin-top:10px;}
button:hover{background:#0a6b34;}
.hidden{display:none;}
.notice{background:#ffeecc;color:#333;padding:10px;border-radius:6px;margin:10px 0;font-size:0.95rem;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
.admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.admin-panel h3{color:var(--green);}
input[type="file"]{margin-top:5px;}
img.preview{margin-top:10px;max-width:200px;border-radius:8px;}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="#" class="active">Events</a></li>
        <li><a href="#" onclick="showAdminLogin()">Admin Login</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="admin-panel hidden">
    <h3>Admin Control Panel</h3>

    <form id="eventForm" onsubmit="submitEvent(event)">
      <h4>Add New Event</h4>
      <label>Event Title</label>
      <input type="text" id="title" required>

      <label>Location</label>
      <input type="text" id="location" required>

      <label>Date</label>
      <input type="date" id="date" required>

      <label>Price (¬£)</label>
      <input type="number" id="price" required>

      <label>Description</label>
      <textarea id="description" placeholder="Event details..."></textarea>

      <label>Course Website Link</label>
      <input type="text" id="course_link" placeholder="https://">

      <label>Upload Image</label>
      <input type="file" id="image" accept="image/*" onchange="previewImage(event)">
      <img id="preview" class="preview hidden" alt="Preview"/>

      <button type="submit">Save Event</button>
      <div id="message"></div>
    </form>

    <div style="margin-top:30px;">
      <h4>üïì Organise Tee Times & Groups</h4>
      <p>This section will let you generate and edit tee times automatically.</p>
      <p><em>We‚Äôll add this next once you confirm your group logic.</em></p>
    </div>
  </div>

  <!-- PUBLIC EVENTS -->
  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const ADMIN_PASSWORD = "Barford2025"; // Change this to your chosen admin password
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- Admin login ---
function showAdminLogin(){
  const pass = prompt("Enter admin password:");
  if(pass === ADMIN_PASSWORD){
    localStorage.setItem("isAdmin", "true");
    document.getElementById("adminPanel").classList.remove("hidden");
    alert("‚úÖ Admin access granted");
  } else {
    alert("‚ùå Incorrect password");
  }
}

window.onload = () => {
  if(localStorage.getItem("isAdmin") === "true"){
    document.getElementById("adminPanel").classList.remove("hidden");
  }
  loadEvents();
};

// --- Admin: Add Event ---
function previewImage(e){
  const file = e.target.files[0];
  const preview = document.getElementById("preview");
  if(file){
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
  }
}

function generateWeatherLink(location, date){
  if(!location || !date) return "";
  const cleanLocation = encodeURIComponent(location.trim());
  return `https://www.bbc.co.uk/weather/search?q=${cleanLocation}#${date}`;
}

async function submitEvent(e){
  e.preventDefault();
  const title = document.getElementById("title").value.trim();
  const location = document.getElementById("location").value.trim();
  const date = document.getElementById("date").value;
  const price = document.getElementById("price").value.trim();
  const description = document.getElementById("description").value.trim();
  const course_link = document.getElementById("course_link").value.trim();
  const file = document.getElementById("image").files[0];
  const message = document.getElementById("message");
  message.innerHTML = "";

  let image_url = null;
  if(file){
    const fileName = `${Date.now()}_${file.name}`;
    const { data, error: uploadError } = await supabase.storage.from("event-images").upload(fileName, file);
    if(uploadError){ message.innerHTML = "<div class='error'>Image upload failed.</div>"; return; }
    const { data: publicURLData } = supabase.storage.from("event-images").getPublicUrl(fileName);
    image_url = publicURLData.publicUrl;
  }

  const weather_link = generateWeatherLink(location, date);
  const { error } = await supabase.from("events").insert([{
    name: title, location, date, price, description, course_link, image_url, weather_link
  }]);

  if(error){ console.error(error); message.innerHTML = "<div class='error'>Error saving event.</div>"; return; }

  message.innerHTML = "<div class='notice'>‚úÖ Event added successfully!</div>";
  document.getElementById("eventForm").reset();
  document.getElementById("preview").classList.add("hidden");
  loadEvents();
}

// --- Public: Load Events ---
async function loadEvents(){
  const { data: events, error } = await supabase.from("events").select("*").order("date", { ascending: true });
  const container = document.getElementById("eventList");
  if(error || !events?.length){ container.innerHTML = "<p>No events found.</p>"; return; }

  container.innerHTML = "";
  for(const ev of events){
    const imgHTML = ev.image_url ? `<img src="${ev.image_url}" class="event-image">` : "";
    const descHTML = ev.description ? `<div class='event-description'>${ev.description}</div>` : "";
    const linksHTML = `
      <div class="event-links">
        ${ev.course_link ? `<a href="${ev.course_link}" target="_blank">üåê Course Website</a>` : ""}
        ${ev.weather_link ? `<a href="${ev.weather_link}" target="_blank">‚òÄÔ∏è BBC Weather</a>` : ""}
      </div>`;
    container.innerHTML += `
      <div class="event-card">
        <div class="event-header">
          <div>
            <div class="event-name">${ev.name}</div>
            <div>${ev.location} ‚Äî ${ev.date}</div>
          </div>
          <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
        </div>
        ${imgHTML}
        ${descHTML}
        ${linksHTML}
      </div>
    `;
  }
}
</script>
</body>
</html>
