<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
:root {
  --green:#005a2b;
  --gold:#d4af37;
  --light-bg:#f7f7f5;
  --card:#fff;
  --cancel:red;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);font-size:1.5rem;font-weight:700;}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{position:relative;background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
.event-image{width:100%;max-height:350px;object-fit:cover;border-radius:10px;margin-top:10px;}
.event-links{margin-top:10px;}
.event-links a{margin-right:10px;color:var(--green);font-weight:600;text-decoration:none;}
.event-links a:hover{text-decoration:underline;}
.event-description{margin-top:10px;white-space:pre-line;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}

.admin-btn{display:inline-block;background:var(--gold);color:#1b1b1b;font-weight:600;padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin:10px 0;}
.admin-btn:hover{background:#e0c35a;}
.hidden{display:none;}
.admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.admin-tabs{display:flex;gap:10px;margin-bottom:15px;}
.admin-tab{padding:8px 15px;border-radius:6px;border:1px solid var(--gold);cursor:pointer;background:#fff;color:#1b1b1b;font-weight:600;}
.admin-tab.active{background:var(--gold);}
.tab-content{display:none;}
.tab-content.active{display:block;}
.cancelled-banner{
  position:absolute;
  top:30%;
  left:50%;
  transform:translate(-50%,-50%) rotate(-20deg);
  background:rgba(255,0,0,0.75);
  color:#fff;
  font-size:2rem;
  font-weight:900;
  padding:15px 60px;
  border-radius:10px;
  pointer-events:none;
  text-transform:uppercase;
}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <div class="site-title">Barford Golf Society</div>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>

  <div id="adminPanel" class="admin-panel hidden">
    <div class="admin-tabs">
      <div class="admin-tab active" onclick="switchTab('createTab')">üü© Create Event</div>
      <div class="admin-tab" onclick="switchTab('deleteTab')">üü• Delete Event</div>
      <div class="admin-tab" onclick="switchTab('editTab')">üü® Edit / Cancel Event</div>
    </div>

    <!-- CREATE TAB -->
    <div id="createTab" class="tab-content active">
      <h3>Create a New Event</h3>
      <label>Name*</label><br><input id="newName" type="text" style="width:100%;"><br>
      <label>Date*</label><br><input id="newDate" type="date" style="width:200px;"><br>
      <label>Location*</label><br><input id="newLocation" type="text" style="width:100%;"><br>
      <label>Price (¬£)</label><br><input id="newPrice" type="number" step="0.01" style="width:120px;"><br>
      <label>Image URL</label><br><input id="newImage" type="text" style="width:100%;"><br>
      <label>Course Link</label><br><input id="newCourseLink" type="text" style="width:100%;"><br>
      <label>Weather Link</label><br><input id="newWeatherLink" type="text" style="width:100%;"><br>
      <label>Description</label><br><textarea id="newDesc" rows="4" style="width:100%;"></textarea><br>
      <button class="admin-btn" onclick="createEvent()">‚úÖ Create Event</button>
      <div id="createMsg" style="margin-top:10px;font-weight:600;"></div>
    </div>

    <!-- DELETE TAB -->
    <div id="deleteTab" class="tab-content">
      <h3>Delete Event</h3>
      <select id="deleteSelect" style="width:100%;max-width:400px;margin-bottom:10px;"></select>
      <button class="admin-btn" style="background:#ff4d4d;" onclick="deleteEvent()">üóëÔ∏è Delete Selected Event</button>
      <div id="deleteMsg" style="margin-top:10px;font-weight:600;"></div>
    </div>

    <!-- EDIT TAB -->
    <div id="editTab" class="tab-content">
      <h3>Edit / Cancel Event</h3>
      <select id="editSelect" style="width:100%;max-width:400px;margin-bottom:10px;"></select>
      <button class="admin-btn" onclick="toggleCancelled()">üö´ Cancel / Uncancel Selected Event</button>
      <div id="editMsg" style="margin-top:10px;font-weight:600;"></div>
    </div>
  </div>

  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const ADMIN_PASSWORD = "westbrom1997";
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// PAGE LOAD
window.onload = () => {
  loadEvents();
  if (localStorage.getItem("isAdmin") === "true") {
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("adminToggle").textContent = "‚¨ÖÔ∏è Back to Events";
    loadAdminEventOptions();
  }
};

// ADMIN ACCESS
function toggleAdminAccess() {
  const panel = document.getElementById("adminPanel");
  const btn = document.getElementById("adminToggle");
  const isAdmin = localStorage.getItem("isAdmin") === "true";
  if (!isAdmin) {
    const pass = prompt("Enter admin password:");
    if (pass === ADMIN_PASSWORD) {
      localStorage.setItem("isAdmin", "true");
      panel.classList.remove("hidden");
      btn.textContent = "‚¨ÖÔ∏è Back to Events";
      loadAdminEventOptions();
      alert("‚úÖ Admin access granted");
    } else alert("‚ùå Incorrect password");
  } else {
    localStorage.removeItem("isAdmin");
    panel.classList.add("hidden");
    btn.textContent = "üîê Admin Access";
  }
}

// TAB SWITCH
function switchTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  document.querySelectorAll(".admin-tab").forEach(t => t.classList.remove("active"));
  event.target.classList.add("active");
}

// LOAD EVENTS
async function loadEvents() {
  const { data: events, error } = await supabase.from("events").select("*").order("date", { ascending: true });
  const container = document.getElementById("eventList");
  if (error) { container.innerHTML = "<p>Error loading events.</p>"; return; }
  if (!events?.length) { container.innerHTML = "<p>No events found.</p>"; return; }

  container.innerHTML = "";
  for (const ev of events) {
    const cancelledBanner = ev.cancelled ? `<div class="cancelled-banner">‚ùå EVENT CANCELLED</div>` : "";
    const img = ev.ImageUrl ? `<img src="${ev.ImageUrl}" class="event-image">` : "";
    container.innerHTML += `
      <div class="event-card">
        ${cancelledBanner}
        <div class="event-header">
          <div><div class="event-name">${ev.name}</div><div>${ev.location} ‚Äî ${ev.date}</div></div>
          <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
        </div>
        ${img}
        ${ev.description ? `<div class='event-description'>${ev.description}</div>` : ""}
        <div class="event-links">
          ${ev.course_link ? `<a href="${ev.course_link}" target="_blank">Course</a>` : ""}
          ${ev.weather_link ? `<a href="${ev.weather_link}" target="_blank">Weather</a>` : ""}
        </div>
      </div>`;
  }

  loadAdminEventOptions();
}

// ADMIN OPTIONS REFRESH
async function loadAdminEventOptions() {
  const { data } = await supabase.from("events").select("id,name,date,cancelled").order("date",{ascending:true});
  const sel1 = document.getElementById("deleteSelect");
  const sel2 = document.getElementById("editSelect");
  if (!data?.length) {
    sel1.innerHTML = "<option>No events</option>";
    sel2.innerHTML = "<option>No events</option>";
    return;
  }
  sel1.innerHTML = data.map(e=>`<option value='${e.id}'>${e.name} (${e.date})</option>`).join("");
  sel2.innerHTML = data.map(e=>`<option value='${e.id}'>${e.name} (${e.date}) ${e.cancelled?"[CANCELLED]":""}</option>`).join("");
}

// CREATE EVENT
async function createEvent() {
  const name = document.getElementById("newName").value.trim();
  const date = document.getElementById("newDate").value;
  const location = document.getElementById("newLocation").value.trim();
  const price = document.getElementById("newPrice").value || null;
  const ImageUrl = document.getElementById("newImage").value.trim() || null;
  const course_link = document.getElementById("newCourseLink").value.trim() || null;
  const weather_link = document.getElementById("newWeatherLink").value.trim() || null;
  const description = document.getElementById("newDesc").value.trim();
  const msg = document.getElementById("createMsg");

  msg.textContent = "";
  if (!name || !date || !location) return msg.textContent="‚ö†Ô∏è Name, date and location are required.";
  const confirmMsg = `Please confirm event details:\n\n${name}\n${date}\n${location}\nPrice: ¬£${price || "-"}`;
  if (!confirm(confirmMsg)) return;

  const { error } = await supabase.from("events").insert([{ name, date, location, price, ImageUrl, description, course_link, weather_link, cancelled:false }]);
  if (error) { msg.textContent="‚ùå Error creating event: "+error.message; alert("‚ùå "+error.message); return; }
  msg.textContent="‚úÖ Event created successfully!";
  alert("‚úÖ Event created successfully!");
  document.querySelectorAll("#newName,#newDate,#newLocation,#newPrice,#newImage,#newCourseLink,#newWeatherLink,#newDesc").forEach(el=>el.value="");
  loadEvents();
}

// DELETE EVENT
async function deleteEvent() {
  const id=document.getElementById("deleteSelect").value;
  if(!id) return;
  if(!confirm("Are you sure you want to permanently delete this event and all related data?"))return;
  await supabase.from("tee_times").delete().eq("event_id",id);
  await supabase.from("rsvps").delete().eq("event_id",id);
  const {error}=await supabase.from("events").delete().eq("id",id);
  const msg=document.getElementById("deleteMsg");
  if(error){msg.textContent="‚ùå "+error.message;return;}
  msg.textContent="‚úÖ Event deleted.";
  alert("‚úÖ Event deleted!");
  loadEvents();
}

// CANCEL / UN-CANCEL
async function toggleCancelled() {
  const id=document.getElementById("editSelect").value;
  if(!id)return;
  const pass=prompt("Enter admin password to confirm:");
  if(pass!==ADMIN_PASSWORD)return alert("‚ùå Incorrect password");
  const {data,error}=await supabase.from("events").select("cancelled").eq("id",id).single();
  if(error)return alert("‚ùå "+error.message);
  const newStatus=!data.cancelled;
  const confirmText=newStatus?"Mark this event as CANCELLED?":"Mark this event as ACTIVE again?";
  if(!confirm(confirmText))return;
  const {error:e2}=await supabase.from("events").update({cancelled:newStatus}).eq("id",id);
  if(e2)return alert("‚ùå "+e2.message);
  alert(newStatus?"üö´ Event marked as CANCELLED":"‚úÖ Event reactivated");
  loadEvents();
}
</script>
</body>
</html>
