<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barford Golf Society | Events</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --green:#005a2b;
  --gold:#d4af37;
  --light-bg:#f7f7f5;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;text-align:center;padding:15px 0;}
.container{max-width:1000px;margin:30px auto;padding:0 20px;}
.admin-btn{background:var(--gold);color:#000;border:none;padding:8px 15px;border-radius:8px;font-weight:600;cursor:pointer;}
.admin-btn:hover{background:#e0c35a;}
.hidden{display:none;}
.admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:25px;}
.event-card{background:#fff;padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);position:relative;overflow:hidden;}
.event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
.cancel-banner{
  position:absolute;
  top:40%;
  left:-20%;
  width:140%;
  background:rgba(200,0,0,0.85);
  color:#fff;
  font-weight:800;
  font-size:2rem;
  text-align:center;
  transform:rotate(-15deg);
  z-index:2;
  padding:10px 0;
}
.rsvp-form{background:#f5f5f5;border-radius:10px;padding:15px;margin-top:10px;}
.rsvp-form input,.rsvp-form select{width:100%;margin:5px 0;padding:8px;border:1px solid #ccc;border-radius:5px;}
.rsvp-form button{background:var(--green);color:#fff;padding:8px 15px;border:none;border-radius:6px;cursor:pointer;}
.rsvp-form button:hover{background:#007a3d;}
</style>
</head>
<body>
<header>Barford Golf Society Events</header>

<div class="container">
  <div style="text-align:center;margin-bottom:20px;">
    <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>
  </div>

  <div id="adminPanel" class="admin-panel hidden">
    <div style="text-align:center;margin-bottom:10px;">
      <button class="admin-btn" onclick="showCreateForm()">Create Event</button>
      <button class="admin-btn" onclick="showDeleteForm()">Delete Event</button>
      <button class="admin-btn" onclick="showCancelForm()">Cancel/Uncancel Event</button>
    </div>

    <div id="createForm" class="hidden">
      <h3>Create New Event</h3>
      <input id="newName" placeholder="Event Name">
      <input id="newLocation" placeholder="Location">
      <input id="newDate" type="date">
      <input id="newPrice" type="number" step="0.01" placeholder="Price (¬£)">
      <textarea id="newDesc" placeholder="Event Description"></textarea>
      <input id="newCourse" placeholder="Course Link">
      <input id="newWeather" placeholder="Weather Link">
    <button class="admin-btn" onclick="createNewEvent()">Confirm Event</button>
    </div>

    <div id="deleteForm" class="hidden">
      <h3>Delete Event</h3>
      <select id="deleteSelect"></select>
      <button class="admin-btn" onclick="deleteEvent()">Delete</button>
    </div>

    <div id="cancelForm" class="hidden">
      <h3>Cancel/Uncancel Event</h3>
      <select id="cancelSelect"></select>
      <button class="admin-btn" onclick="cancelOrUncancel()">Toggle Cancel</button>
    </div>
  </div>

  <div id="eventList">Loading events...</div>
</div>

<footer>¬© 2025 Barford Golf Society</footer>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const ADMIN_PASSWORD = "westbrom1997";

const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

window.onload = () => { loadEvents(); if(localStorage.getItem("isAdmin")==="true"){document.getElementById("adminPanel").classList.remove("hidden");}};

// ---------------- ADMIN ACCESS ----------------
function toggleAdminAccess(){
  const panel=document.getElementById("adminPanel");
  const isAdmin=localStorage.getItem("isAdmin")==="true";
  if(!isAdmin){
    const pass=prompt("Enter admin password:");
    if(pass===ADMIN_PASSWORD){
      localStorage.setItem("isAdmin","true");
      panel.classList.remove("hidden");
      loadDropdowns();
      alert("‚úÖ Admin access granted");
    } else alert("‚ùå Incorrect password");
  } else {
    localStorage.removeItem("isAdmin");
    panel.classList.add("hidden");
  }
}

function showCreateForm(){hideAll();document.getElementById("createForm").classList.remove("hidden");}
function showDeleteForm(){hideAll();document.getElementById("deleteForm").classList.remove("hidden");}
function showCancelForm(){hideAll();document.getElementById("cancelForm").classList.remove("hidden");}
function hideAll(){["createForm","deleteForm","cancelForm"].forEach(id=>document.getElementById(id).classList.add("hidden"));}

async function loadDropdowns(){
  const {data}=await supabase.from("events").select("id,name,cancelled").order("date",{ascending:true});
  const del=document.getElementById("deleteSelect");
  const cancel=document.getElementById("cancelSelect");
  del.innerHTML=cancel.innerHTML="";
  data.forEach(e=>{
    del.innerHTML+=`<option value="${e.id}">${e.name}</option>`;
    cancel.innerHTML+=`<option value="${e.id}" data-cancelled="${e.cancelled}">${e.name} (${e.cancelled?"Cancelled":"Active"})</option>`;
  });
}

// ---------------- CREATE EVENT ----------------
async function createNewEvent() {
  const name=document.getElementById("newName").value.trim();
  if(!name)return alert("Enter name");
  const data={
    name,
    location:document.getElementById("newLocation").value.trim(),
    date:document.getElementById("newDate").value,
    price:document.getElementById("newPrice").value,
    description:document.getElementById("newDesc").value.trim(),
    course_link:document.getElementById("newCourse").value.trim(),
    weather_link:document.getElementById("newWeather").value.trim(),
    cancelled:false
  };
  const {error}=await supabase.from("events").insert([data]);
  if(error)alert("‚ùå Error creating event");
  else{alert("‚úÖ Event created");loadEvents();loadDropdowns();}
}

// ---------------- DELETE EVENT ----------------
async function deleteEvent(){
  const id=document.getElementById("deleteSelect").value;
  const pass=prompt("Confirm admin password:");
  if(pass!==ADMIN_PASSWORD)return alert("‚ùå Incorrect password");
  await supabase.from("events").delete().eq("id",id);
  alert("üóëÔ∏è Event deleted");
  loadEvents();loadDropdowns();
}

// ---------------- CANCEL EVENT ----------------
async function cancelOrUncancel(){
  const sel=document.getElementById("cancelSelect");
  const id=sel.value;
  const cancelled=sel.options[sel.selectedIndex].dataset.cancelled==="true";
  const pass=prompt("Enter admin password:");
  if(pass!==ADMIN_PASSWORD)return alert("‚ùå Incorrect password");
  const {error}=await supabase.from("events").update({cancelled:!cancelled}).eq("id",id);
  if(error)alert("‚ùå Error");
  else{
    alert(!cancelled?"üö´ Event Cancelled!":"‚úÖ Event Restored!");
    loadEvents();loadDropdowns();
  }
}

// ---------------- LOAD EVENTS ----------------
async function loadEvents(){
  const {data,error}=await supabase.from("events").select("*").order("date",{ascending:true});
  const list=document.getElementById("eventList");
  if(error)return list.innerHTML="<p>Error loading events</p>";
  if(!data?.length)return list.innerHTML="<p>No events yet</p>";
  list.innerHTML="";
  data.forEach(ev=>{
    const banner=ev.cancelled?`<div class='cancel-banner'>üö´ EVENT CANCELLED</div>`:"";
    list.innerHTML+=`
    <div class="event-card">
      ${banner}
      <div class="event-name">${ev.name}</div>
      <div>${ev.location} ‚Äî ${ev.date} ‚Äî ¬£${ev.price||"-"}</div>
      ${ev.description?`<p>${ev.description}</p>`:""}
      ${ev.course_link?`<a href="${ev.course_link}" target="_blank">Course Info</a><br>`:""}
      ${ev.weather_link?`<a href="${ev.weather_link}" target="_blank">Weather</a>`:""}
      ${!ev.cancelled?`<button class="admin-btn" onclick="toggleRSVP(${ev.id})">üìù RSVP</button>
      <div id="rsvpForm_${ev.id}" class="hidden"></div>`:""}
    </div>`;
  });
}

// ---------------- RSVP FORM ----------------
function toggleRSVP(eventId){
  const form=document.getElementById(`rsvpForm_${eventId}`);
  form.classList.toggle("hidden");
  if(!form.classList.contains("hidden"))form.innerHTML=`
  <form class='rsvp-form' onsubmit='submitRSVP(event,${eventId})'>
    <input id='name_${eventId}' placeholder='Name*' required>
    <select id='playing_${eventId}' required>
      <option value=''>Playing?</option>
      <option value='yes'>Yes</option>
      <option value='no'>No</option>
    </select>
    <select id='buggy_${eventId}' onchange='toggleBuggy(${eventId})' required>
      <option value=''>Need buggy?</option>
      <option value='yes'>Yes</option>
      <option value='no'>No</option>
    </select>
    <div id='buggyExtra_${eventId}' class='hidden'>
      <select id='flex_${eventId}'>
        <option value='need'>I need a buggy</option>
        <option value='happy'>Happy to walk if odd</option>
      </select>
      <input id='phone_${eventId}' placeholder='Phone number'>
    </div>
    <button>Submit RSVP</button>
    <div id='msg_${eventId}'></div>
  </form>`;
}

function toggleBuggy(eventId){
  const val=document.getElementById(`buggy_${eventId}`).value;
  document.getElementById(`buggyExtra_${eventId}`).classList.toggle("hidden",val!=="yes");
}

async function submitRSVP(e,eventId){
  e.preventDefault();
  const name=document.getElementById(`name_${eventId}`).value.trim();
  const playing=document.getElementById(`playing_${eventId}`).value;
  const buggy=document.getElementById(`buggy_${eventId}`).value==="yes";
  const flex=buggy?document.getElementById(`flex_${eventId}`).value:null;
  const phone=buggy?document.getElementById(`phone_${eventId}`).value.trim():null;
  const msg=document.getElementById(`msg_${eventId}`);
  if(!name)return msg.textContent="‚ö†Ô∏è Enter name";
  await supabase.from("rsvps").insert([{event_id:eventId,name,attending:playing==="yes",buggy,flexibility:flex,phone}]);
  msg.textContent="‚úÖ RSVP saved!";
}
  window.createNewEvent = createNewEvent;
</script>
</body>
</html>
