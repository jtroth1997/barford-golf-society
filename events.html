<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#005a2b;--gold:#d4af37;--light-bg:#f7f7f5;--card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.3rem;font-weight:700;}
.rsvp-form{margin-top:15px;border-top:1px solid #ccc;padding-top:15px;}
label{display:block;margin-top:8px;font-weight:600;}
select,input[type="text"],input[type="date"],button{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
button{background:var(--green);color:#fff;font-weight:600;cursor:pointer;margin-top:10px;}
button:hover{background:#0a6b34;}
.hidden{display:none;}
.notice{background:#ffeecc;color:#333;padding:10px;border-radius:6px;margin:10px 0;font-size:0.95rem;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
.tee-times{margin-top:20px;padding-top:10px;border-top:2px solid #eee;}
.group{background:#f9f9f9;margin:10px 0;padding:10px;border-radius:8px;}
.group strong{color:var(--green);}
.player{margin-left:15px;}
.buggy{color:#c47f00;margin-left:5px;}
.phone{font-size:0.9rem;color:#666;}
@media (max-width:700px){
  .event-header{flex-direction:column;align-items:flex-start;}
}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>Â© 2025 Barford Golf Society</p></footer>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// Load all events
async function loadEvents(){
  const { data: events, error } = await supabase.from("events").select("*").order("date",{ascending:true});
  if(error){ console.error(error); document.getElementById("eventList").innerHTML="Error loading events."; return; }
  if(!events.length){ document.getElementById("eventList").innerHTML="<p>No events found.</p>"; return; }
  const container=document.getElementById("eventList");
  container.innerHTML="";
  for(const ev of events){
    const card=document.createElement("div");
    card.className="event-card";
    card.innerHTML=`
      <div class="event-header">
        <div>
          <div class="event-name">${ev.name}</div>
          <div>${ev.location || ""} â€” ${ev.date}</div>
          <div><strong>Round:</strong> ${ev.round || ""}</div>
        </div>
        <div><strong>Price:</strong> Â£${ev.price || "-"}</div>
      </div>
      <form class="rsvp-form" onsubmit="submitRSVP(event,'${ev.id}')">
        <h4>RSVP for this Event</h4>
        <label>Full Name</label>
        <input type="text" id="name_${ev.id}" placeholder="Your name" required>
        <label>Email (optional)</label>
        <input type="text" id="email_${ev.id}" placeholder="Your email">
        <label>Phone (for buggy pairing)</label>
        <input type="text" id="phone_${ev.id}" placeholder="Your phone number">
        <label>Will you be attending?</label>
        <select id="attending_${ev.id}">
          <option value="true">Yes, Iâ€™ll be playing</option>
          <option value="false">No, I canâ€™t attend</option>
        </select>
        <label>Would you like to use a buggy?</label>
        <select id="buggy_${ev.id}">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
        <small>If you request a buggy, youâ€™ll be paired with another member who also requested one. Youâ€™ll find out your pairing about a week before the event. Once paired, please contact your partner directly to arrange buggy booking.</small>
        <label>If thereâ€™s an odd number of buggy requests, are you willing to walk instead?</label>
        <select id="flex_${ev.id}">
          <option value="Yes, happy to walk if needed">Yes, Iâ€™m happy to walk</option>
          <option value="No, need buggy">No, I need a buggy</option>
        </select>
        <button type="submit">Submit RSVP</button>
      </form>
      <div class="tee-times" id="tee_${ev.id}">
        <em>Loading tee times...</em>
      </div>
    `;
    container.appendChild(card);
    loadTeeTimes(ev.id);
  }
}
// Save RSVP
async function submitRSVP(e, eventId){
  e.preventDefault();
  const name=document.getElementById(`name_${eventId}`).value.trim();
  const email=document.getElementById(`email_${eventId}`).value.trim();
  const phone=document.getElementById(`phone_${eventId}`).value.trim();
  const attending=document.getElementById(`attending_${eventId}`).value==="true";
  const buggy=document.getElementById(`buggy_${eventId}`).value==="true";
  const flexibility=document.getElementById(`flex_${eventId}`).value;

  if(!name){ alert("Please enter your name."); return; }

  const { error } = await supabase.from("rsvps").upsert({
    event_id: eventId,
    name,
    email,
    phone,
    attending,
    buggy,
    flexibility
  }, { onConflict: ['event_id','name'] });

  if(error){ console.error(error); return alert("Error saving RSVP."); }

  alert("âœ… RSVP saved successfully!");
}

// Load tee times for event (with buggy pairs grouped and phone numbers)
async function loadTeeTimes(eventId){
  const container=document.getElementById(`tee_${eventId}`);
  const { data: tees, error } = await supabase
    .from("tee_times")
    .select("*")
    .eq("event_id", eventId)
    .order("group_number", { ascending:true });

  if(error){ console.error(error); container.innerHTML="Error loading tee times."; return; }

  if(!tees.length){
    container.innerHTML="<em>Tee times will appear here once published.</em>";
    return;
  }

  // Fetch event details
  const { data: evData } = await supabase.from("events").select("name, date").eq("id", eventId).single();
  const header = `<h3>â›³ Tee Times â€“ ${evData.name} (${evData.date})</h3>`;

  // Fetch RSVPs for buggy info
  const { data: rsvps } = await supabase
    .from("rsvps")
    .select("name, buggy, phone")
    .eq("event_id", eventId);

  const findRSVP = (playerName) =>
    rsvps?.find(r => r.name.trim().toLowerCase() === playerName.trim().toLowerCase());

  const buggyNote = rsvps?.some(r => r.buggy) ? `
    <p style="background:#fff8e6;padding:10px;border-radius:8px;margin-bottom:10px;">
      ðŸ›º <strong>Note:</strong> Any buggy pairs should contact each other directly to organise booking of their buggy.
    </p>` : "";

  let html = header + buggyNote;

  tees.forEach((g) => {
    // Sort players in each group so buggy users are first and grouped together
    const playersWithRSVP = g.players.map(p => ({
      name: p,
      ...findRSVP(p)
    }));

    const buggyPlayers = playersWithRSVP.filter(p => p.buggy);
    const walkers = playersWithRSVP.filter(p => !p.buggy);

    html += `<div class='group'>
      <strong>Group ${g.group_number} â€” ${g.tee_time}</strong>`;

    // --- Buggy Pairs ---
    if(buggyPlayers.length > 0){
      html += `<div style="margin-top:6px;margin-left:10px;">
        <strong>Buggy Pairs:</strong>
        <ul>`;
      for(let i=0;i<buggyPlayers.length;i+=2){
        const pair = buggyPlayers.slice(i,i+2);
        if(pair.length===2){
          html += `<li>ðŸ›º Pair: ${pair[0].name} (${pair[0].phone||'no phone'}) & ${pair[1].name} (${pair[1].phone||'no phone'})</li>`;
        } else {
          html += `<li>ðŸ›º Single buggy: ${pair[0].name} (${pair[0].phone||'no phone'}) <em>(pays full cost)</em></li>`;
        }
      }
      html += `</ul></div>`;
    }

    // --- Walkers ---
    if(walkers.length > 0){
      html += `<div style="margin-top:6px;margin-left:10px;">
        <strong>Walkers:</strong>
        <ul>
          ${walkers.map(p=>`<li>${p.name}</li>`).join('')}
        </ul>
      </div>`;
    }

    html += `</div>`;
  });

  container.innerHTML = html;
}



// Subscribe for realtime tee time updates
supabase.channel('tee_times_changes')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'tee_times' }, payload => {
    if(payload.new?.event_id){ loadTeeTimes(payload.new.event_id); }
  })
  .subscribe();

// Initialise
loadEvents();
</script>
</body>
</html>
