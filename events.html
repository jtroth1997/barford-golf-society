<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
:root {
  --green:#005a2b;
  --gold:#d4af37;
  --light-bg:#f7f7f5;
  --card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
.event-image{width:100%;max-height:350px;object-fit:cover;border-radius:10px;margin-top:10px;}
.event-links{margin-top:10px;}
.event-links a{margin-right:10px;color:var(--green);font-weight:600;text-decoration:none;}
.event-links a:hover{text-decoration:underline;}
.event-description{margin-top:10px;white-space:pre-line;}
.admin-btn{display:inline-block;background:var(--gold);color:#1b1b1b;font-weight:600;padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin-bottom:25px;}
.admin-btn:hover{background:#e0c35a;}
.hidden{display:none;}
.notice{background:#ffeecc;color:#333;padding:10px;border-radius:6px;margin:10px 0;font-size:0.95rem;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
.admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.admin-panel h3{color:var(--green);}
.rsvp-form{margin-top:15px;border-top:1px solid #ccc;padding-top:15px;}
label{display:block;margin-top:8px;font-weight:600;}
select,input[type="text"],input[type="date"],input[type="number"],textarea,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
button{background:var(--green);color:#fff;font-weight:600;cursor:pointer;margin-top:10px;}
button:hover{background:#0a6b34;}
.rsvp-list{margin-top:15px;background:#fafafa;border:1px solid #ddd;padding:10px;border-radius:8px;}
.count{font-weight:700;color:var(--gold);}
.tee-group{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:10px;}
.player-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:5px;margin:4px 0;cursor:move;}
</style>
</head>

<body>
<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>

  <div id="adminPanel" class="admin-panel hidden">
    <h3>Admin Control Panel</h3>
    <form id="eventForm" onsubmit="submitEvent(event)">
      <h4>Add New Event</h4>
      <label>Event Title</label><input type="text" id="title" required>
      <label>Location</label><input type="text" id="location" required>
      <label>Date</label><input type="date" id="date" required>
      <label>Price (¬£)</label><input type="number" id="price" required>
      <label>Description</label><textarea id="description"></textarea>
      <label>Course Website Link</label><input type="text" id="course_link" placeholder="https://">
      <label>Upload Image</label><input type="file" id="image" accept="image/*" onchange="previewImage(event)">
      <img id="preview" class="hidden" style="max-width:100%;margin-top:10px;">
      <button type="submit">Save Event</button>
      <div id="message"></div>
    </form>

    <div style="margin-top:40px;">
      <h4>üïì Tee Time Organiser</h4>
      <label>Select Event</label>
      <select id="teeEventSelect" onchange="loadAdminPlayers()" style="width:100%;max-width:400px;"></select>

      <div id="playerPool" style="margin-top:10px;">
        <em>Players will load once you select an event...</em>
      </div>

      <label style="margin-top:15px;">Starting Tee Time</label>
      <input type="text" id="startTime" value="9:00am" style="width:120px;">
      <label>Gap (mins)</label>
      <input type="number" id="gapMins" value="7" style="width:60px;">

      <button onclick="saveTeeTimes()" style="background:#d4af37;margin-top:15px;">üíæ Save Tee Times</button>
    </div>
  </div>

  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const ADMIN_PASSWORD = "westbrom1997";
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

function toggleAdminAccess() {
  const panel = document.getElementById("adminPanel");
  const btn = document.getElementById("adminToggle");
  const isAdmin = localStorage.getItem("isAdmin") === "true";
  if (!isAdmin) {
    const pass = prompt("Enter admin password:");
    if (pass === ADMIN_PASSWORD) {
      localStorage.setItem("isAdmin", "true");
      panel.classList.remove("hidden");
      btn.textContent = "‚¨ÖÔ∏è Back to Events";
      alert("‚úÖ Admin access granted");
    } else alert("‚ùå Incorrect password");
  } else {
    localStorage.removeItem("isAdmin");
    panel.classList.add("hidden");
    btn.textContent = "üîê Admin Access";
  }
}

window.onload = () => {
  if (localStorage.getItem("isAdmin") === "true") {
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("adminToggle").textContent = "‚¨ÖÔ∏è Back to Events";
  }
  loadEvents();
  loadAdminTeeTimeEvents();
};

// =========================
// LOAD EVENTS
// =========================
async function loadEvents() {
  const { data: events, error } = await supabase.from("events").select("*").order("date", { ascending: true });
  const container = document.getElementById("eventList");
  if (error || !events?.length) {
    container.innerHTML = "<p>No events found.</p>";
    return;
  }

  container.innerHTML = "";
  for (const ev of events) {
    const img = ev.image_url ? `<img src="${ev.image_url}" class="event-image">` : "";
    const desc = ev.description ? `<div class='event-description'>${ev.description}</div>` : "";
    const links = `<div class="event-links">
      ${ev.course_link ? `<a href="${ev.course_link}" target="_blank">üåê Course Website</a>` : ""}
      ${ev.weather_link ? `<a href="${ev.weather_link}" target="_blank">‚òÄÔ∏è BBC Weather</a>` : ""}
    </div>`;

    container.innerHTML += `
      <div class="event-card">
        <div class="event-header">
          <div><div class="event-name">${ev.name}</div><div>${ev.location} ‚Äî ${ev.date}</div></div>
          <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
        </div>
        ${img}${desc}${links}
      </div>`;
  }
}

// =========================
// ADMIN: LOAD EVENTS INTO TEE TIME SELECT
// =========================
async function loadAdminTeeTimeEvents() {
  const { data: events, error } = await supabase.from("events").select("id,name,date").order("date",{ascending:true});
  const select = document.getElementById("teeEventSelect");
  if (error || !events?.length) {
    select.innerHTML = "<option>No events found</option>";
    return;
  }
  select.innerHTML = events.map(e=>`<option value="${e.id}">${e.name} (${e.date})</option>`).join("");
}

// =========================
// LOAD PLAYERS FOR EVENT
// =========================
async function loadAdminPlayers() {
  const eventId = document.getElementById("teeEventSelect").value;
  const container = document.getElementById("playerPool");
  container.innerHTML = "<em>Loading players...</em>";
  const { data: rsvps, error } = await supabase.from("rsvps").select("name,buggy,flexibility,phone").eq("event_id", eventId).eq("attending", true);
  if (error || !rsvps?.length) {
    container.innerHTML = "<em>No RSVPs found for this event.</em>";
    return;
  }
  container.innerHTML = `<strong>Players Loaded: ${rsvps.length}</strong>
  <button onclick="generateTeeGroups(${eventId})" style="margin-left:10px;">‚öôÔ∏è Generate Tee Times</button>
  <div id="teeGroups" style="margin-top:20px;"></div>`;
}

// =========================
// AUTO-GENERATE TEE GROUPS
// =========================
async function generateTeeGroups(eventId) {
  const start = document.getElementById("startTime").value.trim();
  const gap = parseInt(document.getElementById("gapMins").value) || 7;
  const area = document.getElementById("teeGroups");
  area.innerHTML = "<em>Generating groups...</em>";

  const { data: rsvps } = await supabase.from("rsvps").select("name,buggy,flexibility,phone").eq("event_id", eventId).eq("attending", true);
  if (!rsvps?.length) {
    area.innerHTML = "<p>No RSVPs for this event.</p>";
    return;
  }

  let buggy = rsvps.filter(r=>r.buggy);
  let walkers = rsvps.filter(r=>!r.buggy);
  if (buggy.length % 2 !== 0) {
    const flex = buggy.find(r=>(r.flexibility||"").toLowerCase().includes("happy"));
    if (flex) {
      walkers.push(flex);
      buggy = buggy.filter(b=>b.name!==flex.name);
    }
  }

  const shuffle=a=>a.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
  buggy=shuffle(buggy);walkers=shuffle(walkers);

  const groups=[];
  for(let i=0;i<buggy.length;i+=4)groups.push(buggy.slice(i,i+4));
  for(let i=0;i<walkers.length;i+=4)groups.push(walkers.slice(i,i+4));

  const addMinutesToTime=(start,mins)=>{
    let [t,a]=start.toLowerCase().split(/(am|pm)/).filter(Boolean);
    let [h,m]=t.split(":").map(Number);
    if(a==="pm"&&h<12)h+=12;if(a==="am"&&h===12)h=0;
    const d=new Date();d.setHours(h);d.setMinutes(m+mins);
    const hr=d.getHours();const mi=String(d.getMinutes()).padStart(2,"0");
    const sfx=hr>=12?"pm":"am";const disp=((hr+11)%12)+1;
    return`${disp}:${mi}${sfx}`;
  };

  area.innerHTML="";
  groups.forEach((g,i)=>{
    const teeTime=addMinutesToTime(start,i*gap);
    const div=document.createElement("div");
    div.className="tee-group";
    div.innerHTML=`<strong>Group ${i+1}</strong> ‚Äî ${teeTime}<ul id="group_${i+1}" style="list-style:none;padding:0;margin-top:5px;"></ul>`;
    area.appendChild(div);
    const ul=div.querySelector("ul");
    g.forEach(p=>{
      const li=document.createElement("li");
      li.className="player-card";
      li.dataset.name=p.name;
      li.dataset.phone=p.phone||"";
      li.dataset.type=p.buggy?"buggy":"walker";
      li.innerHTML=`${p.buggy?"üõ∫":"üö∂"} ${p.name}${p.phone?` (${p.phone})`:""}`;
      ul.appendChild(li);
    });
    new Sortable(ul,{group:"players",animation:150});
  });

  alert("‚úÖ Tee times auto-generated! You can drag players before saving.");
}

// =========================
// SAVE TEE TIMES
// =========================
async function saveTeeTimes() {
  const eventId=document.getElementById("teeEventSelect").value;
  const start=document.getElementById("startTime").value.trim();
  const gap=parseInt(document.getElementById("gapMins").value)||7;
  const groups=Array.from(document.querySelectorAll(".tee-group ul"));
  if(!groups.length){alert("Generate groups first!");return;}

  const addMinutesToTime=(start,mins)=>{
    let [t,a]=start.toLowerCase().split(/(am|pm)/).filter(Boolean);
    let [h,m]=t.split(":").map(Number);
    if(a==="pm"&&h<12)h+=12;if(a==="am"&&h===12)h=0;
    const d=new Date();d.setHours(h);d.setMinutes(m+mins);
    const hr=d.getHours();const mi=String(d.getMinutes()).padStart(2,"0");
    const sfx=hr>=12?"pm":"am";const disp=((hr+11)%12)+1;
    return`${disp}:${mi}${sfx}`;
  };

  const data=groups.map((g,i)=>({
    event_id:eventId,
    group_number:i+1,
    tee_time:addMinutesToTime(start,i*gap),
    players:Array.from(g.children).map(el=>({
      name:el.dataset.name,
      phone:el.dataset.phone,
      type:el.dataset.type
    }))
  }));

  await supabase.from("tee_times").delete().eq("event_id",eventId);
  const {error}=await supabase.from("tee_times").insert(data);
  if(error){alert("‚ùå Error saving tee times.");return;}
  alert("‚úÖ Tee times saved!");
}
</script>
</body>
</html>
