<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
:root {
  --green:#005a2b;
  --gold:#d4af37;
  --light-bg:#f7f7f5;
  --card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);font-size:1.5rem;font-weight:700;}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);position:relative;}
.event-card.cancelled::after{
  content:"CANCELLED";
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) rotate(-20deg);
  background:rgba(255,0,0,0.85);color:#fff;
  font-size:3rem;font-weight:900;
  padding:20px 60px;border-radius:15px;
  text-shadow:2px 2px 5px rgba(0,0,0,0.3);
}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
.event-description{margin-top:10px;white-space:pre-line;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}

.admin-btn{display:inline-block;background:var(--gold);color:#1b1b1b;font-weight:600;padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin:10px 0;}
.admin-btn:hover{background:#e0c35a;}
.hidden{display:none;}
.admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.admin-tabs{display:flex;gap:10px;margin-bottom:20px;}
.admin-tab{flex:1;text-align:center;padding:10px;background:var(--green);color:var(--gold);border:none;border-radius:6px;cursor:pointer;font-weight:600;}
.admin-tab.active{background:var(--gold);color:var(--green);}
input,select,textarea{width:100%;padding:6px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px;font-family:inherit;}
.rsvp-list{background:#fafafa;border:1px solid #ddd;padding:10px;border-radius:8px;margin-top:10px;}
.player-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:5px;margin:4px 0;cursor:move;font-size:0.95rem;position:relative;}
.pair-tag{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:var(--green);color:var(--gold);padding:2px 6px;border-radius:6px;font-size:0.75rem;font-weight:600;}
.tee-group{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:10px;}
.tee-display{margin-top:10px;font-size:0.95rem;}
.tee-display .group{margin-bottom:10px;}
button[type=submit]{background:var(--green);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;}
button[type=submit]:hover{background:#007a3a;}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <div class="site-title">Barford Golf Society</div>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>

  <div id="adminPanel" class="admin-panel hidden">
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="showAdminTab('createEvent')">Create Event</button>
      <button class="admin-tab" onclick="showAdminTab('deleteEvent')">Delete Event</button>
      <button class="admin-tab" onclick="showAdminTab('cancelEvent')">Cancel / Un-cancel</button>
      <button class="admin-tab" onclick="showAdminTab('teeTimes')">Tee Times</button>
    </div>

    <div id="createEvent" class="admin-section">
      <h3>Create New Event</h3>
      <input id="newEventName" placeholder="Event Name" required>
      <input id="newEventDate" type="date" required>
      <input id="newEventLocation" placeholder="Location" required>
      <input id="newEventPrice" placeholder="Price (¬£)">
      <textarea id="newEventDescription" placeholder="Description"></textarea>
      <input id="newEventCourse" placeholder="Course Link (optional)">
      <input id="newEventWeather" placeholder="Weather Link (optional)">
      <button class="admin-btn" onclick="createEvent()">Create Event</button>
      <div id="createMsg"></div>
    </div>

    <div id="deleteEvent" class="admin-section hidden">
      <h3>Delete Event</h3>
      <select id="deleteEventSelect" style="max-width:400px;"></select>
      <button class="admin-btn" onclick="deleteEvent()">üóëÔ∏è Delete Selected Event</button>
      <div id="deleteMsg"></div>
    </div>

    <div id="cancelEvent" class="admin-section hidden">
      <h3>Cancel / Un-cancel Events</h3>
      <div id="cancelList">Loading...</div>
    </div>

    <div id="teeTimes" class="admin-section hidden">
      <h3>üïì Tee Time Generator</h3>
      <label>Select Event</label>
      <select id="teeEventSelect" style="max-width:400px;"></select>
      <div id="playerPool"><em>Players will load once you select an event...</em></div>
      <label>Starting Tee Time</label>
      <input type="text" id="startTime" value="9:00am" style="width:120px;margin-right:10px;">
      <label>Gap (mins)</label>
      <input type="number" id="gapMins" value="7" style="width:60px;">
      <div id="teeGroups" style="margin-top:20px;"></div>
      <button onclick="saveTeeTimes()" class="admin-btn">üíæ Save Tee Times</button>
    </div>
  </div>

  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const ADMIN_PASSWORD="westbrom1997";
const SUPABASE_URL="https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient }=window.supabase;
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY);

window.onload=()=>{loadEvents();if(localStorage.getItem("isAdmin")==="true"){document.getElementById("adminPanel").classList.remove("hidden");loadAdminEventOptions();}};

function toggleAdminAccess(){
  const panel=document.getElementById("adminPanel");
  const btn=document.getElementById("adminToggle");
  if(localStorage.getItem("isAdmin")==="true"){localStorage.removeItem("isAdmin");panel.classList.add("hidden");btn.textContent="üîê Admin Access";}
  else{const pass=prompt("Enter admin password:");if(pass===ADMIN_PASSWORD){localStorage.setItem("isAdmin","true");panel.classList.remove("hidden");btn.textContent="‚¨ÖÔ∏è Back to Events";loadAdminEventOptions();alert("‚úÖ Admin access granted");}else alert("‚ùå Incorrect password");}
}

function showAdminTab(id){
  document.querySelectorAll(".admin-tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".admin-section").forEach(s=>s.classList.add("hidden"));
  event.target.classList.add("active");
  document.getElementById(id).classList.remove("hidden");
  if(id==="deleteEvent")loadDeleteDropdown();
  if(id==="cancelEvent")loadCancelList();
  if(id==="teeTimes")loadAdminEventOptions();
}

// ---- CREATE EVENT ----
async function createEvent(){
  const name=document.getElementById("newEventName").value.trim();
  const date=document.getElementById("newEventDate").value;
  const location=document.getElementById("newEventLocation").value.trim();
  const price=document.getElementById("newEventPrice").value.trim();
  const description=document.getElementById("newEventDescription").value.trim();
  const course_link=document.getElementById("newEventCourse").value.trim();
  const weather_link=document.getElementById("newEventWeather").value.trim();
  if(!name||!date||!location)return alert("Please fill required fields.");
  const {error}=await supabase.from("events").insert([{name,date,location,price,description,course_link,weather_link,cancelled:false}]);
  document.getElementById("createMsg").textContent=error?"‚ùå Failed":"‚úÖ Event created!";
  if(!error)loadEvents();
}

// ---- DELETE EVENT ----
async function loadDeleteDropdown(){
  const sel=document.getElementById("deleteEventSelect");
  const {data}=await supabase.from("events").select("id,name,date").order("date",{ascending:true});
  sel.innerHTML=data.map(e=>`<option value='${e.id}'>${e.name} (${e.date})</option>`).join("");
}
async function deleteEvent(){
  const id=document.getElementById("deleteEventSelect").value;
  if(!id)return alert("Select event");
  await supabase.from("tee_times").delete().eq("event_id",id);
  await supabase.from("rsvps").delete().eq("event_id",id);
  const {error}=await supabase.from("events").delete().eq("id",id);
  document.getElementById("deleteMsg").textContent=error?"‚ùå Failed":"‚úÖ Deleted";
  loadEvents();
}

// ---- CANCEL / UN-CANCEL ----
async function loadCancelList(){
  const area=document.getElementById("cancelList");
  const {data}=await supabase.from("events").select("id,name,date,cancelled").order("date",{ascending:true});
  area.innerHTML=data.map(e=>`
    <div style="margin-bottom:10px;">
      <strong>${e.name}</strong> (${e.date}) ‚Äî <span style="color:${e.cancelled?'red':'green'};">${e.cancelled?'Cancelled':'Active'}</span>
      <button class="admin-btn" onclick="toggleCancel(${e.id},${e.cancelled})">${e.cancelled?'Un-cancel':'Cancel'}</button>
    </div>`).join("");
}
async function toggleCancel(id,current){
  const pass=prompt("Enter admin password:");
  if(pass!==ADMIN_PASSWORD)return alert("‚ùå Wrong password");
  await supabase.from("events").update({cancelled:!current}).eq("id",id);
  loadCancelList();loadEvents();
}

// ---- LOAD EVENTS ----
async function loadEvents(){
  const {data:events}=await supabase.from("events").select("*").order("date",{ascending:true});
  const area=document.getElementById("eventList");
  if(!events?.length)return area.innerHTML="<p>No events found.</p>";
  area.innerHTML="";
  for(const e of events){
    area.innerHTML+=`
      <div class="event-card ${e.cancelled?'cancelled':''}">
        <div class="event-header">
          <div><div class="event-name">${e.name}</div><div>${e.location} ‚Äî ${e.date}</div></div>
          <div><strong>Price:</strong> ¬£${e.price||'-'}</div>
        </div>
        ${e.description?`<div class='event-description'>${e.description}</div>`:""}
        <div class="event-links">
          ${e.course_link?`<a href="${e.course_link}" target="_blank">Course Info</a>`:""}
          ${e.weather_link?`<a href="${e.weather_link}" target="_blank">Weather</a>`:""}
        </div>
        <button class="admin-btn" id="rsvpBtn_${e.id}" onclick="showRSVPForm(${e.id})">üìù RSVP to this event</button>
        <div id="rsvpForm_${e.id}" class="hidden"></div>
        <div id="teeTimes_${e.id}" class="tee-display"></div>
      </div>`;
    loadTeeTimes(e.id);
  }
}

// ---- RSVP ----
function showRSVPForm(id){
  const f=document.getElementById(`rsvpForm_${id}`);
  const b=document.getElementById(`rsvpBtn_${id}`);
  if(!f.classList.contains("hidden")){f.classList.add("hidden");b.textContent="üìù RSVP to this event";return;}
  f.classList.remove("hidden");b.textContent="‚¨ÜÔ∏è Hide RSVP Form";
  f.innerHTML=`
  <form onsubmit="submitRSVP(event,${id})" class="rsvp-list">
    <label>Name*</label><input id="name_${id}" required>
    <label>Playing?*</label><select id="playing_${id}" required><option value="">Select</option><option value="yes">Yes</option><option value="no">No</option></select>
    <label>Need a buggy?*</label><select id="buggy_${id}" onchange="handleBuggyChange(${id})" required><option value="">Select</option><option value="yes">Yes</option><option value="no">No</option></select>
    <div id="buggyOptions_${id}" class="hidden">
      <label>Buggy preference</label><select id="flexibility_${id}"><option value="need">I need a buggy</option><option value="happy">Happy to walk if odd</option></select>
      <label>Phone number*</label><input id="phone_${id}" placeholder="07123 456789">
      <small>Your phone number will be visible to your buggy partner.</small>
    </div>
    <label>Preferred tee time</label><select id="pref_${id}"><option value="">No preference</option><option>First</option><option>Middle</option><option>End</option></select>
    <button type="submit">Submit RSVP</button>
    <div id="rsvpMsg_${id}" style="margin-top:10px;font-weight:600;"></div>
  </form>
  <div id="rsvpList_${id}" style="margin-top:20px;"></div>`;
  loadRSVPList(id);
}
function handleBuggyChange(id){
  const val=document.getElementById(`buggy_${id}`).value;
  document.getElementById(`buggyOptions_${id}`).classList.toggle("hidden",val!=="yes");
}
async function submitRSVP(e,id){
  e.preventDefault();
  const name=document.getElementById(`name_${id}`).value.trim();
  const playing=document.getElementById(`playing_${id}`).value;
  const buggy=document.getElementById(`buggy_${id}`).value;
  const flex=buggy==="yes"?document.getElementById(`flexibility_${id}`).value:null;
  const phone=buggy==="yes"?document.getElementById(`phone_${id}`).value.trim():null;
  const msg=document.getElementById(`rsvpMsg_${id}`);
  if(!name||!playing||!buggy)return msg.textContent="‚ö†Ô∏è Fill required fields";
  if(buggy==="yes"&&!phone)return msg.textContent="‚ö†Ô∏è Enter phone number";
  const attending=playing==="yes";
  await supabase.from("rsvps").insert([{event_id:id,name,attending,buggy:buggy==="yes",flexibility:flex,phone}]);
  msg.textContent="‚úÖ RSVP saved!";
  loadRSVPList(id);
}
async function loadRSVPList(id){
  const {data}=await supabase.from("rsvps").select("name,buggy,flexibility,attending").eq("event_id",id).eq("attending",true);
  const div=document.getElementById(`rsvpList_${id}`);
  if(!data?.length)return div.innerHTML="<em>No RSVPs yet.</em>";
  div.innerHTML="<h4>Players Attending</h4>"+data.map(p=>`<div>${p.buggy?"üõ∫":"üö∂"} ${p.name} ${p.flexibility==="happy"?"(Happy)":""}</div>`).join("");
}

// ---- PUBLIC TEE TIMES ----
async function loadTeeTimes(id){
  const a=document.getElementById(`teeTimes_${id}`);
  const {data}=await supabase.from("tee_times").select("*").eq("event_id",id).order("group_number",{ascending:true});
  if(!data?.length)return a.innerHTML="";
  let html="<h4>‚õ≥ Tee Times</h4>";
  data.forEach(g=>{
    html+=`<div class='group'><strong>Group ${g.group_number} ‚Äî ${g.tee_time}</strong><br>`;
    const buggy=g.players.filter(p=>p.type==="buggy");
    const walkers=g.players.filter(p=>p.type==="walker");
    for(let i=0;i<buggy.length;i+=2){
      const p1=buggy[i],p2=buggy[i+1];
      html+=`üõ∫ Pair ${(i/2)+1}: ${p1.name} (${p1.phone||""})${p2?" & "+p2.name+" ("+(p2.phone||"")+")":""}<br>`;
    }
    walkers.forEach(w=>html+=`üö∂ ${w.name}<br>`);
    html+="</div>";
  });
  a.innerHTML=html;
}

// ---- ADMIN TEETIMES ----
async function loadAdminEventOptions(){
  const sel=document.getElementById("teeEventSelect");
  const {data}=await supabase.from("events").select("id,name,date").order("date",{ascending:true});
  sel.innerHTML="<option value=''>Select event</option>"+data.map(e=>`<option value='${e.id}'>${e.name} (${e.date})</option>`).join("");
  sel.onchange=()=>loadAdminPlayers(sel.value);
}
async function loadAdminPlayers(id){
  const pool=document.getElementById("playerPool");
  const {data}=await supabase.from("rsvps").select("name,buggy,flexibility,phone,attending").eq("event_id",id).eq("attending",true);
  if(!data?.length)return pool.innerHTML="<em>No RSVPs.</em>";
  pool.innerHTML=`<strong>Players loaded: ${data.length}</strong> <button onclick='generateTeeGroups(${id})'>‚öôÔ∏è Generate Tee Times</button>`;
  window.currentPlayers=data;
}
function generateTeeGroups(id){
  const area=document.getElementById("teeGroups");area.innerHTML="";
  const all=[...window.currentPlayers];
  const div=document.createElement("div");
  const ul=document.createElement("ul");
  ul.style.listStyle="none";ul.style.padding="0";
  all.forEach(p=>{
    const li=document.createElement("li");
    li.className="player-card";
    li.dataset.name=p.name;
    li.dataset.phone=p.phone||"";
    li.dataset.type=p.buggy?"buggy":"walker";
    li.innerHTML=`${p.buggy?"üõ∫":"üö∂"} ${p.name}${p.buggy?" ("+(p.phone||"")+")":""}`;
    ul.appendChild(li);
  });
  div.appendChild(ul);area.appendChild(div);
  Sortable.create(ul,{animation:150,onEnd:()=>updatePairs(ul)});updatePairs(ul);
}
function updatePairs(ul){
  const players=ul.querySelectorAll(".player-card");
  players.forEach(p=>p.querySelector(".pair-tag")?.remove());
  for(let i=0;i<players.length-1;i++){
    const a=players[i],b=players[i+1];
    if(a.dataset.type==="buggy"&&b.dataset.type==="buggy"){
      a.insertAdjacentHTML("beforeend","<span class='pair-tag'>üõ∫ Pair Created</span>");
      b.insertAdjacentHTML("beforeend","<span class='pair-tag'>üõ∫ Pair Created</span>");
    }
  }
}
async function saveTeeTimes(){
  const id=document.getElementById("teeEventSelect").value;
  if(!id)return alert("Select event first");
  const ul=document.querySelector("#teeGroups ul");
  if(!ul)return alert("Generate tee times first");
  const players=[...ul.querySelectorAll(".player-card")].map(li=>({name:li.dataset.name,phone:li.dataset.phone||null,type:li.dataset.type}));
  await supabase.from("tee_times").delete().eq("event_id",id);
  const {error}=await supabase.from("tee_times").insert([{event_id:id,group_number:1,tee_time:"9:00am",players}]);
  alert(error?"‚ùå Error saving":"‚úÖ Tee times saved!");
  loadEvents();
}
</script>
</body>
</html>
