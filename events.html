<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events | Barford Golf Society</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --green:#005a2b;
      --gold:#d4af37;
      --light-bg:#f7f7f5;
      --card:#fff;
    }
    body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
    header,footer{background:var(--green);color:#fff;padding:15px 0;}
    .header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
    .site-title{color:var(--gold);font-size:1.5rem;font-weight:700;}
    .site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
    .site-nav a{color:#fff;text-decoration:none;font-weight:600;}
    .site-nav a:hover,.active{color:var(--gold);}
    .container{max-width:1100px;margin:40px auto;padding:0 20px;}
    .event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
    .event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
    .event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
    .event-image{width:100%;max-height:350px;object-fit:cover;border-radius:10px;margin-top:10px;}
    .event-links{margin-top:10px;}
    .event-links a{margin-right:10px;color:var(--green);font-weight:600;text-decoration:none;}
    .event-links a:hover{text-decoration:underline;}
    .event-description{margin-top:10px;white-space:pre-line;}
    footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}

    .admin-btn{display:inline-block;background:var(--gold);color:#1b1b1b;font-weight:600;padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin:10px 0;}
    .admin-btn:hover{background:#e0c35a;}
    .hidden{display:none;}

    .admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
    .admin-panel h3{color:var(--green);margin-top:0;}

    label{display:block;margin-top:8px;font-weight:600;}
    select,input[type="text"],input[type="number"],textarea,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}

    .rsvp-list{background:#fafafa;border:1px solid #ddd;padding:10px;border-radius:8px;margin-top:10px;}
    .player-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:5px;margin:4px 0;cursor:move;font-size:0.95rem;}
    .tee-group{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:10px;}
    .tee-display{margin-top:10px;font-size:0.95rem;}
    .tee-display .group{margin-bottom:10px;}
  </style>
</head>

<body>
  <header>
    <div class="header-container">
      <div class="site-title">Barford Golf Society</div>
      <nav class="site-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="events.html" class="active">Events</a></li>
          <li><a href="scores.html">Scores</a></li>
          <li><a href="gallery.html">Gallery</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Admin Button + Panel -->
    <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>

    <div id="adminPanel" class="admin-panel hidden">
      <h3>üïì Tee Time Generator</h3>
      <label>Select Event</label>
      <select id="teeEventSelect" style="width:100%;max-width:400px;margin-bottom:10px;">
        <option value="">Loading events...</option>
      </select>
      <div id="playerPool" style="margin-top:10px;"><em>Players will load once you select an event...</em></div>
      <label>Starting Tee Time</label>
      <input type="text" id="startTime" value="9:00am" style="width:120px;margin-right:10px;">
      <label>Gap (mins)</label>
      <input type="number" id="gapMins" value="7" style="width:60px;">
      <button onclick="saveTeeTimes()" style="background:#d4af37;margin-top:15px;">üíæ Save Tee Times</button>
    </div>

    <h2>Upcoming Events</h2>
    <div id="eventList">Loading events...</div>
  </main>

  <footer>
    <p>¬© 2025 Barford Golf Society</p>
  </footer>

  <script>
    const ADMIN_PASSWORD = "westbrom1997";
    const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = () => {
      loadEvents();
      if (localStorage.getItem("isAdmin") === "true") {
        document.getElementById("adminPanel").classList.remove("hidden");
        document.getElementById("adminToggle").textContent = "‚¨ÖÔ∏è Back to Events";
        loadAdminEventOptions();
      }
    };

    // =========================
    // ADMIN LOGIN TOGGLE
    // =========================
    function toggleAdminAccess() {
      const panel = document.getElementById("adminPanel");
      const btn = document.getElementById("adminToggle");
      const isAdmin = localStorage.getItem("isAdmin") === "true";

      if (!isAdmin) {
        const pass = prompt("Enter admin password:");
        if (pass === ADMIN_PASSWORD) {
          localStorage.setItem("isAdmin", "true");
          panel.classList.remove("hidden");
          btn.textContent = "‚¨ÖÔ∏è Back to Events";
          loadAdminEventOptions();
          alert("‚úÖ Admin access granted");
        } else {
          alert("‚ùå Incorrect password");
        }
      } else {
        localStorage.removeItem("isAdmin");
        panel.classList.add("hidden");
        btn.textContent = "üîê Admin Access";
      }
    }

    // =========================
    // PUBLIC: LOAD EVENTS
    // =========================
    async function loadEvents() {
      const { data: events, error } = await supabase
        .from("events")
        .select("*")
        .order("date", { ascending: true });

      const container = document.getElementById("eventList");
      if (error || !events?.length) {
        container.innerHTML = "<p>No events found.</p>";
        return;
      }

      container.innerHTML = "";
      for (const ev of events) {
        const img = ev.image_url ? `<img src="${ev.image_url}" class="event-image">` : "";
        const desc = ev.description ? `<div class='event-description'>${ev.description}</div>` : "";
        const links = `<div class="event-links">
          ${ev.course_link ? `<a href="${ev.course_link}" target="_blank">üåê Course Website</a>` : ""}
          ${ev.weather_link ? `<a href="${ev.weather_link}" target="_blank">‚òÄÔ∏è BBC Weather</a>` : ""}
        </div>`;

        container.innerHTML += `
          <div class="event-card">
            <div class="event-header">
              <div>
                <div class="event-name">${ev.name}</div>
                <div>${ev.location} ‚Äî ${ev.date}</div>
              </div>
              <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
            </div>
            ${img}${desc}${links}
            <button class="admin-btn" id="rsvpBtn_${ev.id}" onclick="showRSVPForm(${ev.id})">üìù RSVP to this event</button>
            <div id="rsvpForm_${ev.id}" class="hidden"></div>
            <div id="teeTimes_${ev.id}" class="tee-display"></div>
          </div>
        `;

        loadTeeTimes(ev.id);
      }
    }

    // =========================
    // PUBLIC: RSVP FORM + LIST
    // =========================
    function showRSVPForm(eventId) {
      const formContainer = document.getElementById(`rsvpForm_${eventId}`);
      const btn = document.getElementById(`rsvpBtn_${eventId}`);

      if (!formContainer.classList.contains("hidden")) {
        formContainer.classList.add("hidden");
        btn.textContent = "üìù RSVP to this event";
        return;
      }

      formContainer.classList.remove("hidden");
      btn.textContent = "‚¨ÜÔ∏è Hide RSVP Form";

      formContainer.innerHTML = `
        <form onsubmit="submitRSVP(event, ${eventId})" class="rsvp-list">
          <label>Name*</label>
          <input type="text" id="name_${eventId}" required>

          <label>Are you playing?*</label>
          <select id="playing_${eventId}" required>
            <option value="">Select</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>

          <label>Do you need a buggy?*</label>
          <select id="buggy_${eventId}" onchange="handleBuggyChange(${eventId})" required>
            <option value="">Select</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>

          <div id="buggyOptions_${eventId}" class="hidden">
            <label>Buggy preference</label>
            <select id="flexibility_${eventId}">
              <option value="need">I need a buggy</option>
              <option value="happy">Happy to walk if odd numbers</option>
            </select>

            <label>Phone number*</label>
            <input type="text" id="phone_${eventId}" placeholder="07123 456789">
            <small>Your phone number will be displayed with your buggy partner so you can contact each other to organise booking.</small>
          </div>

          <label>Preferred Tee Time (optional)</label>
          <select id="preferred_${eventId}">
            <option value="">No preference</option>
            <option value="first">First</option>
            <option value="middle">Middle</option>
            <option value="end">Near the end</option>
          </select>

          <button type="submit" style="margin-top:10px;">Submit RSVP</button>
          <div id="rsvpMsg_${eventId}" style="margin-top:10px;font-weight:600;"></div>
        </form>
        <div id="rsvpList_${eventId}" style="margin-top:20px;"></div>
      `;

      loadRSVPList(eventId);
    }

    function handleBuggyChange(eventId) {
      const val = document.getElementById(`buggy_${eventId}`).value;
      const section = document.getElementById(`buggyOptions_${eventId}`);
      if (val === "yes") section.classList.remove("hidden");
      else section.classList.add("hidden");
    }

    async function submitRSVP(e, eventId) {
      e.preventDefault();

      const name = document.getElementById(`name_${eventId}`).value.trim();
      const playing = document.getElementById(`playing_${eventId}`).value;
      const buggy = document.getElementById(`buggy_${eventId}`).value;
      const flexibility = buggy === "yes" ? document.getElementById(`flexibility_${eventId}`).value : null;
      const phone = buggy === "yes" ? document.getElementById(`phone_${eventId}`).value.trim() : null;
      const preferred = document.getElementById(`preferred_${eventId}`).value;
      const msg = document.getElementById(`rsvpMsg_${eventId}`);

      if (!name || !playing || !buggy) {
        msg.textContent = "‚ö†Ô∏è Please fill out all required fields.";
        msg.style.color = "red";
        return;
      }

      if (buggy === "yes" && !phone) {
        msg.textContent = "‚ö†Ô∏è Please enter your phone number if you need a buggy.";
        msg.style.color = "red";
        return;
      }

      const attending = playing === "yes";

      const { error } = await supabase.from("rsvps").insert([
        {
          event_id: eventId,
          name,
          attending,
          buggy: buggy === "yes",
          flexibility,
          phone,
          preferred_time: preferred
        }
      ]);

      if (error) {
        msg.textContent = "‚ùå Error saving RSVP. Please try again.";
        msg.style.color = "red";
      } else {
        msg.textContent = "‚úÖ RSVP saved successfully!";
        msg.style.color = "green";
        e.target.reset();
        loadRSVPList(eventId);
      }
    }

    async function loadRSVPList(eventId) {
      const listDiv = document.getElementById(`rsvpList_${eventId}`);
      const { data: rsvps, error } = await supabase
        .from("rsvps")
        .select("name, buggy, flexibility, attending")
        .eq("event_id", eventId)
        .eq("attending", true);

      if (error || !rsvps?.length) {
        listDiv.innerHTML = "<em>No RSVPs yet for this event.</em>";
        return;
      }

      let html = "<h4>Players Attending</h4><ul style='list-style:none;padding:0;'>";
      rsvps.forEach(p => {
        if (p.buggy) {
          html += `<li>üõ∫ ${p.name} ${
            p.flexibility === "happy" ? "(Happy to walk if odd)" : "(Needs buggy)"
          }</li>`;
        } else {
          html += `<li>üö∂ ${p.name}</li>`;
        }
      });
      html += "</ul>";
      listDiv.innerHTML = html;
    }

    // =========================
    // PUBLIC: LOAD SAVED TEE TIMES
    // =========================
    async function loadTeeTimes(eventId) {
      const area = document.getElementById(`teeTimes_${eventId}`);
      const { data: teeTimes, error } = await supabase
        .from("tee_times")
        .select("*")
        .eq("event_id", eventId)
        .order("group_number", { ascending: true });

      if (error || !teeTimes?.length) {
        area.innerHTML = "";
        return;
      }

      let html = "<h4>‚õ≥ Tee Times</h4>";
      teeTimes.forEach(g => {
        const players = g.players || [];
        const buggyPlayers = players.filter(p => p.type === "buggy");
        const walkers = players.filter(p => p.type === "walker");

        html += `<div class="group"><strong>Group ${g.group_number} ‚Äî ${g.tee_time}</strong><br>`;

        // Buggy pairs
        for (let i = 0; i < buggyPlayers.length; i += 2) {
          const p1 = buggyPlayers[i];
          const p2 = buggyPlayers[i + 1];
          if (p2) {
            html += `üõ∫ Pair ${(i / 2) + 1}: ${p1.name} (${p1.phone || "no phone"}) & ${p2.name} (${p2.phone || "no phone"})<br>`;
          } else {
            html += `üõ∫ ${p1.name} (${p1.phone || "no phone"})<br>`;
          }
        }

        // Walkers
        walkers.forEach(w => {
          html += `üö∂ ${w.name}<br>`;
        });

        html += "</div>";
      });

      area.innerHTML = html;
    }

    // =========================
    // ADMIN: LOAD EVENTS INTO DROPDOWN
    // =========================
    async function loadAdminEventOptions() {
      const select = document.getElementById("teeEventSelect");
      select.innerHTML = "<option value=''>Loading events...</option>";

      const { data: events, error } = await supabase
        .from("events")
        .select("id, name, date")
        .order("date", { ascending: true });

      if (error || !events?.length) {
        select.innerHTML = "<option value=''>No events found</option>";
        return;
      }

      select.innerHTML = "<option value=''>Select an event</option>" +
        events.map(e => `<option value="${e.id}">${e.name} (${e.date})</option>`).join("");

      select.onchange = () => {
        const eventId = select.value;
        if (!eventId) {
          document.getElementById("playerPool").innerHTML = "<em>Players will load once you select an event...</em>";
          document.getElementById("teeGroups").innerHTML = "";
          return;
        }
        loadAdminPlayers(eventId);
      };
    }

    // =========================
    // ADMIN: LOAD RSVPS FOR SELECTED EVENT
    // =========================
    async function loadAdminPlayers(eventId) {
      const pool = document.getElementById("playerPool");
      pool.innerHTML = "<em>Loading RSVPs...</em>";

      const { data: rsvps, error } = await supabase
        .from("rsvps")
        .select("name, buggy, flexibility, phone, attending")
        .eq("event_id", eventId)
        .eq("attending", true);

      if (error) {
        pool.innerHTML = "<p style='color:red;'>‚ùå Error loading RSVPs</p>";
        console.error(error);
        return;
      }

      if (!rsvps?.length) {
        pool.innerHTML = "<em>No RSVPs found for this event.</em>";
        document.getElementById("teeGroups").innerHTML = "";
        return;
      }

      let html = `<strong>Players loaded: ${rsvps.length}</strong>
        <button onclick="generateTeeGroups(${eventId})" style="margin-left:10px;">‚öôÔ∏è Generate Tee Times</button>`;
      pool.innerHTML = html;
      document.getElementById("teeGroups").innerHTML = "";

      window.currentPlayers = rsvps;
    }

    // =========================
    // ADMIN: GENERATE TEE TIMES (with buggy/walker logic)
    // =========================
    function generateTeeGroups(eventId) {
      const start = document.getElementById("startTime").value.trim();
      const gap = parseInt(document.getElementById("gapMins").value) || 7;
      const area = document.getElementById("teeGroups");
      const rsvps = window.currentPlayers || [];

      if (!rsvps.length) {
        area.innerHTML = "<p>No RSVPs for this event.</p>";
        return;
      }

      let buggy = rsvps.filter(r => r.buggy);
      let walkers = rsvps.filter(r => !r.buggy);

      // If odd number of buggy players, move a flexible one to walkers
      if (buggy.length % 2 !== 0) {
        const flex = buggy.find(r => (r.flexibility || "").toLowerCase().includes("happy"));
        if (flex) {
          walkers.push(flex);
          buggy = buggy.filter(b => b.name !== flex.name);
        }
      }

      // Shuffle helper
      const shuffle = a => a.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(p => p[1]);
      buggy = shuffle(buggy);
      walkers = shuffle(walkers);

      const groups = [];

      // Buggy groups first (pairs, up to 4 per group)
      for (let i = 0; i < buggy.length; i += 4) {
        groups.push(buggy.slice(i, i + 4));
      }

      // Walker groups after (up to 4 per group)
      for (let i = 0; i < walkers.length; i += 4) {
        groups.push(walkers.slice(i, i + 4));
      }

      const addMinutesToTime = (start, mins) => {
        let [t, a] = start.toLowerCase().split(/(am|pm)/).filter(Boolean);
        let [h, m] = t.split(":").map(Number);
        if (a === "pm" && h < 12) h += 12;
        if (a === "am" && h === 12) h = 0;
        const d = new Date();
        d.setHours(h);
        d.setMinutes(m + mins);
        const hr = d.getHours();
        const mi = String(d.getMinutes()).padStart(2, "0");
        const sfx = hr >= 12 ? "pm" : "am";
        const disp = ((hr + 11) % 12) + 1;
        return `${disp}:${mi}${sfx}`;
      };

      area.innerHTML = "";
      groups.forEach((group, i) => {
        const teeTime = addMinutesToTime(start, i * gap);
        const div = document.createElement("div");
        div.className = "tee-group";
        div.dataset.teeTime = teeTime;
        div.innerHTML = `<strong>Group ${i + 1}</strong> ‚Äî ${teeTime}<ul id="group_${i + 1}" style="list-style:none;padding:0;margin-top:5px;"></ul>`;
        area.appendChild(div);

        const ul = div.querySelector("ul");
        group.forEach(p => {
          const li = document.createElement("li");
          li.className = "player-card";
          li.dataset.name = p.name;
          li.dataset.phone = p.phone || "";
          li.dataset.type = p.buggy ? "buggy" : "walker";
          const labelExtra = p.buggy
            ? (p.flexibility === "happy" ? " (Happy to walk if odd)" : " (Needs buggy)")
            : "";
          li.innerHTML = `${p.buggy ? "üõ∫" : "üö∂"} <span class="player-name">${p.name}</span>${labelExtra}
            <button onclick="toggleType(this)" style="float:right;font-size:11px;padding:2px 6px;">üîÑ</button>`;
          ul.appendChild(li);
        });

        Sortable.create(ul, { group: "players", animation: 150 });
      });

      alert("‚úÖ Tee times generated! You can drag players and toggle buggy/walker before saving.");
    }

    // Toggle buggy/walker type for a player in admin view
    function toggleType(btn) {
      const li = btn.closest(".player-card");
      const isBuggy = li.dataset.type === "buggy";
      li.dataset.type = isBuggy ? "walker" : "buggy";

      // replace icon
      li.innerHTML = li.innerHTML.replace(isBuggy ? "üõ∫" : "üö∂", isBuggy ? "üö∂" : "üõ∫");
      li.appendChild(btn);
    }

    // =========================
    // ADMIN: SAVE TEE TIMES
    // =========================
    async function saveTeeTimes() {
      const eventId = document.getElementById("teeEventSelect").value;
      if (!eventId) {
        alert("Please select an event first.");
        return;
      }

      const groupDivs = Array.from(document.querySelectorAll(".tee-group"));
      if (!groupDivs.length) {
        alert("Generate groups first!");
        return;
      }

      const data = groupDivs.map((group, i) => {
        const ul = group.querySelector("ul");
        const players = Array.from(ul.children).map(li => ({
          name: li.dataset.name,
          phone: li.dataset.phone || null,
          type: li.dataset.type
        }));
        return {
          event_id: eventId,
          group_number: i + 1,
          tee_time: group.dataset.teeTime,
          players
        };
      });

      await supabase.from("tee_times").delete().eq("event_id", eventId);
      const { error } = await supabase.from("tee_times").insert(data);

      if (error) {
        alert("‚ùå Error saving tee times.");
        console.error(error);
      } else {
        alert("‚úÖ Tee times saved successfully!");
        loadTeeTimes(Number(eventId)); // refresh public display for that event
      }
    }
  </script>
</body>
</html>
