<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --green:#005a2b;--gold:#d4af37;--light-bg:#f7f7f5;--card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:900px;margin:40px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
h2{color:var(--green);}
label{display:block;margin-top:12px;font-weight:600;}
input[type="text"],input[type="date"],input[type="number"],textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
textarea{min-height:100px;}
button{background:var(--green);color:#fff;font-weight:600;cursor:pointer;margin-top:15px;padding:10px 18px;border:none;border-radius:6px;}
button:hover{background:#0a6b34;}
.notice{background:#eafbe8;color:#045b2b;padding:10px;border-radius:6px;margin-top:15px;}
.error{background:#ffeaea;color:#a30000;padding:10px;border-radius:6px;margin-top:15px;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
img.preview{margin-top:10px;max-width:200px;border-radius:8px;}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="admin.html" class="active">Admin</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <h2>Add New Event</h2>

  <form id="eventForm" onsubmit="submitEvent(event)">
    <label>Event Title</label>
    <input type="text" id="title" placeholder="e.g. Spring Society Day" required>

    <label>Location</label>
    <input type="text" id="location" placeholder="e.g. The Warwickshire Golf Club" required>

    <label>Date</label>
    <input type="date" id="date" required>

    <label>Price (£)</label>
    <input type="number" id="price" placeholder="e.g. 55" required>

    <label>Description</label>
    <textarea id="description" placeholder="Event details, format, timings, etc."></textarea>

    <label>Course Website Link</label>
    <input type="text" id="course_link" placeholder="https://www.thewarwickshire.com">

    <label>Upload Event Image</label>
    <input type="file" id="image" accept="image/*" onchange="previewImage(event)">
    <img id="preview" class="preview hidden" alt="Preview"/>

    <button type="submit">Save Event</button>
  </form>

  <div id="message"></div>
</div>

<footer><p>© 2025 Barford Golf Society</p></footer>

<script>
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// preview uploaded image
function previewImage(e){
  const file = e.target.files[0];
  const preview = document.getElementById('preview');
  if(file){
    preview.src = URL.createObjectURL(file);
    preview.classList.remove('hidden');
  }
}

// generate BBC weather link
function generateWeatherLink(location, date){
  if(!location || !date) return '';
  const cleanLocation = encodeURIComponent(location.trim());
  return `https://www.bbc.co.uk/weather/search?q=${cleanLocation}#${date}`;
}

// handle submit
async function submitEvent(e){
  e.preventDefault();
  const message = document.getElementById('message');
  message.innerHTML = '';

  const title = document.getElementById('title').value.trim();
  const location = document.getElementById('location').value.trim();
  const date = document.getElementById('date').value;
  const price = document.getElementById('price').value.trim();
  const description = document.getElementById('description').value.trim();
  const course_link = document.getElementById('course_link').value.trim();
  const file = document.getElementById('image').files[0];

  if(!title || !location || !date){
    message.innerHTML = '<div class="error">Please fill in all required fields.</div>';
    return;
  }

  let image_url = null;

  // Upload image to Supabase storage if provided
  if(file){
    const fileName = `${Date.now()}_${file.name}`;
    const { data, error: uploadError } = await supabase.storage.from('event-images').upload(fileName, file);
    if(uploadError){
      console.error(uploadError);
      message.innerHTML = '<div class="error">Error uploading image.</div>';
      return;
    }
    const { data: publicURLData } = supabase.storage.from('event-images').getPublicUrl(fileName);
    image_url = publicURLData.publicUrl;
  }

  // generate weather link
  const weather_link = generateWeatherLink(location, date);

  // insert event
  const { error } = await supabase.from('events').insert([{
    name: title,
    location,
    date,
    price,
    description,
    course_link,
    image_url,
    weather_link
  }]);

  if(error){
    console.error(error);
    message.innerHTML = '<div class="error">Error saving event.</div>';
    return;
  }

  message.innerHTML = '<div class="notice">✅ Event added successfully!</div>';
  document.getElementById('eventForm').reset();
  document.getElementById('preview').classList.add('hidden');
}
</script>
</body>
</html>
