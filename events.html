<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --green:#005a2b;--gold:#d4af37;--light-bg:#f7f7f5;--card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.3rem;font-weight:700;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
#createEventForm{background:#fff;padding:20px;border-radius:10px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-family:inherit;}
button:hover{opacity:0.9;}
button.danger{background:#b22222;color:#fff;}
button.primary{background:var(--green);color:#fff;}
.hidden{display:none;}
.notice{background:#ffeecc;color:#333;padding:10px;border-radius:6px;margin:10px 0;font-size:0.95rem;}
label{display:block;margin-top:10px;font-weight:600;}
input,select{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;width:100%;box-sizing:border-box;}
.small{font-size:.9rem;color:#666;}
.rsvp-form{margin-top:15px;border-top:1px solid #ccc;padding-top:15px;}
.rsvp-list{margin-top:15px;padding-top:10px;border-top:1px solid #eee;}
ul{margin:5px 0 0 20px;}
@media(max-width:700px){.event-header{flex-direction:column;align-items:flex-start;}}
</style>
</head>

<body>
<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <h2>Events</h2>

  <!-- Admin Event Creator -->
  <div id="adminCreate">
    <h3>Create a New Event (Admin Only)</h3>
    <div id="adminLogin">
      <input type="password" id="adminPw" placeholder="Enter admin password">
      <button type="button" id="unlockBtn" class="primary">Unlock</button>
      <p class="small">Creating events is password protected.</p>
    </div>

    <div id="createEventForm" class="hidden">
      <div>
        <label>Event Name</label>
        <input type="text" id="eventName" required>
      </div>
      <div>
        <label>Location</label>
        <input type="text" id="eventLocation" required>
      </div>
      <div>
        <label>Date</label>
        <input type="date" id="eventDate" required>
      </div>
      <div>
        <label>Price (¬£)</label>
        <input type="text" id="eventPrice" required>
      </div>
      <div>
        <label>Round Number</label>
        <select id="eventRound">
          <option value="1">Round 1</option>
          <option value="2">Round 2</option>
          <option value="3">Round 3</option>
          <option value="4">Round 4</option>
          <option value="5">Round 5</option>
          <option value="6">Round 6</option>
          <option value="7">Round 7</option>
        </select>
      </div>
      <button type="button" id="createEventBtn" class="primary">Create Event</button>
      <button type="button" id="lockBtn" class="danger">Lock</button>
    </div>
  </div>

  <h2 style="margin-top:40px;">Upcoming Events</h2>
  <div id="eventList"></div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
/* =========================
   SUPABASE CONFIG
   ========================= */
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   ADMIN PANEL
   ========================= */
const ADMIN_PASSWORD = "westbrom1997";
const adminLogin = document.getElementById("adminLogin");
const createForm = document.getElementById("createEventForm");

document.getElementById("unlockBtn").addEventListener("click", () => {
  const pw = document.getElementById("adminPw").value.trim();
  if (pw === ADMIN_PASSWORD) {
    adminLogin.classList.add("hidden");
    createForm.classList.remove("hidden");
    alert("‚úÖ Admin access granted!");
  } else {
    alert("‚ùå Incorrect password");
  }
});

document.getElementById("lockBtn").addEventListener("click", () => {
  createForm.classList.add("hidden");
  adminLogin.classList.remove("hidden");
  document.getElementById("adminPw").value = "";
  alert("üîí Admin panel locked.");
});

/* =========================
   LOAD EVENTS
   ========================= */
async function loadEvents() {
  const { data, error } = await supabase.from("events").select("*").order("date", { ascending: true });
  if (error) { console.error(error); return; }
  renderEvents(data);
}

/* =========================
   CREATE EVENT
   ========================= */
document.getElementById("createEventBtn").addEventListener("click", async () => {
  const name = document.getElementById("eventName").value.trim();
  const location = document.getElementById("eventLocation").value.trim();
  const date = document.getElementById("eventDate").value;
  const price = document.getElementById("eventPrice").value.trim();
  const round = document.getElementById("eventRound").value;

  if (!name || !location || !date || !price) {
    alert("‚ö†Ô∏è Please fill in all fields before creating the event.");
    return;
  }

  const { error } = await supabase.from("events").insert([{ name, location, date, price, round }]);
  if (error) {
    alert("‚ùå Error saving event: " + error.message);
    return;
  }

  alert(`üèåÔ∏è Event "${name}" created successfully!`);
  document.getElementById("eventName").value = "";
  document.getElementById("eventLocation").value = "";
  document.getElementById("eventDate").value = "";
  document.getElementById("eventPrice").value = "";
  document.getElementById("eventRound").value = "1";
  loadEvents();
});

/* =========================
   RENDER EVENTS + RSVP FORM
   ========================= */
async function renderEvents(events) {
  const container = document.getElementById("eventList");
  container.innerHTML = "";

  if (!events || !events.length) {
    container.innerHTML = "<p>No events yet.</p>";
    return;
  }

  for (const ev of events) {
    const safeId = `event_${ev.id}`;
    const deadline = new Date(ev.date);
    deadline.setDate(deadline.getDate() - 7);
    const formattedDeadline = deadline.toLocaleDateString("en-GB");

    const eventDiv = document.createElement("div");
    eventDiv.className = "event-card";
    eventDiv.innerHTML = `
      <div class="event-header">
        <div>
          <div class="event-name">${ev.name}</div>
          <div>${ev.location} ‚Äî ${ev.date}</div>
          <div><strong>Round:</strong> ${ev.round}</div>
        </div>
        <div><strong>Price:</strong> ¬£${ev.price}</div>
      </div>

      <div class="rsvp-form">
        <p class="small">Please complete this form to RSVP for this event.<br>
        RSVP deadline: <strong>${formattedDeadline}</strong>.<br>
        If you‚Äôd like a buggy, please request it below ‚Äì pairings will be confirmed a week before the event.</p>

        <label>Full Name</label>
        <input type="text" id="name_${safeId}" placeholder="Your full name" required>

        <label>Email (optional)</label>
        <input type="text" id="email_${safeId}" placeholder="your@email.com">

        <label>Phone Number (optional)</label>
        <input type="text" id="phone_${safeId}" placeholder="Your phone number">

        <label>Will you be attending this event?</label>
        <select id="attending_${safeId}">
          <option value="true">Yes, I‚Äôll be playing</option>
          <option value="false">No, I can‚Äôt attend</option>
        </select>

        <label>Would you like to use a buggy for this event?</label>
        <select id="buggy_${safeId}" onchange="toggleBuggy('${safeId}')">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>

        <div id="buggyNote_${safeId}" class="hidden small" style="margin-top:8px;">
          üí¨ If you request a buggy, we‚Äôll pair you with another member who also requested one.<br>
          You‚Äôll find out your pairing about a week before the event.<br>
          Once you‚Äôve been notified of your pairing, you‚Äôll need to book the buggy directly with the course.<br>
          The society is not responsible for making these bookings.<br>
          Please ensure your phone number is provided so your partner can contact you to arrange it.
        </div>

        <label>If there‚Äôs an odd number of buggy requests, are you willing to walk instead?</label>
        <select id="flexibility_${safeId}">
          <option value="Yes, happy to walk">Yes, I‚Äôm happy to walk if needed</option>
          <option value="No, need buggy">No, I definitely need a buggy</option>
        </select>

        <button class="primary" style="margin-top:12px;" onclick="submitRSVP(${ev.id}, '${safeId}')">Submit RSVP</button>
      </div>

      <div class="rsvp-list" id="rsvpList_${safeId}"></div>
    `;
    container.appendChild(eventDiv);
    loadRSVPs(ev.id, safeId);
  }
}

/* =========================
   BUGGY TOGGLE
   ========================= */
function toggleBuggy(id) {
  const buggy = document.getElementById(`buggy_${id}`).value === "true";
  document.getElementById(`buggyNote_${id}`).classList.toggle("hidden", !buggy);
  const phoneField = document.getElementById(`phone_${id}`);
  phoneField.required = buggy;
}

/* =========================
   SUBMIT RSVP
   ========================= */
async function submitRSVP(eventId, safeId) {
  const name = document.getElementById(`name_${safeId}`).value.trim();
  const email = document.getElementById(`email_${safeId}`).value.trim();
  const phone = document.getElementById(`phone_${safeId}`).value.trim();
  const attending = document.getElementById(`attending_${safeId}`).value === "true";
  const buggy = document.getElementById(`buggy_${safeId}`).value === "true";
  const flexibility = document.getElementById(`flexibility_${safeId}`).value;

  if (!name) return alert("Please enter your full name.");
  if (buggy && !phone) return alert("Please provide your phone number for buggy contact purposes.");

  const { error } = await supabase.from("rsvps").upsert(
    [{ event_id: eventId, name, email, phone, attending, buggy, flexibility }],
    { onConflict: ["event_id", "name"] }
  );

  if (error) {
    alert("‚ùå Error saving RSVP: " + error.message);
    return;
  }

  alert("‚úÖ Thank you for RSVPing. We‚Äôll confirm buggy pairings closer to the event.");
  loadRSVPs(eventId, safeId);
}

/* =========================
   LOAD RSVPS + DISPLAY LIST
   ========================= */
async function loadRSVPs(eventId, safeId) {
  const { data, error } = await supabase.from("rsvps").select("*").eq("event_id", eventId).order("created_at", { ascending: true });
  if (error) { console.error(error); return; }

  const div = document.getElementById(`rsvpList_${safeId}`);
  if (!data.length) {
    div.innerHTML = "<em>No RSVPs yet.</em>";
    return;
  }

  const attendees = data.filter(d => d.attending);
  div.innerHTML = "<strong>Who‚Äôs Going:</strong><ul>" +
    attendees.map(d => `<li>${d.name}</li>`).join("") + "</ul>";
}

/* =========================
   REALTIME SUBSCRIPTIONS
   ========================= */
supabase.channel("realtime:events")
  .on("postgres_changes", { event: "*", schema: "public", table: "events" }, payload => loadEvents())
  .subscribe();

supabase.channel("realtime:rsvps")
  .on("postgres_changes", { event: "*", schema: "public", table: "rsvps" }, payload => loadEvents())
  .subscribe();

/* =========================
   INIT
   ========================= */
loadEvents();
</script>
</body>
</html>
