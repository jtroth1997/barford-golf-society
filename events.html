<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
:root {
  --green:#005a2b;
  --gold:#d4af37;
  --light-bg:#f7f7f5;
  --card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);font-size:1.5rem;font-weight:700;}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:25px;box-shadow:0 3px 8px rgba(0,0,0,0.1);position:relative;}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.4rem;font-weight:700;}
.event-description{margin-top:10px;white-space:pre-line;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
.cancelled{opacity:0.6;filter:grayscale(60%);}
.cancel-banner{position:absolute;top:40%;left:0;right:0;text-align:center;font-size:2rem;font-weight:900;color:#fff;background:rgba(200,0,0,0.85);padding:20px;transform:rotate(-10deg);z-index:5;text-shadow:1px 1px 4px #000;letter-spacing:3px;}

.admin-btn{display:inline-block;background:var(--gold);color:#1b1b1b;font-weight:600;padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin:10px 0;}
.admin-btn:hover{background:#e0c35a;}
.hidden{display:none;}
.admin-panel{background:#fff;border:2px solid var(--gold);border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.admin-tabs{display:flex;gap:10px;margin-bottom:15px;}
.admin-tab{flex:1;text-align:center;background:var(--green);color:#fff;padding:8px;border-radius:6px;cursor:pointer;font-weight:600;}
.admin-tab.active{background:var(--gold);color:#1b1b1b;}
input,select,textarea{width:100%;padding:6px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
.rsvp-list{background:#fafafa;border:1px solid #ddd;padding:10px;border-radius:8px;margin-top:10px;}
.player-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:5px;margin:4px 0;cursor:move;font-size:0.95rem;}
.tee-group{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:10px;}
.tee-display{margin-top:10px;font-size:0.95rem;}
.tee-display .group{margin-bottom:10px;}
.pair-msg{color:var(--green);font-weight:700;text-align:center;}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <div class="site-title">Barford Golf Society</div>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <button id="adminToggle" class="admin-btn" onclick="toggleAdminAccess()">üîê Admin Access</button>

  <div id="adminPanel" class="admin-panel hidden">
    <div class="admin-tabs">
      <div class="admin-tab active" onclick="showAdminTab('create')">Create Event</div>
      <div class="admin-tab" onclick="showAdminTab('delete')">Delete Event</div>
      <div class="admin-tab" onclick="showAdminTab('cancel')">Cancel/Un-cancel</div>
      <div class="admin-tab" onclick="showAdminTab('tee')">Tee Times</div>
    </div>

    <div id="tab-create">
      <h3>üÜï Create New Event</h3>
      <input id="newEventName" placeholder="Event Name*" required>
      <input id="newEventLocation" placeholder="Location*" required>
      <input id="newEventDate" type="date" required>
      <input id="newEventPrice" placeholder="Price (¬£)">
      <textarea id="newEventDescription" placeholder="Description"></textarea>
      <input id="newEventCourse" placeholder="Course Link (optional)">
      <input id="newEventWeather" placeholder="Weather Link (optional)">
      <button class="admin-btn" onclick="createNewEvent()">Create Event</button>
      <div id="createMsg"></div>
    </div>

    <div id="tab-delete" class="hidden">
      <h3>üóëÔ∏è Delete Event</h3>
      <select id="deleteEventSelect"></select>
      <button class="admin-btn" onclick="deleteEvent()">Delete Selected Event</button>
      <div id="deleteMsg"></div>
    </div>

    <div id="tab-cancel" class="hidden">
      <h3>üö´ Cancel / Un-cancel Event</h3>
      <select id="cancelEventSelect"></select>
      <button class="admin-btn" onclick="toggleCancelEvent()">Toggle Cancel Status</button>
      <div id="cancelMsg"></div>
    </div>

    <div id="tab-tee" class="hidden">
      <h3>üïì Tee Time Generator</h3>
      <label>Select Event</label>
      <select id="teeEventSelect" style="width:100%;max-width:400px;margin-bottom:10px;"></select>
      <div id="playerPool"><em>Players will load once you select an event...</em></div>
      <label>Starting Tee Time</label>
      <input type="text" id="startTime" value="9:00am" style="width:120px;margin-right:10px;">
      <label>Gap (mins)</label>
      <input type="number" id="gapMins" value="7" style="width:60px;">
      <div id="teeGroups" style="margin-top:20px;"></div>
      <button class="admin-btn" onclick="saveTeeTimes()">üíæ Save Tee Times</button>
    </div>
  </div>

  <h2>Upcoming Events</h2>
  <div id="eventList">Loading events...</div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
const ADMIN_PASSWORD = "westbrom1997";
const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

window.onload = () => {
  loadEvents();
  if (localStorage.getItem("isAdmin") === "true") {
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("adminToggle").textContent = "‚¨ÖÔ∏è Back to Events";
    loadAdminDropdowns();
  }
};

function toggleAdminAccess() {
  const panel = document.getElementById("adminPanel");
  const btn = document.getElementById("adminToggle");
  const isAdmin = localStorage.getItem("isAdmin") === "true";
  if (!isAdmin) {
    const pass = prompt("Enter admin password:");
    if (pass === ADMIN_PASSWORD) {
      localStorage.setItem("isAdmin", "true");
      panel.classList.remove("hidden");
      btn.textContent = "‚¨ÖÔ∏è Back to Events";
      loadAdminDropdowns();
      alert("‚úÖ Admin access granted");
    } else alert("‚ùå Incorrect password");
  } else {
    localStorage.removeItem("isAdmin");
    panel.classList.add("hidden");
    btn.textContent = "üîê Admin Access";
  }
}

function showAdminTab(tab){
  document.querySelectorAll(".admin-tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll("#tab-create,#tab-delete,#tab-cancel,#tab-tee").forEach(d=>d.classList.add("hidden"));
  document.querySelector(`.admin-tab[onclick="showAdminTab('${tab}')"]`).classList.add("active");
  document.getElementById(`tab-${tab}`).classList.remove("hidden");
}

async function loadEvents(){
  const { data: events } = await supabase.from("events").select("*").order("date",{ascending:true});
  const container = document.getElementById("eventList");
  if (!events?.length){container.innerHTML="<p>No events found.</p>";return;}
  container.innerHTML="";
  for(const ev of events){
    container.innerHTML += `
      <div class="event-card ${ev.cancelled ? "cancelled" : ""}">
        ${ev.cancelled ? "<div class='cancel-banner'>CANCELLED</div>" : ""}
        <div class="event-header">
          <div><div class="event-name">${ev.name}</div><div>${ev.location} ‚Äî ${ev.date}</div></div>
          <div><strong>Price:</strong> ¬£${ev.price || "-"}</div>
        </div>
        ${ev.description ? `<div class='event-description'>${ev.description}</div>` : ""}
        <button class="admin-btn" id="rsvpBtn_${ev.id}" onclick="showRSVPForm(${ev.id})">üìù RSVP to this event</button>
        <div id="rsvpForm_${ev.id}" class="hidden"></div>
        <div id="teeTimes_${ev.id}" class="tee-display"></div>
      </div>`;
    loadTeeTimes(ev.id);
  }
}

async function createNewEvent(){
  const name=document.getElementById("newEventName").value.trim();
  const date=document.getElementById("newEventDate").value;
  const location=document.getElementById("newEventLocation").value.trim();
  const price=document.getElementById("newEventPrice").value.trim()||null;
  const description=document.getElementById("newEventDescription").value.trim()||null;
  const course_link=document.getElementById("newEventCourse").value.trim()||null;
  const weather_link=document.getElementById("newEventWeather").value.trim()||null;
  const msg=document.getElementById("createMsg");
  if(!name||!date||!location){msg.textContent="‚ö†Ô∏è Please fill all required fields.";return;}
  const {error}=await supabase.from("events").insert([{name,date,location,price,description,course_link,weather_link,cancelled:false}]);
  if(error){msg.textContent="‚ùå "+error.message;}else{msg.textContent="‚úÖ Event created!";loadEvents();}
}

async function deleteEvent(){
  const id=document.getElementById("deleteEventSelect").value;
  const msg=document.getElementById("deleteMsg");
  if(!id)return msg.textContent="‚ö†Ô∏è Select event first.";
  if(prompt("Enter admin password:")!==ADMIN_PASSWORD)return alert("‚ùå Incorrect password");
  await supabase.from("events").delete().eq("id",id);
  msg.textContent="üóëÔ∏è Event deleted.";
  loadEvents();loadAdminDropdowns();
}

async function toggleCancelEvent(){
  const id=document.getElementById("cancelEventSelect").value;
  const msg=document.getElementById("cancelMsg");
  if(!id)return msg.textContent="‚ö†Ô∏è Select event.";
  const {data}=await supabase.from("events").select("cancelled").eq("id",id).single();
  const newStatus=!data.cancelled;
  if(prompt(`Enter admin password to ${newStatus?"cancel":"un-cancel"}:`)!==ADMIN_PASSWORD)return alert("‚ùå Incorrect password");
  const {error}=await supabase.from("events").update({cancelled:newStatus}).eq("id",id);
  if(error){msg.textContent="‚ùå "+error.message;}else{msg.textContent=newStatus?"üö´ Event cancelled!":"‚úÖ Event reactivated!";loadEvents();}
}

async function loadAdminDropdowns(){
  const {data}=await supabase.from("events").select("id,name,date").order("date",{ascending:true});
  if(!data)return;
  const options=data.map(e=>`<option value='${e.id}'>${e.name} (${e.date})</option>`).join("");
  document.getElementById("deleteEventSelect").innerHTML=options;
  document.getElementById("cancelEventSelect").innerHTML=options;
  document.getElementById("teeEventSelect").innerHTML="<option value=''>Select event</option>"+options;
}

function showRSVPForm(eventId){
  const form=document.getElementById(`rsvpForm_${eventId}`);
  const btn=document.getElementById(`rsvpBtn_${eventId}`);
  if(!form.classList.contains("hidden")){form.classList.add("hidden");btn.textContent="üìù RSVP to this event";return;}
  form.classList.remove("hidden");btn.textContent="‚¨ÜÔ∏è Hide RSVP Form";
  form.innerHTML=`
  <form onsubmit="submitRSVP(event,${eventId})" class="rsvp-list">
  <label>Name*</label><input id="name_${eventId}" required>
  <label>Playing?*</label><select id="playing_${eventId}" required><option value="">Select</option><option value="yes">Yes</option><option value="no">No</option></select>
  <label>Need a buggy?*</label><select id="buggy_${eventId}" onchange="handleBuggyChange(${eventId})" required><option value="">Select</option><option value="yes">Yes</option><option value="no">No</option></select>
  <div id="buggyOptions_${eventId}" class="hidden">
  <label>Buggy preference</label><select id="flexibility_${eventId}"><option value="need">I need a buggy</option><option value="happy">Happy to walk if odd</option></select>
  <label>Phone number*</label><input id="phone_${eventId}" placeholder="07123 456789"><small>Your phone number will be visible to your buggy partner.</small></div>
  <button type="submit" class="admin-btn">Submit RSVP</button>
  <div id="rsvpMsg_${eventId}"></div></form><div id="rsvpList_${eventId}" style="margin-top:15px;"></div>`;
  loadRSVPList(eventId);
}

function handleBuggyChange(eventId){document.getElementById(`buggyOptions_${eventId}`).classList.toggle("hidden",document.getElementById(`buggy_${eventId}`).value!=="yes");}

async function submitRSVP(e,eventId){
  e.preventDefault();
  const name=document.getElementById(`name_${eventId}`).value.trim();
  const playing=document.getElementById(`playing_${eventId}`).value;
  const buggy=document.getElementById(`buggy_${eventId}`).value;
  const flex=buggy==="yes"?document.getElementById(`flexibility_${eventId}`).value:null;
  const phone=buggy==="yes"?document.getElementById(`phone_${eventId}`).value.trim():null;
  const msg=document.getElementById(`rsvpMsg_${eventId}`);
  if(!name||!playing||!buggy)return msg.textContent="‚ö†Ô∏è Fill all required fields.";
  if(buggy==="yes"&&!phone)return msg.textContent="‚ö†Ô∏è Enter phone number.";
  const attending=playing==="yes";
  await supabase.from("rsvps").insert([{event_id:eventId,name,attending,buggy:buggy==="yes",flexibility:flex,phone}]);
  msg.textContent="‚úÖ RSVP saved!";loadRSVPList(eventId);
}

async function loadRSVPList(eventId){
  const {data}=await supabase.from("rsvps").select("name,buggy,flexibility,attending").eq("event_id",eventId).eq("attending",true);
  const div=document.getElementById(`rsvpList_${eventId}`);
  if(!data?.length)return div.innerHTML="<em>No RSVPs yet.</em>";
  div.innerHTML="<h4>Players Attending</h4>"+data.map(p=>`<div>${p.buggy?"üõ∫":"üö∂"} ${p.name} ${p.flexibility==="happy"?"(Happy)":""}</div>`).join("");
}

async function loadTeeTimes(eventId){
  const area=document.getElementById(`teeTimes_${eventId}`);
  const {data}=await supabase.from("tee_times").select("*").eq("event_id",eventId).order("group_number",{ascending:true});
  if(!data?.length)return area.innerHTML="";
  let html="<h4>
  let html="<h4>‚õ≥ Tee Times</h4>";
  data.forEach(g=>{
    const buggy=g.players.filter(p=>p.type==="buggy");
    const walkers=g.players.filter(p=>p.type==="walker");
    html+=`<div class='group'><strong>Group ${g.group_number} ‚Äî ${g.tee_time}</strong><br>`;
    for(let i=0;i<buggy.length;i+=2){
      const p1=buggy[i];const p2=buggy[i+1];
      html+=`üõ∫ Pair ${(i/2)+1}: ${p1.name} (${p1.phone||""})${p2?" & "+p2.name+" ("+(p2.phone||"")+")":""}<br>`;
    }
    walkers.forEach(w=>html+=`üö∂ ${w.name}<br>`);
    html+="</div>";
  });
  area.innerHTML=html;
}

async function loadAdminPlayers(eventId){
  const pool=document.getElementById("playerPool");
  const {data}=await supabase.from("rsvps").select("name,buggy,flexibility,phone,attending").eq("event_id",eventId).eq("attending",true);
  if(!data?.length)return pool.innerHTML="<em>No RSVPs.</em>";
  pool.innerHTML=`<strong>Players loaded: ${data.length}</strong> <button class='admin-btn' onclick='generateTeeGroups(${eventId})'>‚öôÔ∏è Generate Tee Times</button>`;
  window.currentPlayers=data;
}

function generateTeeGroups(eventId){
  const area=document.getElementById("teeGroups");
  area.innerHTML="";
  const start=document.getElementById("startTime").value.trim();
  const gap=parseInt(document.getElementById("gapMins").value)||7;
  const rsvps=window.currentPlayers||[];
  if(!rsvps.length)return alert("No RSVPs.");

  let buggy=rsvps.filter(r=>r.buggy);
  let walkers=rsvps.filter(r=>!r.buggy);
  if(buggy.length%2!==0){
    const flex=buggy.find(r=>(r.flexibility||"").toLowerCase().includes("happy"));
    if(flex){walkers.push(flex);buggy=buggy.filter(b=>b.name!==flex.name);}
  }

  const shuffle=a=>a.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
  buggy=shuffle(buggy);walkers=shuffle(walkers);

  const groups=[];
  for(let i=0;i<buggy.length;i+=4)groups.push(buggy.slice(i,i+4));
  for(let i=0;i<walkers.length;i+=4)groups.push(walkers.slice(i,i+4));

  const addTime=(s,m)=>{
    let[t,a]=s.toLowerCase().split(/(am|pm)/).filter(Boolean);
    let[h,mm]=t.split(":").map(Number);
    if(a==="pm"&&h<12)h+=12;if(a==="am"&&h===12)h=0;
    const d=new Date();d.setHours(h);d.setMinutes(mm+m);
    const hr=d.getHours();const mi=String(d.getMinutes()).padStart(2,"0");
    const sfx=hr>=12?"pm":"am";const disp=((hr+11)%12)+1;
    return `${disp}:${mi}${sfx}`;
  };

  groups.forEach((group,i)=>{
    const teeTime=addTime(start,i*gap);
    const div=document.createElement("div");
    div.className="tee-group";
    div.dataset.teeTime=teeTime;
    div.innerHTML=`<strong>Group ${i+1}</strong> ‚Äî ${teeTime}<ul id="group_${i+1}" style="list-style:none;padding:0;margin-top:5px;"></ul><div class='pair-msg' id='pairMsg_${i+1}'></div>`;
    area.appendChild(div);
    const ul=div.querySelector("ul");

    group.forEach(p=>{
      const li=document.createElement("li");
      li.className="player-card";
      li.dataset.name=p.name;
      li.dataset.phone=p.phone||"";
      li.dataset.type=p.buggy?"buggy":"walker";
      const label=p.buggy?(p.flexibility==="happy"?" (Happy to walk if odd)":" (Needs buggy)"):"";
      li.innerHTML=`${p.buggy?"üõ∫":"üö∂"} ${p.name}${label}
        <button onclick="toggleType(this)" style="float:right;font-size:11px;padding:2px 6px;">üîÑ</button>`;
      ul.appendChild(li);
    });

    Sortable.create(ul,{
      group:"players",
      animation:150,
      onEnd:()=>checkPairs(i+1)
    });
  });

  alert("‚úÖ Tee times generated! Drag players to create buggy pairs.");
}

function checkPairs(groupNum){
  const ul=document.getElementById(`group_${groupNum}`);
  const lis=ul.querySelectorAll(".player-card");
  const msg=document.getElementById(`pairMsg_${groupNum}`);
  let paired=false;
  for(let i=0;i<lis.length-1;i++){
    const a=lis[i],b=lis[i+1];
    if(a.dataset.type==="buggy"&&b.dataset.type==="buggy"){
      msg.textContent="üõ∫ Pair Created";
      paired=true;break;
    }
  }
  if(!paired)msg.textContent="";
}

function toggleType(btn){
  const li=btn.closest(".player-card");
  const isBuggy=li.dataset.type==="buggy";
  li.dataset.type=isBuggy?"walker":"buggy";
  li.innerHTML=li.innerHTML.replace(isBuggy?"üõ∫":"üö∂",isBuggy?"üö∂":"üõ∫");
  li.appendChild(btn);
}

async function saveTeeTimes(){
  const eventId=document.getElementById("teeEventSelect").value;
  if(!eventId)return alert("Please select an event first.");
  const groups=document.querySelectorAll(".tee-group");
  if(!groups.length)return alert("Generate tee times first.");

  const data=Array.from(groups).map((g,i)=>{
    const players=Array.from(g.querySelectorAll(".player-card")).map(li=>({
      name:li.dataset.name,
      phone:li.dataset.phone||null,
      type:li.dataset.type
    }));
    return{
      event_id:eventId,
      group_number:i+1,
      tee_time:g.dataset.teeTime,
      players
    };
  });

  await supabase.from("tee_times").delete().eq("event_id",eventId);
  const {error}=await supabase.from("tee_times").insert(data);
  if(error){console.error(error);alert("‚ùå Error saving tee times.");}
  else{alert("‚úÖ Tee times saved successfully!");loadTeeTimes(eventId);}
}
</script>
</body>
</html>
