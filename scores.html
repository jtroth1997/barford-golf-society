<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scores & Handicap Calculator | Barford Golf Society</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- ‚úÖ Supabase connection -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ"; // üîë Replace with your real anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>

  <style>
    :root {
      --green: #005a2b;
      --gold: #d4af37;
      --cream: #f7f7f5;
      --dark-bg: #1e1e1e;
      --dark-card: #2a2a2a;
      --text-light: #f7f7f5;
    }

    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--cream) 40%, #e9f2e9);
      color: #1b1b1b;
      transition: background 0.4s, color 0.4s;
      overflow-x: hidden;
    }

    body.dark-mode {
      background: var(--dark-bg);
      color: var(--text-light);
    }

    .site-header {
      background: var(--green);
      color: var(--gold);
      padding: 15px 0;
      border-bottom: 3px solid var(--gold);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: auto;
      padding: 0 20px;
      flex-wrap: wrap;
    }

    .site-title {
      font-size: 1.5em;
      color: var(--gold);
      margin: 0;
    }

    .site-nav ul {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 0;
      padding: 0;
    }

    .site-nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }

    .site-nav a.active,
    .site-nav a:hover {
      color: var(--gold);
    }

    .leaderboard-banner {
      text-align: center;
      background: var(--gold);
      color: #1b1b1b;
      font-weight: 700;
      padding: 10px;
      border-bottom: 2px solid var(--green);
      font-size: 1rem;
    }

    .scores-container {
      max-width: 1200px;
      margin: 30px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: background 0.4s, color 0.4s;
    }

    body.dark-mode .scores-container {
      background: var(--dark-card);
      color: var(--text-light);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
    }

    header.calc-header {
      background: linear-gradient(to right, var(--green), #0a6b34);
      color: var(--gold);
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #fff;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    body.dark-mode .topbar {
      background: var(--dark-card);
      box-shadow: 0 3px 10px rgba(255, 255, 255, 0.05);
    }

    input[type=password],
    input[type=number] {
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.4);
      outline: none;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-unlock { background: var(--gold); color: #1b1b1b; }
    .btn-lock { background: var(--green); color: #fff; }
    .btn-calc { background: #ffcc00; color: #1b1b1b; }
    .btn-next, .btn-prev { background: #ddd; color: #1b1b1b; }
    .btn-reset { background: #b22222; color: #fff; }
    .btn-add { background: #c0c0c0; color: #1b1b1b; }
    .btn-pass { background: #cd7f32; color: #fff; }
    .btn-download { background: var(--green); color: var(--gold); }
    .btn-theme { background: none; border: 1px solid var(--gold); color: var(--gold); }

    main { padding: 20px; }

    #tableContainer {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
      min-width: 800px;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #f1f1f1;
    }

    th {
      background: var(--green);
      color: var(--gold);
      text-transform: uppercase;
    }

    tbody tr:nth-child(even) { background: #f8f8f8; }
    body.dark-mode tbody tr:nth-child(even) { background: #333; }

    footer {
      text-align: center;
      background: var(--green);
      color: var(--gold);
      padding: 20px;
      border-top: 4px solid var(--gold);
      margin-top: 40px;
    }

    @media (max-width: 768px) {
      html, body { width: 100%; overflow-x: hidden; }

      .header-container,
      .topbar {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        margin-bottom: 6px;
      }

      table {
        font-size: 0.85rem;
        min-width: 600px;
      }

      th, td { padding: 8px; }

      .leaderboard-banner {
        font-size: 0.9rem;
        padding: 8px;
      }

      header.calc-header {
        font-size: 1.4rem;
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="header-container">
      <h1 class="site-title">Barford Golf Society</h1>
      <nav class="site-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="events.html">Events</a></li>
          <li><a href="scores.html" class="active">Scores</a></li>
          <li><a href="admin.html">Admin</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div id="leaderboard" class="leaderboard-banner">üèåÔ∏è Leaderboard loading...</div>

  <div class="scores-container">
    <header class="calc-header">Golf Society Handicap Calculator</header>

    <div class="topbar">
      <input type="password" id="pwInput" placeholder="Enter password">
      <button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
      <button class="btn btn-lock" onclick="lockInputs()">Lock</button>
      <button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
      <button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
      <button class="btn btn-next" onclick="nextRound()">Next ‚ñ∂</button>
      <button class="btn btn-add" onclick="addPlayer()">+ Player</button>
      <button class="btn btn-pass" onclick="changePassword()">Change Password</button>
      <button class="btn btn-reset" id="resetBtn" onclick="confirmReset()">Reset League</button>
      <button class="btn btn-download" onclick="downloadCsv()">Download CSV</button>
      <button class="btn btn-theme" onclick="toggleTheme()">üåì</button>
    </div>

    <main>
      <div class="round-info">
        <h3 id="roundHeader">Round 1 of 7</h3>
      </div>
      <div id="tableContainer">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Round HCP</th>
              <th>Points</th>
              <th>Adj</th>
              <th>Next HCP</th>
              <th>Total (Best 5)</th>
              <th>DNP</th>
            </tr>
          </thead>
          <tbody id="playersTable"></tbody>
        </table>
      </div>
    </main>
  </div>

  <footer>
    <p>¬© 2025 Barford Golf Society | Scores & Handicap Calculator</p>
  </footer>

  <script>
    const PASSWORD = "westbrom1997";
    let unlocked = false;
    let currentRound = 1;
    const maxRounds = 7;
    let players = [
"Brad Davies","Will Lovell","Richard Jones","David Hardcastle","Tim Oliver","John Hawkes","Mike Cook","Colin Oliver",
"Gary Moyce","David Jordan","Nick Benbow","Simon Morgan","Wes Lacey","Chris Oliver","Burt Pickering","Chris Harris",
"Derek Lewis","Liz Oliver","Jack Moyce-Troth","Lucie Byerley","David Pritchard","Robert Pocknell","John Close","Nick Wright",
"Matt Oliver","Vince Hall","Elliot Hobbs","Will Hunt","Martc Taylor","Simon Meade","Emma Saywell","Cam Tolley",
"John Blackwell","Bekim","Zac Lovell","Clive Irwin"
];
    let playerScores = {};
    let currentHcp = {};
    let nextHcp = {};
    let lastAdj = {};

    if (localStorage.getItem('bgsTheme') === 'dark')
      document.body.classList.add('dark-mode');

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('bgsTheme',
        document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    function unlockInputs() {
      const pw = document.getElementById("pwInput").value;
      if (pw !== PASSWORD) return alert("Incorrect password!");
      unlocked = true;
      alert("‚úÖ Scores unlocked!");
      renderLeaderboard();
    }

    function lockInputs() {
      unlocked = false;
      alert("üîí Scores locked again.");
      renderLeaderboard();
    }

    function tryEditBlocked() {
      if (!unlocked) {
        alert("‚õî Stop trying to add your score ‚Äî it doesn‚Äôt change the fact you‚Äôre bad at golf!");
        return true;
      }
      return false;
    }

    async function preloadPlayersIfEmpty() {
      const { data, error } = await supabase.from('scores').select('id').limit(1);
      if (!error && (!data || data.length === 0)) {
        const preloadRows = players.map(name => ({
          player: name,
          round: 1,
          points: 0,
          handicap: 0,
          next_handicap: 0,
          adj: "",
          total: 0,
          dnp: false,
          date: new Date().toISOString()
        }));
        await supabase.from('scores').insert(preloadRows);
        console.log("‚úÖ Preloaded 36 players into Supabase");
      }
    }

    async function loadData() {
      await preloadPlayersIfEmpty();
      const { data, error } = await supabase.from('scores').select('*');
      if (error) return console.error("Load error:", error);
      const grouped = {};
      data.forEach(r => {
        if (!grouped[r.player]) grouped[r.player] = [];
        grouped[r.player][r.round - 1] = r.points;
      });
      playerScores = grouped;
      currentHcp = {};
      nextHcp = {};
      lastAdj = {};
      data.forEach(r => {
        currentHcp[r.player] = r.handicap || 0;
        nextHcp[r.player] = r.next_handicap || 0;
        lastAdj[r.player] = r.adj || "";
      });
      renderLeaderboard();
    }

    async function saveData() {
      const rows = [];
      for (const player of players) {
        for (let r = 1; r <= maxRounds; r++) {
          const pts = playerScores[player]?.[r - 1];
          if (pts != null) rows.push({
            player,
            round: r,
            points: pts,
            handicap: currentHcp[player] || 0,
            next_handicap: nextHcp[player] || 0,
            adj: lastAdj[player] || "",
            total: calculateTotals().find(p => p.name === player)?.total || 0,
            dnp: pts == null,
            date: new Date().toISOString()
          });
        }
      }
      await supabase.from('scores').upsert(rows);
      localStorage.setItem('golfScores', JSON.stringify(rows));
    }

    supabase.channel('realtime_scores')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'scores' }, payload => {
        console.log("üì° LIVE UPDATE:", payload);
        loadData();
      }).subscribe();

    function stablefordAdj(pts) {
      if (pts >= 43) return -3;
      if (pts >= 38) return -2;
      if (pts >= 31) return -1;
      if (pts >= 26) return 0;
      if (pts >= 21) return +1;
      if (pts >= 16) return +2;
      return +3;
    }

    function calculateTotals() {
      return players.map(name => {
        const scores = playerScores[name]?.filter(v => v != null) || [];
        const total = scores.sort((a, b) => b - a).slice(0, 5).reduce((a, b) => a + b, 0);
        return { name, total };
      }).sort((a, b) => b.total - a.total);
    }

    function updateLeaderboard() {
      const totals = calculateTotals();
      const lb = document.getElementById('leaderboard');
      if (totals.length)
        lb.textContent = `üèÜ Leader: ${totals[0].name} ‚Äî ${totals[0].total} pts | Round ${currentRound} of ${maxRounds}`;
      else lb.textContent = "üèåÔ∏è Leaderboard loading...";
    }

    function renderLeaderboard() {
      const tbody = document.getElementById("playersTable");
      tbody.innerHTML = "";
      const totals = calculateTotals();
      totals.forEach((p, rank) => {
        const player = p.name;
        const scoreVal = playerScores[player]?.[currentRound - 1] ?? "";
        const adj = lastAdj[player] || "";
        const next = nextHcp[player] ?? "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank === 0 ? "ü•á" : rank === 1 ? "ü•à" : rank === 2 ? "ü•â" : rank + 1}</td>
          <td>${player}</td>
          <td><input type="number" id="hcp_${player}" value="${currentHcp[player] || 0}" ${unlocked ? "" : "disabled"}></td>
          <td><input type="number" id="points_${player}" value="${scoreVal}" ${unlocked ? "" : "disabled"}></td>
          <td id="adj_${player}">${adj}</td>
          <td id="newHcp_${player}">${next}</td>
          <td id="season_${player}">${p.total}</td>
          <td><input type="checkbox" disabled ${scoreVal === "" ? "checked" : ""}></td>`;
        const pointInput = tr.querySelector(`#points_${player}`);
        if (pointInput) pointInput.addEventListener('click', () => { if (tryEditBlocked()) pointInput.blur(); });
        tbody.appendChild(tr);
      });
      updateLeaderboard();
    }

    async function calculateHandicaps() {
      if (!unlocked) return tryEditBlocked();
      const totals = calculateTotals();
      for (const player of players) {
        const hcpNow = parseFloat(document.getElementById(`hcp_${player}`).value) || 0;
        const pts = parseInt(document.getElementById(`points_${player}`).value);
        if (isNaN(pts)) continue;
        let adj = stablefordAdj(pts);
        const topScore = Math.max(...totals.map(t => playerScores[t.name][currentRound - 1] || 0));
        if (pts === topScore) adj -= 1;
        lastAdj[player] = (adj > 0 ? "+" : "") + adj;
        currentHcp[player] = hcpNow;
        nextHcp[player] = Math.max(0, Math.round(hcpNow + adj));
        playerScores[player][currentRound - 1] = pts;
      }
      await saveData();
      renderLeaderboard();
    }

    async function addPlayer() {
      if (!unlocked) return tryEditBlocked();
      const name = prompt("Enter new player name:");
      if (!name) return;
      players.push(name);
      playerScores[name] = Array(maxRounds).fill(null);
      currentHcp[name] = 0; nextHcp[name] = 0; lastAdj[name] = "";
      await saveData();
      renderLeaderboard();
    }

    function nextRound() {
      if (currentRound < maxRounds) {
        currentRound++;
        renderLeaderboard();
      }
    }

    function prevRound() {
      if (currentRound > 1) {
        currentRound--;
        renderLeaderboard();
      }
    }

    async function confirmReset() {
      const pw = prompt("Enter password to reset:");
      if (pw !== PASSWORD) return alert("Incorrect password!");
      await supabase.from('scores').delete().neq('id', 0);
      localStorage.removeItem('golfScores');
      loadData();
    }

    function downloadCsv() {
      const totals = calculateTotals();
      let csv = "Rank,Player,Round HCP,Points,Adj,Next HCP,Total (Best 5),DNP\n";
      totals.forEach((p, i) => {
        csv += `${i + 1},${p.name},${currentHcp[p.name] || 0},${playerScores[p.name][currentRound - 1] || ""},${lastAdj[p.name] || ""},${nextHcp[p.name] || 0},${p.total},\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "barford_scores.csv";
      link.click();
    }

    function changePassword() {
      const pw = prompt("Enter current password:");
      if (pw !== PASSWORD) return alert("Incorrect password!");
      const newPw = prompt("Enter new password:");
      if (!newPw) return alert("No password entered!");
      alert("Password changed (note: this only changes locally in code).");
    }

    // üöÄ Start app
    loadData();
  </script>
</body>
</html>
