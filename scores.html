<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scores & Handicap Calculator | Barford Golf Society</title>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Styles -->
  <style>
    :root {
      --green: #005a2b;
      --gold: #d4af37;
      --cream: #f7f7f5;
      --dark-bg: #1e1e1e;
      --dark-card: #2a2a2a;
      --text-light: #f7f7f5;
    }

    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--cream) 40%, #e9f2e9);
      color: #1b1b1b;
      overflow-x: hidden;
    }

    body.dark-mode {
      background: var(--dark-bg);
      color: var(--text-light);
    }

    /* Header */
    .site-header {
      background: var(--green);
      color: var(--gold);
      padding: 15px 0;
      border-bottom: 3px solid var(--gold);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: auto;
      padding: 0 20px;
    }

    .site-title {
      font-size: 1.6em;
      color: var(--gold);
      margin: 0;
    }

    .site-nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
      flex-wrap: wrap;
    }

    .site-nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .site-nav a.active,
    .site-nav a:hover {
      color: var(--gold);
    }

    /* Leaderboard banner */
    .leaderboard-banner {
      text-align: center;
      background: var(--gold);
      color: #1b1b1b;
      font-weight: 700;
      padding: 10px;
      border-bottom: 2px solid var(--green);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Container */
    .scores-container {
      max-width: 1200px;
      margin: 30px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    body.dark-mode .scores-container {
      background: var(--dark-card);
      color: var(--text-light);
    }

    /* Header within container */
    header.calc-header {
      background: linear-gradient(to right, var(--green), #0a6b34);
      color: var(--gold);
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* Top toolbar */
    .topbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #fff;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    body.dark-mode .topbar {
      background: var(--dark-card);
    }

    /* Inputs and buttons */
    input[type=password],
    input[type=number] {
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      width: 80px;
      font-size: 0.9rem;
    }

    input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.4);
      outline: none;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .btn-unlock { background: var(--gold); color: #1b1b1b; }
    .btn-lock { background: var(--green); color: #fff; }
    .btn-calc { background: #ffcc00; color: #1b1b1b; }
    .btn-next,
    .btn-prev { background: #ddd; color: #1b1b1b; }
    .btn-reset { background: #b22222; color: #fff; }
    .btn-add { background: #c0c0c0; color: #1b1b1b; }
    .btn-pass { background: #cd7f32; color: #fff; }
    .btn-download { background: var(--green); color: var(--gold); }
    .btn-theme {
      background: none;
      border: 1px solid var(--gold);
      color: var(--gold);
    }

    /* Table */
    main { padding: 20px; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      min-width: 700px;
    }

    th,
    td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #f1f1f1;
    }

    th {
      background: var(--green);
      color: var(--gold);
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    tbody tr:nth-child(even) { background: #f8f8f8; }

    /* Footer */
    footer {
      text-align: center;
      background: var(--green);
      color: var(--gold);
      padding: 20px;
      border-top: 4px solid var(--gold);
      margin-top: 40px;
      font-size: 0.9rem;
    }

    /* Mobile */
    @media (max-width: 768px) {
      table { font-size: 0.8rem; }
      .btn { font-size: 0.8rem; padding: 6px 8px; }
      .site-title { font-size: 1.3em; }
      header.calc-header { font-size: 1.4rem; }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="header-container">
      <h1 class="site-title">Barford Golf Society</h1>
      <nav class="site-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="events.html">Events</a></li>
          <li><a href="scores.html" class="active">Scores</a></li>
          <li><a href="admin.html">Admin</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="leaderboard-banner">üèåÔ∏è Leaderboard loading...</div>

  <!-- SCORES CONTAINER -->
  <div class="scores-container">
    <header class="calc-header">Golf Society Handicap Calculator</header>

    <!-- Toolbar -->
    <div class="topbar">
      <input type="password" id="pwInput" placeholder="Enter password" />
      <button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
      <button class="btn btn-lock" onclick="lockInputs()">Lock</button>
      <button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
      <button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
      <button class="btn btn-next" onclick="nextRound()">Next ‚ñ∂</button>
      <button class="btn btn-add" onclick="addPlayer()">+ Player</button>
      <button class="btn btn-reset" onclick="confirmReset()">Reset League</button>
      <button class="btn btn-download" onclick="downloadCsv()">Download CSV</button>
      <button class="btn btn-theme" onclick="toggleTheme()">üåì</button>
    </div>

    <!-- Main Content -->
    <main>
      <div class="round-info">
        <h3 id="roundHeader">Round 1 of 7</h3>
      </div>

      <div id="tableContainer">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>HCP</th>
              <th>Points</th>
              <th>Adj</th>
              <th>Next HCP</th>
              <th>Total (Best 5)</th>
              <th>DNP</th>
            </tr>
          </thead>
          <tbody id="playersTable"></tbody>
        </table>
      </div>
    </main>
  </div>

  <footer>
    <p>¬© 2025 Barford Golf Society | Scores & Handicap Calculator</p>
  </footer>

  <!-- SCRIPT START -->
  <script>
    const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const PASSWORD = "westbrom1997";
    const maxRounds = 7;
    let currentRound = 1;
    let unlocked = false;

    const players = [
      "Brad Davies","Will Lovell","Richard Jones","David Hardcastle","Tim Oliver",
      "John Hawkes","Mike Cook","Colin Oliver","Gary Moyce","David Jordan",
      "Nick Benbow","Simon Morgan","Wes Lacey","Chris Oliver","Burt Pickering",
      "Chris Harris","Derek Lewis","Liz Oliver","Jack Moyce-Troth","Lucie Byerley",
      "David Pritchard","Robert Pocknell","John Close","Nick Wright",
      "Matt Oliver","Vince Hall","Elliot Hobbs","Will Hunt","Martc Taylor",
      "Simon Meade","Emma Saywell","Cam Tolley","John Blackwell",
      "Bekim","Zac Lovell","Clive Irwin"
    ];

    let playerScores = {};
    let currentHcp = {};
    let nextHcp = {};
    let lastAdj = {};
    // Initialize data
    players.forEach(p => {
      playerScores[p] = Array(maxRounds).fill(0);
      currentHcp[p] = 0;
      nextHcp[p] = 0;
      lastAdj[p] = "";
    });

    // Load from Supabase
    async function loadData() {
      const { data, error } = await supabase.from("scores").select("*");
      if (error) return console.error("Error loading data:", error);

      if (data.length > 0) {
        data.forEach(row => {
          if (players.includes(row.player)) {
            currentHcp[row.player] = row.handicap || 0;
            nextHcp[row.player] = row.next_handicap || 0;
            playerScores[row.player][row.round - 1] = row.points || 0;
            lastAdj[row.player] = row.adj || "";
          }
        });
      } else {
        console.log("No data found in Supabase yet.");
      }

      renderLeaderboard();
    }

    // Save single player record to Supabase
    async function savePlayerToSupabase(player, round, points, handicap, next_handicap, adj, total, dnp) {
      const { error } = await supabase
        .from("scores")
        .upsert(
          { player, round, points, handicap, next_handicap, adj, total, dnp },
          { onConflict: ["player", "round"] }
        );
      if (error) console.error("Error saving player:", error);
    }

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem(
        "bgsTheme",
        document.body.classList.contains("dark-mode") ? "dark" : "light"
      );
    }
    if (localStorage.getItem("bgsTheme") === "dark")
      document.body.classList.add("dark-mode");

    // Locking and unlocking
    function unlockInputs() {
      const pw = document.getElementById("pwInput").value.trim();
      if (pw !== PASSWORD) {
        alert("Incorrect password!");
        return;
      }
      unlocked = true;
      alert("Scores unlocked");
      renderLeaderboard();
    }

    function lockInputs() {
      unlocked = false;
      alert("Scores locked");
      renderLeaderboard();
    }

    // Stableford adjustment
    function stablefordAdj(pts) {
      if (pts >= 43) return -3;
      if (pts >= 38) return -2;
      if (pts >= 31) return -1;
      if (pts >= 26) return 0;
      if (pts >= 21) return +1;
      if (pts >= 16) return +2;
      return +3;
    }

    // Calculate handicaps
    async function calculateHandicaps() {
      if (!unlocked)
        return alert("Stop trying to add your score ‚Äî it doesn‚Äôt change the fact you‚Äôre bad at golf!");

      let validScores = [];
      players.forEach(p => {
        const val = parseInt(document.getElementById(`points_${p}`).value);
        if (!isNaN(val)) validScores.push(val);
      });

      const topScore = validScores.length ? Math.max(...validScores) : null;

      players.forEach(async p => {
        const pts = parseInt(document.getElementById(`points_${p}`).value) || 0;
        const hcpNow = parseFloat(document.getElementById(`hcp_${p}`).value) || 0;

        const adjCell = document.getElementById(`adj_${p}`);
        const nxtCell = document.getElementById(`newHcp_${p}`);
        const totalCell = document.getElementById(`total_${p}`);
        const dnpBox = document.getElementById(`dnp_${p}`);

        if (pts === 0) {
          dnpBox.checked = true;
          lastAdj[p] = "";
          nextHcp[p] = hcpNow;
          adjCell.textContent = "";
          nxtCell.textContent = hcpNow;
          return;
        }

        dnpBox.checked = false;
        playerScores[p][currentRound - 1] = pts;

        let adj = stablefordAdj(pts);
        if (topScore !== null && pts === topScore) adj -= 1; // Bonus reduction for winner

        lastAdj[p] = (adj > 0 ? "+" : "") + adj;
        adjCell.textContent = lastAdj[p];

        const newH = Math.max(0, Math.round(hcpNow + adj));
        nextHcp[p] = newH;
        nxtCell.textContent = newH;

        const total = calculateTotalPoints(p);
        totalCell.textContent = total;

        await savePlayerToSupabase(p, currentRound, pts, hcpNow, newH, lastAdj[p], total, false);
      });

      updateLeaderboard();
    }

    // Calculate total (best 5 of 7)
    function calculateTotalPoints(player) {
      const scores = playerScores[player].filter(v => v > 0);
      if (scores.length === 0) return 0;
      const best5 = scores.sort((a, b) => b - a).slice(0, 5);
      return best5.reduce((a, b) => a + b, 0);
    }

    // Leaderboard update
    function updateLeaderboard() {
      const totals = players.map(p => ({
        name: p,
        total: calculateTotalPoints(p),
      }));
      totals.sort((a, b) => b.total - a.total);

      if (totals.length && totals[0].total > 0) {
        const leader = totals[0];
        document.getElementById(
          "leaderboard"
        ).textContent = `üèÜ Leader: ${leader.name} ‚Äî ${leader.total} pts | Round ${currentRound} of ${maxRounds}`;
      } else {
        document.getElementById("leaderboard").textContent =
          "üèåÔ∏è Leaderboard loading...";
      }
    }

    // Add player
    async function addPlayer() {
      const name = prompt("Enter new player name:");
      if (!name) return;

      if (players.includes(name)) return alert("Player already exists!");

      players.push(name);
      playerScores[name] = Array(maxRounds).fill(0);
      currentHcp[name] = 0;
      nextHcp[name] = 0;
      lastAdj[name] = "";

      await savePlayerToSupabase(name, 1, 0, 0, 0, "", 0, false);
      renderLeaderboard();
    }

    // Next / Previous round
    function nextRound() {
      if (currentRound < maxRounds) {
        players.forEach(p => {
          currentHcp[p] = nextHcp[p];
          lastAdj[p] = "";
        });
        currentRound++;
        renderLeaderboard();
      }
    }

    function prevRound() {
      if (currentRound > 1) {
        currentRound--;
        renderLeaderboard();
      }
    }

    // CSV download
    function downloadCsv() {
      let csv = "Player,Total (Best 5),Round,Points,Current HCP,Next HCP\n";
      players.forEach(p => {
        csv += `${p},${calculateTotalPoints(p)},${currentRound},${
          playerScores[p][currentRound - 1]
        },${currentHcp[p]},${nextHcp[p]}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "BarfordGolfScores.csv";
      a.click();
    }

    // Reset league
    async function confirmReset() {
      const pw = prompt("Enter password to reset the league:");
      if (pw !== PASSWORD) return alert("Incorrect password!");

      await supabase.from("scores").delete().neq("player", "");

      players.forEach(p => {
        playerScores[p] = Array(maxRounds).fill(0);
        currentHcp[p] = 0;
        nextHcp[p] = 0;
        lastAdj[p] = "";
      });

      currentRound = 1;
      unlocked = false;
      renderLeaderboard();
      alert("League reset successfully.");
    }

    // Render table
    function renderLeaderboard() {
      const tbody = document.getElementById("playersTable");
      tbody.innerHTML = "";

      const totals = players.map(p => ({
        name: p,
        total: calculateTotalPoints(p),
      }));
      totals.sort((a, b) => b.total - a.total);

      totals.forEach((p, rank) => {
        const pts = playerScores[p.name][currentRound - 1] || 0;
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${rank === 0 ? "ü•á" : rank === 1 ? "ü•à" : rank === 2 ? "ü•â" : rank + 1}</td>
          <td>${p.name}</td>
          <td><input type="number" id="hcp_${p.name}" value="${currentHcp[p.name]}" ${unlocked ? "" : "disabled"}></td>
          <td><input type="number" id="points_${p.name}" value="${pts}" ${unlocked ? "" : "disabled"}></td>
          <td id="adj_${p.name}">${lastAdj[p.name]}</td>
          <td id="newHcp_${p.name}">${nextHcp[p.name]}</td>
          <td id="total_${p.name}">${p.total}</td>
          <td><input type="checkbox" id="dnp_${p.name}" disabled ${pts === 0 ? "checked" : ""}></td>
        `;

        tbody.appendChild(tr);
      });

      document.getElementById("roundHeader").textContent = `Round ${currentRound} of ${maxRounds}`;
      updateLeaderboard();
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
