<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Barford Golf Society | Scores</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --green:#005a2b;--gold:#d4af37;--cream:#f7f7f5;--dark-bg:#1e1e1e;--dark-card:#2a2a2a;--text-light:#f7f7f5;
}
body{font-family:"Inter",sans-serif;margin:0;background:linear-gradient(135deg,var(--cream)40%,#e9f2e9);color:#1b1b1b;transition:.4s}
body.dark-mode{background:var(--dark-bg);color:var(--text-light)}
.site-header{background:var(--green);color:var(--gold);padding:15px 0;border-bottom:3px solid var(--gold)}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:auto;padding:0 20px;flex-wrap:wrap}
.site-title{font-size:1.5em;color:var(--gold);margin:0}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0}
.site-nav a{color:white;text-decoration:none;font-weight:600}
.site-nav a.active,.site-nav a:hover{color:var(--gold)}
.leaderboard-banner{text-align:center;background:var(--gold);color:#1b1b1b;font-weight:700;padding:10px;border-bottom:2px solid var(--green);transition:.4s}
.scores-container{position:relative;max-width:1200px;margin:30px auto;background:#fff;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.1);overflow:hidden;transition:.4s}
body.dark-mode .scores-container{background:var(--dark-card);color:var(--text-light)}
header.calc-header{background:linear-gradient(to right,var(--green),#0a6b34);color:var(--gold);text-align:center;padding:20px;font-size:1.8rem;font-weight:700}
.topbar{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;padding:16px;background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.05);position:sticky;top:0;z-index:20}
body.dark-mode .topbar{background:var(--dark-card)}
input[type=password],input[type=number]{border-radius:6px;border:1px solid #ccc;padding:8px;transition:.2s}
input:focus{border-color:var(--gold);box-shadow:0 0 5px rgba(212,175,55,.4);outline:none}
.btn{padding:8px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.25s;font-size:.9rem}
.btn:hover{transform:translateY(-2px);box-shadow:0 2px 8px rgba(0,0,0,.15)}
.btn-unlock{background:var(--gold);color:#1b1b1b}.btn-lock{background:var(--green);color:#fff}.btn-calc{background:#ffcc00;color:#1b1b1b}
.btn-next,.btn-prev{background:#ddd;color:#1b1b1b}.btn-download{background:var(--green);color:var(--gold)}
.btn-theme{background:none;border:1px solid var(--gold);color:var(--gold)}.btn-reset{background:#b30000;color:#fff}
main{padding:20px;overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;min-width:900px;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
body.dark-mode table{background:var(--dark-card)}
th,td{padding:12px;text-align:center;border-bottom:1px solid #f1f1f1}
th{background:var(--green);color:var(--gold);text-transform:uppercase;position:sticky;top:0;z-index:1}
tbody tr:nth-child(even){background:#f8f8f8}body.dark-mode tbody tr:nth-child(even){background:#333}
footer{text-align:center;background:var(--green);color:var(--gold);padding:20px;border-top:4px solid var(--gold);margin-top:40px}
.blur-overlay{position:absolute;top:220px;left:0;right:0;bottom:0;background:rgba(255,255,255,0.65);
backdrop-filter:blur(30px) brightness(1.2);display:none;justify-content:center;align-items:center;color:var(--green);
font-size:1.6rem;font-weight:700;text-align:center;border-radius:0 0 12px 12px;z-index:5;pointer-events:none}
.blur-overlay.active{display:flex;animation:fadeIn .5s ease forwards}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@media(max-width:768px){.header-container{flex-direction:column;gap:10px}.site-nav ul{flex-wrap:wrap;justify-content:center}
.btn{padding:6px 10px;font-size:.8rem}table{min-width:700px}th,td{padding:8px;font-size:.9rem}}
</style>
</head>
<body>
<header class="site-header"><div class="header-container">
<h1 class="site-title">Barford Golf Society</h1>
<nav class="site-nav"><ul><li><a href="index.html">Home</a></li><li><a href="events.html">Events</a></li>
<li><a href="scores.html" class="active">Scores</a></li></ul></nav></div></header>

<div id="leaderboard" class="leaderboard-banner">üèåÔ∏è Leaderboard loading...</div>
<div class="scores-container">
<header class="calc-header">Golf Society Handicap Calculator</header>
<div class="topbar">
<input type="password" id="pwInput" placeholder="Enter password">
<button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
<button class="btn btn-lock" onclick="lockInputs()">Lock</button>
<button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
<button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
<button class="btn btn-next" onclick="nextRound()">Next ‚ñ∂</button>
<button class="btn btn-download" onclick="downloadCsv()">Download CSV</button>
<button class="btn btn-theme" onclick="toggleTheme()">üåì</button>
<button class="btn btn-reset" onclick="resetSeason()">Reset Season</button>
</div>
<main><h3 id="roundHeader">Round 1 of 7</h3>
<table><thead><tr><th>Rank</th><th>Player</th><th id="hcpHeader">Round 1 HCP</th>
<th>Points</th><th>Adj</th><th>Next HCP</th><th>Total (Best 5)</th></tr></thead>
<tbody id="playersTable"></tbody></table></main>
<div id="blurOverlay" class="blur-overlay">üîí Scores hidden until unlocked</div></div>
<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://tzzkgfehtnuizamzlbgr.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
const PASSWORD="westbrom1997";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const maxRounds=7;
let currentRound=1,unlocked=false,players=[],startHcp=[],afterHcp=[],pointsHistory=[],adjHistory=[],pageReady=false;

const defaultPlayers=["Bekim","Brad Davies","Burt Pickering","Cam Tolley","Chris Harris","Chris Oliver","Clive Irwin","Colin Oliver","David Hardcastle","David Jordan","David Pritchard","Derek Lewis","Elliot Hobbs","Emma Saywell","Gary Moyce","John Blackwell","John Close","John Hawkes","Lucie Byerley","Liz Oliver","Martc Taylor","Matt Oliver","Mike Cook","Nick Benbow","Nick Wright","Richard Jones","Robert Pocknell","Simon Meade","Simon Morgan","Tim Oliver","Vince Hall","Wes Lacey","Will Hunt","Will Lovell","Zac Lovell"].sort((a,b)=>a.localeCompare(b));

async function ensurePlayersExist(){const{data,error}=await supabase.from("scores").select("player");if(error)return console.error(error);
const exist=data.map(r=>r.player);const ins=defaultPlayers.filter(n=>!exist.includes(n)).map(n=>({player:n,handicap:0,points:0,next_handicap:0,adj:0,total:0,updated_at:new Date().toISOString()}));
if(ins.length)await supabase.from("scores").insert(ins);}

function toggleTheme(){document.body.classList.toggle("dark-mode");
localStorage.setItem("bgsTheme",document.body.classList.contains("dark-mode")?"dark":"light");}
if(localStorage.getItem("bgsTheme")==="dark")document.body.classList.add("dark-mode");

async function loadPlayers(){const{data,error}=await supabase.from("scores").select("*").order("id",{ascending:true});
if(error)return console.error(error);if(!data)return;
players=data.map(r=>r.player);
startHcp=players.map(()=>Array(maxRounds).fill(0));
afterHcp=players.map(()=>Array(maxRounds).fill(0));
pointsHistory=players.map(()=>Array(maxRounds).fill(null));
adjHistory=players.map(()=>Array(maxRounds).fill(""));
renderTable();}

function unlockInputs(){const p=document.getElementById("pwInput").value;if(p!==PASSWORD)return alert("Incorrect password!");
unlocked=true;renderTable();updateBlur();}
function lockInputs(){unlocked=false;renderTable();updateBlur();}
function stablefordAdj(p){if(p>=43)return-3;if(p>=38)return-2;if(p>=31)return-1;if(p>=26)return 0;if(p>=21)return 1;if(p>=16)return 2;return 3;}

async function calculateHandicaps(){if(!unlocked)return alert("Locked!");
for(let i=0;i<players.length;i++){const s=parseFloat(document.getElementById(`hcp_${i}`).value)||0;
const pts=parseInt(document.getElementById(`pts_${i}`).value);if(isNaN(pts))continue;
const adj=stablefordAdj(pts),next=Math.max(0,s+adj);
if(!startHcp[i][currentRound-1])startHcp[i][currentRound-1]=s;
afterHcp[i][currentRound-1]=next;pointsHistory[i][currentRound-1]=pts;adjHistory[i][currentRound-1]=(adj>0?"+":"")+adj;
if(currentRound<maxRounds&&startHcp[i][currentRound]===0)startHcp[i][currentRound]=next;
await supabase.from("round_entries").upsert({player:players[i],round:currentRound,hcp:s,points:pts,adj:adj,next_hcp:next,updated_at:new Date().toISOString()},{onConflict:["player","round"]});
await supabase.from("scores").update({points:pts,adj:adj,next_handicap:next,updated_at:new Date().toISOString()}).eq("player",players[i]);}
renderTable();}

function calculateTotals(){return players.map((n,i)=>{const s=pointsHistory[i].filter(v=>v!==null);
const total=s.sort((a,b)=>b-a).slice(0,5).reduce((a,b)=>a+b,0);return{i,name:n,total};}).sort((a,b)=>b.total-a.total);}

function renderTable(){const tb=document.getElementById("playersTable");tb.innerHTML="";
const totals=calculateTotals();document.getElementById("hcpHeader").textContent=`Round ${currentRound} HCP`;
totals.forEach((p,r)=>{const i=p.i,s=startHcp[i][currentRound-1]||0,pt=pointsHistory[i][currentRound-1]??"",ad=adjHistory[i][currentRound-1]||"",nx=afterHcp[i][currentRound-1]||"";
const tr=document.createElement("tr");tr.innerHTML=`<td>${r+1}</td><td>${p.name}</td>
<td><input type="number" id="hcp_${i}" value="${s}" ${unlocked?"":"readonly"}></td>
<td><input type="number" id="pts_${i}" value="${pt}" ${unlocked?"":"readonly"}></td><td>${ad}</td><td>${nx}</td><td>${p.total}</td>`;tb.appendChild(tr);});
const lb=document.getElementById("leaderboard");const tNow=calculateTotals();
if(tNow.length){const lead=tNow[0];lb.textContent=`üèÜ Leader: ${lead.name} ‚Äî ${lead.total} pts | Round ${currentRound}/${maxRounds}`;}
document.getElementById("roundHeader").textContent=`Round ${currentRound} of ${maxRounds}`;updateBlur();}

function updateBlur(){const o=document.getElementById("blurOverlay"),lb=document.getElementById("leaderboard");
if(currentRound>=6&&!unlocked){o.classList.add("active");lb.style.opacity="0.3";lb.style.filter="blur(4px)";}
else{o.classList.remove("active");lb.style.opacity="1";lb.style.filter="none";}}

function nextRound(){if(currentRound<maxRounds){currentRound++;renderTable();}}
function prevRound(){if(currentRound>1){currentRound--;renderTable();}}

async function resetSeason(){const pw=prompt("Enter password to reset season:");if(pw!==PASSWORD)return alert("Incorrect password");
if(!confirm("Clear all scores?"))return;
await supabase.from("scores").update({handicap:0,points:0,next_handicap:0,adj:0,total:0});
await supabase.from("round_entries").delete().neq("id",0);
alert("Season reset!");location.reload();}

function downloadCsv(){let csv="Player,Total,Round,Points,HCP,Next HCP\n";
for(let i=0;i<players.length;i++){csv+=`${players[i]},${calculateTotals().find(p=>p.name===players[i])?.total||0},${currentRound},${pointsHistory[i][currentRound-1]||""},${startHcp[i][currentRound-1]||""},${afterHcp[i][currentRound-1]||""}\n`;}
const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");
a.href=URL.createObjectURL(blob);a.download="BarfordGolfScores.csv";a.click();}

function delayedReload(){if(!pageReady)return;if(window.reloadTimeout)clearTimeout(window.reloadTimeout);
window.reloadTimeout=setTimeout(()=>{console.log("üîÅ Reloading data...");loadPlayers();},1000);}

const ch1=supabase.channel("scores-changes").on("postgres_changes",{event:"*",schema:"public",table:"scores"},p=>{console.log("scores:",p);delayedReload();}).subscribe(s=>console.log("Scores Channel:",s));
const ch2=supabase.channel("rounds-changes").on("postgres_changes",{event:"*",schema:"public",table:"round_entries"},p=>{console.log("rounds:",p);delayedReload();}).subscribe(s=>console.log("Rounds Channel:",s));

(async()=>{await ensurePlayersExist();await loadPlayers();pageReady=true;})();
</script>
</body>
</html>
