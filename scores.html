<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barford Golf Society Handicap Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --green: #083d0b;
      --gold: #d4af37;
      --cream: #f7f7f5;
      --dark: #1b1b1b;
      --white: #ffffff;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
      --highlight: #e9f5ec;
    }
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, var(--cream) 40%, #e7ece7);
      color: var(--dark);
      margin: 0;
      padding: 0;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background: linear-gradient(to right, var(--green), #145214);
      color: var(--gold);
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    .navbar {
      display: flex;
      justify-content: center;
      gap: 30px;
      background: var(--white);
      padding: 12px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .navbar a {
      color: var(--green);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
    }
    .navbar a:hover {
      color: var(--gold);
    }
    .dark-mode { background: #121212; color: var(--gold); }
    .dark-mode header { background: #000; color: var(--gold); }
    .dark-mode .navbar { background: #000; }
    .dark-mode .navbar a { color: var(--gold); }
    .dark-mode .navbar a:hover { color: #fff; }
    .dark-toggle {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dark-toggle input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .topbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: var(--white);
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    input[type=password], input[type=number] {
      font-family: inherit;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      transition: border 0.2s, box-shadow 0.2s;
    }
    input[type=password]:focus, input[type=number]:focus {
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212,175,55,0.4);
      outline: none;
    }
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 0.9rem;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .btn:active { transform: scale(0.98); }
    .btn-unlock { background: var(--gold); color: var(--dark); }
    .btn-lock { background: var(--green); color: var(--white); }
    .btn-calc { background: #ffcc00; color: var(--dark); }
    .btn-next, .btn-prev { background: #ddd; color: var(--dark); }
    .btn-reset { background: #b22222; color: var(--white); }
    .btn-add { background: var(--silver); color: var(--dark); }
    .btn-pass { background: var(--bronze); color: var(--white); }
    .btn-export { background: var(--gold); color: var(--dark); }
    main { padding:20px; max-width:1100px; margin:auto; transition:color 0.3s,background 0.3s; }
    .round-info{text-align:center;margin-bottom:15px;font-weight:600;color:var(--green);}
    .progress-bar{width:80%;height:10px;background:#ddd;border-radius:10px;margin:8px auto 20px;overflow:hidden;}
    .progress-bar div{height:100%;width:0%;background:var(--gold);transition:width 0.5s ease;}
    table{width:100%;border-collapse:collapse;background:var(--white);border-radius:12px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,0.1);transition:background 0.3s,color 0.3s;}
    th,td{padding:12px;text-align:center;border-bottom:1px solid #f1f1f1;}
    th{background:var(--green);color:var(--gold);text-transform:uppercase;letter-spacing:0.5px;font-size:0.9rem;}
    tbody tr:nth-child(even){background:#f8f8f8;}
    tbody tr:hover{background:var(--highlight);}
    .dark-mode table{background:#1f1f1f;color:var(--gold);}
    .dark-mode th{background:#000;color:var(--gold);}
    #chartContainer{display:none;margin-top:40px;padding:20px;background:var(--white);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,0.1);}
    .dark-mode #chartContainer{background:#1f1f1f;}
    #toast{position:fixed;bottom:20px;right:20px;background:var(--green);color:var(--gold);padding:10px 20px;border-radius:8px;opacity:0;transition:opacity 0.4s;}
    .table-secret { position: relative; }
    .table-secret .secret-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z‚Äëindex: 10; pointer‚Äëevents: none; }
    .table-secret tbody { filter: blur(6px); pointer‚Äëevents: none; user‚Äëselect: none; }
    .table-secret tbody input { color: transparent; text‚Äëshadow: 0 0 8px rgba(0,0,0,0.2); }

    #secretNotice { text-align: center; padding: 8px; color: #b22222; font-weight: 700; display: none; }

    /* avatar initials */
    .player-avatar {
      display: inline-flex;
      width: 32px;
      height: 32px;
      margin-right: 8px;
      background: var(--silver);
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
      vertical-align: middle;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 40px;
    }
    .stats-card {
      background: var(--white);
      padding:16px;
      border-radius:12px;
      box-shadow:0 4px 14px rgba(0,0,0,0.1);
      transition:background 0.3s, color 0.3s;
    }
    .dark-mode .stats-card { background:#1f1f1f; color:var(--gold); }

    @media (max-width: 900px) {
      .topbar { flex-wrap: wrap; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
    }
    @media(max-width:700px){
      th,td{font-size:12px;padding:8px;}
      .btn{font-size:0.8rem;padding:6px 10px;}
    }
  </style>
</head>
<body>
  <header>
    üèåÔ∏è Barford Golf Society Handicap Calculator
    <div class="dark-toggle">
      <label for="darkSwitch">Dark Mode</label>
      <input type="checkbox" id="darkSwitch">
    </div>
  </header>
  <div class="navbar">
    <a href="index.html">Home</a>
    <a href="events.html">Events</a>
    <a href="scores.html">Scores</a>
    <a href="admin.html">Admin</a>
  </div>
  <div class="topbar">
    <input type="password" id="pwInput" placeholder="Enter password">
    <button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
    <button class="btn btn-lock" onclick="lockInputs()">Lock</button>
    <button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
    <button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
    <button class="btn btn-next" id="nextBtn" onclick="nextRound()">Next ‚ñ∂</button>
    <button class="btn btn-add" onclick="addPlayer()">+ Player</button>
    <button class="btn btn-pass" onclick="changePassword()">Change Password</button>
    <button class="btn btn-reset" id="clearLeagueBtn" style="display:none" onclick="confirmReset()">Clear League</button>
    <button class="btn btn-export" id="exportLeaderboardBtn" style="display:none" onclick="exportLeaderboardCSV()">Export Leaderboard (CSV)</button>
    <button class="btn btn-export" id="exportAllBtn" style="display:none" onclick="exportAllCSV()">Export All (CSV)</button>
    <button class="btn btn-export" id="exportStatsBtn" style="display:none" onclick="exportStatsCSV()">Export Stats (CSV)</button>
  </div>
  <main>
    <div class="round-info">
      <h3 id="roundHeader">Round 1 of 7</h3>
      <div class="progress-bar"><div id="progressFill"></div></div>
    </div>
    <div id="tableContainer">
      <div id="secretNotice">Round locked ‚Äî unlock to view/edit this round</div>
      <table id="playersTableWrap" class="">
        <thead>
          <tr>
            <th>Rank</th><th>Player</th><th id="hcpHeader">Round 1 HCP</th><th>Points</th>
            <th>Adj</th><th id="newHcpHeader">Next HCP</th><th>Total (Best‚ÄØ5)</th><th>DNP</th><th>üèÜ</th>
          </tr>
        </thead>
        <tbody id="playersTable"></tbody>
      </table>
    </div>
    <div id="chartContainer">
      <h3 style="text-align:center;color:var(--green)">Handicap Progression</h3>
      <canvas id="hcpChart"></canvas>
    </div>

    <!-- Player Stats Grid -->
    <div id="statsGrid" class="stats-grid"></div>

  </main>
  <div id="toast"></div>
  <script>
    const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
    const PASSWORD_DEFAULT = "westbrom1997";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let PASSWORD = PASSWORD_DEFAULT;
    let unlocked = false;
    let currentRound = 1;
    const maxRounds = 7;
    let players = [], currentHcp = [], nextHcp = [], playerScores = [], lastAdj = [], trophies = [];
    let realtimeChannel = null;

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.opacity = 1;
      setTimeout(() => (t.style.opacity = 0), 2500);
    }

    function stablefordAdj(pts) {
      if (pts >= 43) return -3;
      if (pts >= 38) return -2;
      if (pts >= 31) return -1;
      if (pts >= 26) return 0;
      if (pts >= 21) return +1;
      if (pts >= 16) return +2;
      return +3;
    }

    async function loadData() {
  document.body.style.cursor = "wait";

  // 1. Pull roster
  const { data: playerData, error: playerErr } =
    await supabase.from("players").select("name").order("name", { ascending: true });
  if (playerErr) {
    console.error("Error loading players:", playerErr);
    document.body.style.cursor = "default";
    return;
  }
  players = playerData.map(p => p.name);

  // 2. Pull all score data
  const { data, error } = await supabase
    .from("scores")
    .select("*")
    .order("player", { ascending: true })
    .order("round", { ascending: true });
  if (error) {
    console.error("Error loading scores:", error);
    document.body.style.cursor = "default";
    return;
  }

  // Initialize arrays based on full roster
  currentHcp = players.map(() => 0);
  nextHcp    = players.map(() => null);
  trophies   = players.map(() => 0);
  lastAdj    = players.map(() => "");
  playerScores = players.map(() => Array(maxRounds).fill(null));

  // Populate from score rows
  players.forEach((playerName, i) => {
    const rounds = data.filter(r => r.player === playerName);
    rounds.forEach(r => {
      const idx = r.round - 1;
      playerScores[i][idx] = r.points;
      if (r.next_handicap != null) nextHcp[i] = r.next_handicap;
      if (r.handicap != null)    currentHcp[i] = r.handicap;
      if (r.adj != null)         lastAdj[i] = (r.adj > 0 ? "+" : "") + r.adj;
    });
  });

  // Determine trophies
  for (let roundNum = 1; roundNum <= maxRounds; roundNum++) {
    let maxPts = -Infinity;
    let winnerIdx = -1;
    players.forEach((_, i) => {
      const pts = playerScores[i][roundNum - 1];
      if (pts != null && pts > maxPts) {
        maxPts = pts;
        winnerIdx = i;
      }
    });
    if (winnerIdx >= 0) {
      trophies[winnerIdx]++;
    }
  }

  renderLeaderboard();
  renderStatsGrid();
  subscribeRealtime();
  document.body.style.cursor = "default";
}

    function subscribeRealtime() {
      if (realtimeChannel) supabase.removeChannel(realtimeChannel);
      realtimeChannel = supabase
        .channel("public:scores")
        .on("postgres_changes", { event: "*", schema: "public", table: "scores" }, payload => {
          console.log("Realtime update:", payload);
          loadData();
        })
        .subscribe(status => {
          if (status === "SUBSCRIBED") console.log("‚úÖ Realtime connected");
        });
    }

    async function saveData() {
      const updates = [];
      for (let i = 0; i < players.length; i++) {
        const player = players[i];
        const total = playerScores[i]
          .filter(v => v !== null)
          .sort((a,b) => b - a)
          .slice(0,5)
          .reduce((a,b) => a + b, 0);
        const pts = playerScores[i][currentRound - 1] ?? 0;
        const adj = parseInt(lastAdj[i]) || 0;
        const next = nextHcp[i] ?? currentHcp[i];
        const mvpFlag = false; // Optionally set true for round winner
        updates.push({
          player,
          round: currentRound,
          handicap: currentHcp[i],
          points: pts,
          adj: adj,
          next_handicap: next,
          total,
          mvp: mvpFlag,
          trophies: trophies[i],
          updated_at: new Date().toISOString()
        });
      }
      const { error } = await supabase.from("scores").upsert(updates, { onConflict: ["player","round"] });
      if (error) {
        console.error(error);
        showToast("‚ö†Ô∏è Error saving data");
      } else {
        showToast("‚úÖ Data saved to Supabase");
      }
    }

    function calculateHandicaps() {
      if (!unlocked) return alert("Unlock first");
      for (let i = 0; i < players.length; i++) {
        const hcp = parseFloat(document.getElementById(`hcp_${i}`).value) || 0;
        const pts = parseInt(document.getElementById(`points_${i}`).value);
        if (isNaN(pts)) continue;
        const adj = stablefordAdj(pts);
        const next = Math.max(0, hcp + adj);
        playerScores[i][currentRound - 1] = pts;
        lastAdj[i] = (adj > 0 ? "+" : "") + adj;
        currentHcp[i] = hcp;
        nextHcp[i] = next;
      }

      const roundPts = players.map((_, i) => playerScores[i][currentRound - 1] ?? -1);
      const maxPts = Math.max(...roundPts);
      const winners = roundPts.map((p,i) => p === maxPts ? i : -1).filter(i => i >= 0);
      if (winners.length === 1) {
        trophies[winners[0]] += 1;
      }

      renderLeaderboard();
      renderStatsGrid();
      saveData();
      drawChart();
    }

    function calculateTotals() {
      return players.map((n, i) => {
        const s = playerScores[i].filter(v => v !== null);
        const total = s.sort((a,b) => b - a).slice(0,5).reduce((a,b) => a + b, 0);
        return { i, name: n, total };
      }).sort((a,b) => b.total - a.total);
    }

    function renderLeaderboard() {
      const tbody = document.getElementById("playersTable");
      tbody.innerHTML = "";
      const totals = calculateTotals();
      totals.forEach((p, rank) => {
        const i = p.i;
        const initials = players[i].split(" ").map(w => w.charAt(0)).join("");
        const avatarHTML = `<span class="player-avatar">${initials}</span>`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank===0?"ü•á":rank===1?"ü•à":rank===2?"ü•â":rank+1}</td>
          <td>${avatarHTML}${p.name}</td>
          <td><input type="number" id="hcp_${i}" value="${currentHcp[i]}" ${unlocked?"":"disabled"}></td>
          <td><input type="number" id="points_${i}" value="${playerScores[i][currentRound-1] ?? ""}" ${unlocked?"":"disabled"}></td>
          <td>${lastAdj[i]}</td>
          <td>${nextHcp[i] ?? ""}</td>
          <td>${p.total}</td>
          <td><input type="checkbox" disabled ${playerScores[i][currentRound-1] == null ? "checked" : ""}></td>
          <td>üèÜ ${trophies[i]}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById("hcpHeader").textContent = `Round ${currentRound} HCP`;
      document.getElementById("roundHeader").textContent = `Round ${currentRound} of ${maxRounds}`;
      document.getElementById("progressFill").style.width = (currentRound / maxRounds * 100) + "%";
      document.getElementById("chartContainer").style.display = unlocked ? "block" : "none";
      document.getElementById("exportLeaderboardBtn").style.display = unlocked ? "inline‚Äëblock" : "none";
      document.getElementById("exportAllBtn").style.display = unlocked ? "inline‚Äëblock" : "none";
      document.getElementById("exportStatsBtn").style.display = unlocked ? "inline‚Äëblock" : "none";
      document.getElementById("clearLeagueBtn").style.display = unlocked ? "inline‚Äëblock" : "none";

      const wrap = document.getElementById("playersTableWrap");
      const secretNotice = document.getElementById("secretNotice");
      if ((currentRound === 6 || currentRound === 7) && !unlocked) {
        wrap.classList.add("table‚Äësecret");
        wrap.classList.remove("unlocked");
        secretNotice.style.display = "block";
      } else {
        wrap.classList.remove("table‚Äësecret");
        wrap.classList.add("unlocked");
        secretNotice.style.display = "none";
      }
    }

    function nextRound() {
      if (!unlocked) return alert("Unlock first");
      if (currentRound < maxRounds) {
        for (let i = 0; i < players.length; i++) {
          currentHcp[i] = nextHcp[i] ?? currentHcp[i];
          lastAdj[i] = "";
        }
        currentRound++;
        calculateHandicaps();
        renderLeaderboard();
      }
    }

    function prevRound() {
      if (!unlocked) return alert("Unlock first");
      if (currentRound > 1) {
        currentRound--;
        renderLeaderboard();
      }
    }

    function unlockInputs() {
      const pw = document.getElementById("pwInput").value;
      if (pw !== PASSWORD) return alert("Wrong password");
      unlocked = true;
      renderLeaderboard();
      showToast("Unlocked");
    }

    function lockInputs() {
      unlocked = false;
      renderLeaderboard();
      showToast("Locked");
    }

    function addPlayer() {
      if (!unlocked) return alert("Unlock first");
      const name = prompt("Enter player name:");
      if (!name) return;
      players.push(name);
      currentHcp.push(0);
      nextHcp.push(null);
      playerScores.push(Array(maxRounds).fill(null));
      lastAdj.push("");
      trophies.push(0);
      saveData();
      renderLeaderboard();
      renderStatsGrid();
    }

    function changePassword() {
      const oldPw = prompt("Enter current password:");
      if (oldPw !== PASSWORD) return alert("Incorrect password");
      const newPw = prompt("Enter new password:");
      if (newPw) {
        PASSWORD = newPw;
        alert("Password changed!");
      }
    }

    async function confirmReset() {
      const pw = prompt("Enter password to clear the league:");
      if (pw !== PASSWORD) return alert("Incorrect password");
      if (!confirm("This will erase all rounds and reset the league ‚Äî continue?")) return;

      document.body.style.cursor = "wait";

      try {
        const { error } = await supabase.rpc('reset_scores');
        if (error) throw error;

        alert("‚úÖ League reset successfully!");
        currentRound = 1;
        await loadData();
        showToast("League reset complete");
      } catch (err) {
        console.error(err);
        alert("‚ùå Error resetting league. Check console for details.");
      } finally {
        document.body.style.cursor = "default";
      }
    }

    function toCSV(arr) {
      return arr.map(r => Object.values(r).map(v => `${v ?? ""}`).join(",")).join("\n");
    }

    async function exportAllCSV() {
      const { data, error } = await supabase.from("scores").select("*");
      if (error) return alert("Error fetching data");
      const csv = toCSV(data);
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      const d = new Date().toISOString().split("T")[0];
      link.href = URL.createObjectURL(blob);
      link.download = `barford_full_${d}.csv`;
      link.click();
    }

    function exportLeaderboardCSV() {
      const totals = calculateTotals();
      const rows = totals.map(p => ({ Rank: p.i+1, Player: p.name, Total: p.total, Trophies: trophies[p.i] }));
      const csv = toCSV(rows);
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      const d = new Date().toISOString().split("T")[0];
      link.href = URL.createObjectURL(blob);
      link.download = `barford_leaderboard_${d}.csv`;
      link.click();
    }

    function renderStatsGrid() {
      const container = document.getElementById("statsGrid");
      container.innerHTML = "";
      players.forEach((name, i) => {
        const rounds = playerScores[i].filter(v => v !== null);
        const avg = rounds.length ? (rounds.reduce((a,b)=>a+b,0)/rounds.length).toFixed(1) : "-";
        const best = rounds.length ? Math.max(...rounds) : "-";
        const worst = rounds.length ? Math.min(...rounds) : "-";
        const played = rounds.length;
        const card = document.createElement("div");
        card.classList.add("stats-card");
        card.innerHTML = `<h4>${name}</h4>
          <p>Rounds Played: ${played}</p>
          <p>Average Points: ${avg}</p>
          <p>Best Round: ${best}</p>
          <p>Worst Round: ${worst}</p>
          <p>Trophies Won: üèÜ ${trophies[i]}</p>`;
        container.appendChild(card);
      });
    }

    function exportStatsCSV() {
      const rows = players.map((name, i) => {
        const rounds = playerScores[i].filter(v => v!==null);
        const avg = rounds.length ? (rounds.reduce((a,b)=>a+b,0)/rounds.length).toFixed(1) : "";
        const best = rounds.length ? Math.max(...rounds) : "";
        const worst = rounds.length ? Math.min(...rounds) : "";
        const played = rounds.length;
        return { Player: name, Rounds: played, AvgPoints: avg, Best: best, Worst: worst, Trophies: trophies[i] };
      });
      const csv = toCSV(rows);
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      const d = new Date().toISOString().split("T")[0];
      link.href = URL.createObjectURL(blob);
      link.download = `barford_stats_${d}.csv`;
      link.click();
    }

    let chart;
    function drawChart() {
      if (!unlocked) return;
      const ctx = document.getElementById("hcpChart").getContext("2d");
      const labels = Array.from({ length: maxRounds }, (_, i) => "R" + (i+1));
      const datasets = players.map((p,i) => ({
        label: p,
        data: playerScores[i].map((pts, r) => {
          return r < currentRound ? (nextHcp[i] ?? currentHcp[i]) : null;
        }),
        borderWidth: 2,
        fill: false,
        borderColor: `hsl(${i * 60}, 60%, 40%)`
      }));
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });
    }

    const switchBtn = document.getElementById("darkSwitch");
    switchBtn.addEventListener("change", () => {
      document.body.classList.toggle("dark-mode", switchBtn.checked);
      localStorage.setItem("darkMode", switchBtn.checked ? "on" : "off");
    });
    if (localStorage.getItem("darkMode") === "on") {
      document.body.classList.add("dark-mode");
      switchBtn.checked = true;
    }

    loadData();
  </script>
</body>
</html>
