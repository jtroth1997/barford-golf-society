<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scores & Handicap Calculator | Barford Golf Society</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --green: #005a2b;
      --gold: #d4af37;
      --cream: #f7f7f5;
      --dark-bg: #1e1e1e;
      --dark-card: #2a2a2a;
      --text-light: #f7f7f5;
    }

    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--cream) 40%, #e9f2e9);
      color: #1b1b1b;
      transition: background 0.4s, color 0.4s;
    }

    body.dark-mode {
      background: var(--dark-bg);
      color: var(--text-light);
    }

    .site-header {
      background: var(--green);
      color: var(--gold);
      padding: 15px 0;
      border-bottom: 3px solid var(--gold);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: auto;
      padding: 0 20px;
    }

    .site-title {
      font-size: 1.5em;
      color: var(--gold);
      margin: 0;
    }

    .site-nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    .site-nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }

    .site-nav a.active, .site-nav a:hover {
      color: var(--gold);
    }

    .leaderboard-banner {
      text-align: center;
      background: var(--gold);
      color: #1b1b1b;
      font-weight: 700;
      padding: 10px;
      border-bottom: 2px solid var(--green);
      position: relative;
      z-index: 2;
    }

    .scores-container {
      max-width: 1200px;
      margin: 30px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: background 0.4s, color 0.4s;
      position: relative;
    }

    body.dark-mode .scores-container {
      background: var(--dark-card);
      color: var(--text-light);
      box-shadow: 0 4px 15px rgba(255,255,255,0.1);
    }

    header.calc-header {
      background: linear-gradient(to right, var(--green), #0a6b34);
      color: var(--gold);
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .topbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      background: #fff;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    body.dark-mode .topbar {
      background: var(--dark-card);
      box-shadow: 0 3px 10px rgba(255,255,255,0.05);
    }

    input[type=password], input[type=number] {
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212,175,55,0.4);
      outline: none;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .btn-unlock { background: var(--gold); color: #1b1b1b; }
    .btn-lock { background: var(--green); color: #fff; }
    .btn-calc { background: #ffcc00; color: #1b1b1b; }
    .btn-next, .btn-prev { background: #ddd; color: #1b1b1b; }
    .btn-reset { background: #b22222; color: #fff; }
    .btn-add { background: #c0c0c0; color: #1b1b1b; }
    .btn-pass { background: #cd7f32; color: #fff; }
    .btn-download { background: var(--green); color: var(--gold); }
    .btn-theme { background: none; border: 1px solid var(--gold); color: var(--gold); }

    main { padding: 20px; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow-x: auto;
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }

    body.dark-mode table {
      background: var(--dark-card);
      color: var(--text-light);
      box-shadow: 0 4px 14px rgba(255,255,255,0.1);
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #f1f1f1;
      white-space: nowrap;
    }

    th {
      background: var(--green);
      color: var(--gold);
      text-transform: uppercase;
    }

    tbody tr:nth-child(even) { background: #f8f8f8; }
    body.dark-mode tbody tr:nth-child(even) { background: #333; }

    footer {
      text-align: center;
      background: var(--green);
      color: var(--gold);
      padding: 20px;
      border-top: 4px solid var(--gold);
      margin-top: 40px;
    }

    /* üîí Blur Overlay for Rounds 6 & 7 */
    #blurOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.7);
      color: var(--green);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      z-index: 50;
      transition: opacity 0.4s ease;
    }

    #blurOverlay.active {
      display: flex;
      opacity: 1;
      animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      th, td {
        padding: 10px 6px;
      }
      .topbar {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-container">
      <h1 class="site-title">Barford Golf Society</h1>
      <nav class="site-nav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="events.html">Events</a></li>
          <li><a href="scores.html" class="active">Scores</a></li>
          <li><a href="admin.html">Admin</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div id="leaderboard" class="leaderboard-banner">üèåÔ∏è Leaderboard loading...</div>

  <div class="scores-container" id="scoresContainer">
    <div id="blurOverlay">üîí Scores hidden until unlocked</div>

    <header class="calc-header">Golf Society Handicap Calculator</header>
    <div class="topbar">
      <input type="password" id="pwInput" placeholder="Enter password">
      <button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
      <button class="btn btn-lock" onclick="lockInputs()">Lock</button>
      <button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
      <button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
      <button class="btn btn-next" onclick="nextRound()">Next ‚ñ∂</button>
      <button class="btn btn-add" onclick="addPlayer()">+ Player</button>
      <button class="btn btn-pass" onclick="changePassword()">Change Password</button>
      <button class="btn btn-reset" id="resetBtn" style="display:none" onclick="confirmReset()">Reset League</button>
      <button class="btn btn-download" onclick="downloadCsv()">Download CSV</button>
      <button class="btn btn-theme" onclick="toggleTheme()">üåì</button>
    </div>

    <main>
      <div class="round-info">
        <h3 id="roundHeader">Round 1 of 7</h3>
      </div>
      <div id="tableContainer">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th id="hcpHeader">Round 1 HCP</th>
              <th>Points</th>
              <th>Adj</th>
              <th id="newHcpHeader">Next HCP</th>
              <th>Total (Best 5)</th>
              <th>DNP</th>
            </tr>
          </thead>
          <tbody id="playersTable"></tbody>
        </table>
      </div>
    </main>
  </div>

  <footer>
    <p>¬© 2025 Barford Golf Society | Scores & Handicap Calculator</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const PASSWORD = "westbrom1997";
  const maxRounds = 7;
  let currentRound = 1;
  let unlocked = false;
  let playersData = [];

  async function loadPlayers() {
    const { data, error } = await supabase.from("scores").select("*").order("id", { ascending: true });
    if (error) {
      console.error("Error loading data:", error);
      return;
    }
    playersData = data || [];
    renderLeaderboard();
  }

  async function savePlayerData(player) {
    const { error } = await supabase
      .from("scores")
      .update(player)
      .eq("id", player.id);
    if (error) console.error("Save error:", error);
  }

  function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("bgsTheme", document.body.classList.contains("dark-mode") ? "dark" : "light");
  }
  if (localStorage.getItem("bgsTheme") === "dark") document.body.classList.add("dark-mode");

  function stablefordAdj(pts) {
    if (pts >= 43) return -3;
    if (pts >= 38) return -2;
    if (pts >= 31) return -1;
    if (pts >= 26) return 0;
    if (pts >= 21) return +1;
    if (pts >= 16) return +2;
    return +3;
  }

  function unlockInputs() {
    const pw = document.getElementById("pwInput").value;
    if (pw !== PASSWORD) return alert("Incorrect password!");
    unlocked = true;
    alert("‚úÖ Scores unlocked");
    renderLeaderboard();
  }

  function lockInputs() {
    unlocked = false;
    alert("üîí Scores locked");
    renderLeaderboard();
  }

  function showBlurOverlay(show) {
    const overlay = document.getElementById("blurOverlay");
    overlay.style.display = show ? "flex" : "none";
  }

  function calculateTotals() {
    return playersData.map(p => {
      const scores = [];
      for (let r = 1; r <= maxRounds; r++) {
        const pts = p[`round_${r}_points`] || (r === p.round ? p.points : 0);
        if (pts) scores.push(pts);
      }
      const total = scores.sort((a, b) => b - a).slice(0, 5).reduce((a, b) => a + b, 0);
      return { id: p.id, name: p.player, total };
    }).sort((a, b) => b.total - a.total);
  }

  async function calculateHandicaps() {
    if (!unlocked) return alert("‚õ≥ Stop trying to add your score ‚Äî it doesn‚Äôt change the fact you‚Äôre bad at golf!");

    const valid = playersData.filter(p => p.points !== null);
    const topScore = valid.length ? Math.max(...valid.map(p => p.points)) : null;

    for (const p of playersData) {
      const pts = parseInt(document.getElementById(`points_${p.id}`).value);
      if (isNaN(pts)) continue;
      p.points = pts;
      let adj = stablefordAdj(pts);
      if (topScore !== null && pts === topScore) adj -= 1;
      const newH = Math.max(0, Math.round((p.handicap || 0) + adj));
      p.adj = adj;
      p.next_handicap = newH;
      await savePlayerData(p);
    }

    loadPlayers();
  }

  async function addPlayer() {
    if (!unlocked) return alert("Enter password first!");
    const name = prompt("Enter new player name:");
    if (!name) return;
    const newPlayer = { player: name, round: 1, points: 0, handicap: 0, next_handicap: 0, adj: 0, total: 0, dnp: false, date: new Date().toISOString() };
    const { error } = await supabase.from("scores").insert([newPlayer]);
    if (error) alert("Error adding player: " + error.message);
    else loadPlayers();
  }

  function nextRound() {
    if (currentRound < maxRounds) currentRound++;
    renderLeaderboard();
  }

  function prevRound() {
    if (currentRound > 1) currentRound--;
    renderLeaderboard();
  }

  function updateLeaderboard() {
    const totals = calculateTotals();
    if (totals.length && currentRound < 6) {
      const leader = totals[0];
      document.getElementById("leaderboard").textContent = `üèÜ Leader: ${leader.name} ‚Äî ${leader.total} pts | Round ${currentRound} of ${maxRounds}`;
    } else if (currentRound >= 6 && !unlocked) {
      document.getElementById("leaderboard").textContent = "üîí Scores hidden until unlocked";
    } else if (currentRound >= 6 && unlocked) {
      const leader = calculateTotals()[0];
      document.getElementById("leaderboard").textContent = `üèÜ Leader: ${leader.name} ‚Äî ${leader.total} pts | Round ${currentRound} of ${maxRounds}`;
    }
  }

  function renderLeaderboard() {
    const tbody = document.getElementById("playersTable");
    tbody.innerHTML = "";

    document.getElementById("roundHeader").textContent = `Round ${currentRound} of ${maxRounds}`;
    document.getElementById("hcpHeader").textContent = `Round ${currentRound} HCP`;

    const blur = (currentRound >= 6 && !unlocked);
    showBlurOverlay(blur);

    playersData.forEach((p, rank) => {
      const tr = document.createElement("tr");
      const editable = unlocked && currentRound === 1;
      tr.innerHTML = `
        <td>${rank + 1 <= 3 ? ["ü•á","ü•à","ü•â"][rank] : rank + 1}</td>
        <td>${p.player}</td>
        <td><input type="number" id="hcp_${p.id}" value="${p.handicap || 0}" ${editable ? "" : "disabled"}></td>
        <td><input type="number" id="points_${p.id}" value="${p.points || ""}" ${unlocked ? "" : "disabled"}></td>
        <td>${p.adj || ""}</td>
        <td>${p.next_handicap || ""}</td>
        <td>${p.total || 0}</td>
        <td><input type="checkbox" disabled ${p.dnp ? "checked" : ""}></td>`;
      tbody.appendChild(tr);
    });

    updateLeaderboard();
  }

  loadPlayers();
  </script>
</body>
</html>
