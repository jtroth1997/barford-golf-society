<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barford Golf Society | Scores</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0a7b50;
      --accent: #d4af37;
      --bg-light: #f5f5f5;
      --bg-dark: #1b1b1b;
      --text-light: #f5f5f5;
      --text-dark: #1b1b1b;
    }
    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      background: var(--bg-light);
      color: var(--text-dark);
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-light);
    }
    header {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      background: #fff;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    body.dark-mode .controls { background: #222; }
    button {
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: white;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 1rem;
    }
    body.dark-mode table { background: #222; }
    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: var(--primary);
      color: white;
    }
    .blur-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(20px);
      display: none;
      justify-content: center;
      align-items: center;
      color: #0a7b50;
      font-size: 1.5rem;
      font-weight: 700;
      z-index: 5;
      pointer-events: none;
    }
    .blur-overlay.active { display: flex; }
    footer {
      text-align: center;
      padding: 1rem;
      background: var(--primary);
      color: white;
      margin-top: 2rem;
    }
    @media(max-width:768px){
      table{display:block;overflow-x:auto;white-space:nowrap;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Barford Golf Society</h1>
    <p id="leaderboard">üèåÔ∏è Leaderboard loading...</p>
  </header>
  <div class="controls">
    <input type="password" id="pwInput" placeholder="Password" />
    <button onclick="unlockInputs()">Unlock</button>
    <button onclick="lockInputs()">Lock</button>
    <button onclick="calculateHandicaps()">Calculate</button>
    <button onclick="prevRound()">‚óÄ Prev</button>
    <button onclick="nextRound()">Next ‚ñ∂</button>
    <button onclick="toggleTheme()">üåì</button>
    <button onclick="resetSeason()">Reset</button>
  </div>
  <main style="padding:1rem;position:relative;">
    <h3 id="roundHeader">Round 1 of 7</h3>
    <table>
      <thead>
        <tr>
          <th>Rank</th><th>Player</th><th id="hcpHeader">Round 1 HCP</th>
          <th>Points</th><th>Adj</th><th>Next HCP</th><th>Total</th>
        </tr>
      </thead>
      <tbody id="playersTable"></tbody>
    </table>
    <div id="blurOverlay" class="blur-overlay">üîí Scores hidden until unlocked</div>
  </main>
  <footer>¬© 2025 Barford Golf Society</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const PASSWORD = "westbrom1997";
    const maxRounds = 7;
    let unlocked = false, currentRound = 1;
    let players = [], hcp = [], nextHcp = [], points = [], adj = [], totals = [];

    async function loadPlayers(){
      const { data, error } = await supabase.from("scores").select("*").order("id",{ascending:true});
      if(error){console.error(error);return;}
      players=data.map(r=>r.player);
      hcp=data.map(r=>r.handicap||0);
      nextHcp=data.map(r=>r.next_handicap||0);
      points=data.map(r=>r.points||0);
      adj=data.map(r=>r.adj||0);
      totals=data.map(r=>r.total||0);
      render();
    }

    function render(){
      const tbody=document.getElementById("playersTable");tbody.innerHTML="";
      players.forEach((p,i)=>{
        tbody.innerHTML+=`
          <tr>
            <td>${i+1}</td>
            <td>${p}</td>
            <td><input id="hcp_${i}" type="number" value="${hcp[i]}" ${unlocked?"":"readonly"}></td>
            <td><input id="pts_${i}" type="number" value="${points[i]}" ${unlocked?"":"readonly"}></td>
            <td>${adj[i]}</td>
            <td>${nextHcp[i]}</td>
            <td>${totals[i]}</td>
          </tr>`;
      });
      document.getElementById("roundHeader").textContent=`Round ${currentRound} of ${maxRounds}`;
      updateBlur();
    }

    function stablefordAdj(pts){
      if(pts>=43)return -3;if(pts>=38)return -2;if(pts>=31)return -1;
      if(pts>=26)return 0;if(pts>=21)return +1;if(pts>=16)return +2;return +3;
    }

    async function calculateHandicaps(){
      if(!unlocked)return alert("Locked!");
      for(let i=0;i<players.length;i++){
        const start=parseFloat(document.getElementById(`hcp_${i}`).value)||0;
        const pts=parseInt(document.getElementById(`pts_${i}`).value);
        if(isNaN(pts))continue;
        const adjVal=stablefordAdj(pts);
        const next=Math.max(0,start+adjVal);
        adj[i]=adjVal;nextHcp[i]=next;points[i]=pts;
        await supabase.from("scores").update({points:pts,adj:adjVal,next_handicap:next}).eq("player",players[i]);
      }
      render();
    }

    function unlockInputs(){
      const pw=document.getElementById("pwInput").value;
      if(pw!==PASSWORD)return alert("Incorrect password");
      unlocked=true;render();
    }
    function lockInputs(){unlocked=false;render();}
    function nextRound(){if(currentRound<maxRounds){currentRound++;render();}}
    function prevRound(){if(currentRound>1){currentRound--;render();}}
    function toggleTheme(){
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("theme",document.body.classList.contains("dark-mode")?"dark":"light");
    }
    if(localStorage.getItem("theme")==="dark")document.body.classList.add("dark-mode");
    function updateBlur(){
      const blur=document.getElementById("blurOverlay");
      blur.classList.toggle("active",!unlocked && currentRound>=6);
    }
    async function resetSeason(){
      const pw=prompt("Enter password to reset:");
      if(pw!==PASSWORD)return alert("Incorrect");
      await supabase.from("scores").update({points:0,adj:0,handicap:0,next_handicap:0,total:0});
      alert("Season reset");location.reload();
    }

    loadPlayers();
  </script>
</body>
</html>
