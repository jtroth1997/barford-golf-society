<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barford Golf Society Handicap Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* (Your existing CSS unchanged) */
    /* ‚Ä¶ */
  </style>
</head>
<body>
<header>
  üèåÔ∏è Barford Golf Society Handicap Calculator
  <div class="dark-toggle">
    <label for="darkSwitch">Dark Mode</label>
    <input type="checkbox" id="darkSwitch">
  </div>
</header>

<div class="navbar">
  <a href="index.html">Home</a>
  <a href="events.html">Events</a>
  <a href="scores.html">Scores</a>
  <a href="admin.html">Admin</a>
</div>

<div class="topbar">
  <input type="password" id="pwInput" placeholder="Enter password">
  <button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
  <button class="btn btn-lock" onclick="lockInputs()">Lock</button>
  <button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
  <button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
  <button class="btn btn-next" onclick="nextRound()">Next ‚ñ∂</button>
  <button class="btn btn-add" onclick="addPlayer()">+ Player</button>
  <button class="btn btn-pass" onclick="changePassword()">Change Password</button>

  <button class="btn btn-export" id="exportLeaderboardBtn" style="display:none" onclick="exportLeaderboardCSV()">Export Leaderboard</button>
  <button class="btn btn-export" id="exportAllBtn" style="display:none" onclick="exportAllCSV()">Export All</button>
  <button class="btn btn-export" id="exportStatsBtn" style="display:none" onclick="exportStatsCSV()">Export Stats</button>
  <button class="btn btn-reset" id="clearLeagueBtn" style="display:none" onclick="confirmReset()">Clear League</button>
</div>

<main>
  <div class="round-info">
    <h3 id="roundHeader">Round 1 of 7</h3>
    <div class="progress-bar"><div id="progressFill"></div></div>
  </div>
  <div id="secretNotice">Rounds 6 & 7 are locked ‚Äî unlock to view/edit.</div>
  <table id="playersTableWrap">
    <thead>
      <tr>
        <th>Rank</th><th>Player</th><th id="hcpHeader">Round 1 HCP</th>
        <th>Points</th><th>Adj</th><th id="newHcpHeader">Next HCP</th>
        <th>Total</th><th>DNP</th><th>üèÜ</th>
      </tr>
    </thead>
    <tbody id="playersTable"></tbody>
  </table>

  <div id="chartContainer" style="display:none;margin-top:40px;">
    <h3 style="text-align:center;color:var(--green)">Handicap Progression</h3>
    <canvas id="hcpChart"></canvas>
  </div>

  <div id="statsGrid" class="stats-grid"></div>
</main>

<div id="toast"></div>

<script>
  // --- Ensure variables declared BEFORE use ---
  const SUPABASE_URL = "https://tzzkgfehtnuizamzlbgr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let PASSWORD = "westbrom1997";
  let unlocked = false;
  let currentRound = 1;
  const maxRounds = 7;

  let players = [], currentHcp = [], nextHcp = [], trophies = [], lastAdj = [], playerScores = [];

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.opacity = 1;
    setTimeout(() => (t.style.opacity = 0), 2500);
  }

  function stablefordAdj(pts) {
    if (pts >= 43) return -3;
    if (pts >= 38) return -2;
    if (pts >= 31) return -1;
    if (pts >= 26) return 0;
    if (pts >= 21) return +1;
    if (pts >= 16) return +2;
    return +3;
  }

  async function loadData() {
    document.body.style.cursor = "wait";

    const { data: roster, error: rError } = await supabase.from("players").select("name").order("name", { ascending:true });
    if (rError) {
      console.error("Error loading players:", rError);
      document.body.style.cursor = "default";
      return;
    }
    players = roster.map(r => r.name);

    // initialize arrays
    currentHcp = players.map(() => 0);
    nextHcp    = players.map(() => null);
    trophies   = players.map(() => 0);
    lastAdj    = players.map(() => "");
    playerScores = players.map(() => Array(maxRounds).fill(null));

    const { data: scores, error: sError } = await supabase.from("scores").select("*");
    if (sError) {
      console.error("Error loading scores:", sError);
      document.body.style.cursor = "default";
      return;
    }

    players.forEach((name,i) => {
      const rows = scores.filter(r => r.player === name);
      rows.forEach(r => {
        const idx = r.round - 1;
        playerScores[i][idx] = r.points;
        if (r.handicap != null) currentHcp[i] = r.handicap;
        if (r.next_handicap != null) nextHcp[i] = r.next_handicap;
        if (r.adj != null) lastAdj[i] = (r.adj>0?"+":"")+r.adj;
      });
    });

    for (let rn = 1; rn <= maxRounds; rn++) {
      let top = -Infinity, winIdx = -1;
      players.forEach((_,i)=>{
        const pts = playerScores[i][rn-1];
        if (pts != null && pts > top) {
          top = pts; winIdx = i;
        }
      });
      if (winIdx >= 0) trophies[winIdx]++;
    }

    renderLeaderboard();
    renderStatsGrid();
    document.body.style.cursor = "default";
  }

  function renderLeaderboard() {
    const tbody = document.getElementById("playersTable");
    tbody.innerHTML = "";

    const totals = players.map((name,i)=>{
      const vals = playerScores[i].filter(v=>v!==null).sort((a,b)=>b-a).slice(0,5);
      const sum  = vals.reduce((a,b)=>a+b,0);
      return { idx:i,name, total:sum };
    }).sort((a,b)=>b.total - a.total);

    totals.forEach((p,rank)=>{
      const i = p.idx;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${rank<3?["ü•á","ü•à","ü•â"][rank]:rank+1}</td>
        <td>${players[i]}</td>
        <td><input type="number" id="hcp_${i}" value="${currentHcp[i]}" ${unlocked?"":"disabled"}></td>
        <td><input type="number" id="pts_${i}" value="${playerScores[i][currentRound-1] ?? ""}" ${unlocked?"":"disabled"}></td>
        <td>${lastAdj[i]}</td>
        <td>${nextHcp[i] ?? ""}</td>
        <td>${p.total}</td>
        <td><input type="checkbox" disabled ${playerScores[i][currentRound-1]==null?"checked":""}></td>
        <td>üèÜ ${trophies[i]}</td>`;
      tbody.appendChild(tr);
    });

    // blur logic
    const wrap = document.getElementById("playersTableWrap");
    const secretNotice = document.getElementById("secretNotice");
    if ((currentRound === 6 || currentRound === 7) && !unlocked) {
      wrap.classList.add("table-secret");
      secretNotice.style.display = "block";
    } else {
      wrap.classList.remove("table-secret");
      secretNotice.style.display = "none";
    }

    // admin only buttons
    ["exportLeaderboardBtn","exportAllBtn","exportStatsBtn","clearLeagueBtn"]
      .forEach(id => {
        document.getElementById(id).style.display = unlocked ? "inline-block" : "none";
      });

    document.getElementById("roundHeader").innerText = `Round ${currentRound} of ${maxRounds}`;
    document.getElementById("hcpHeader").innerText   = `Round ${currentRound} HCP`;
    document.getElementById("progressFill").style.width = `${(currentRound/maxRounds)*100}%`;
  }

  function nextRound(){
    if (currentRound < maxRounds) {
      for (let i=0; i<players.length; i++){
        currentHcp[i] = nextHcp[i] ?? currentHcp[i];
        lastAdj[i] = "";
      }
      currentRound++;
      renderLeaderboard();
    }
  }

  function prevRound(){
    if (currentRound > 1) {
      currentRound--;
      renderLeaderboard();
    }
  }

  function unlockInputs(){
    const pw = document.getElementById("pwInput").value;
    if (pw !== PASSWORD) return alert("Wrong password");
    unlocked = true;
    renderLeaderboard();
    showToast("Unlocked");
  }

  function lockInputs(){
    unlocked = false;
    renderLeaderboard();
    showToast("Locked");
  }

  function changePassword(){
    const old = prompt("Enter current password:");
    if (old !== PASSWORD) return alert("Incorrect password");
    const nw  = prompt("Enter new password:");
    if (nw) { PASSWORD = nw; alert("Password changed"); }
  }

  async function addPlayer(){
    if (!unlocked) return alert("Unlock first");
    const name = prompt("Enter player name:");
    if (!name) return;
    await supabase.from("players").upsert({ name });
    await loadData();
  }

  async function calculateHandicaps(){
    if (!unlocked) return alert("Unlock required");

    for(let i=0; i<players.length; i++){
      const hcp = parseFloat(document.getElementById(`hcp_${i}`).value) || 0;
      const pts = parseInt(document.getElementById(`pts_${i}`).value);
      if (!isNaN(pts)) {
        const adj = stablefordAdj(pts);
        lastAdj[i] = adj>0 ? `+${adj}` : `${adj}`;
        nextHcp[i] = Math.max(0, hcp + adj);
        playerScores[i][currentRound-1] = pts;
        currentHcp[i] = hcp;
      }
    }

    const updates = players.map((name,i)=>{
      const vals = playerScores[i].filter(v=>v!==null).sort((a,b)=>b-a).slice(0,5);
      const total = vals.reduce((a,b)=>a+b,0);
      return {
        player: name,
        round: currentRound,
        handicap: currentHcp[i],
        points: playerScores[i][currentRound-1],
        adj: parseInt(lastAdj[i]) || 0,
        next_handicap: nextHcp[i],
        total: total
      };
    });

    await supabase.from("scores").upsert(updates, { onConflict:["player","round"] });
    renderLeaderboard();
    renderStatsGrid();
  }

  async function confirmReset(){
    if (!unlocked) return alert("Unlock first");
    if (prompt("Enter password to reset league:") !== PASSWORD) return alert("Wrong password");
    if (!confirm("Are you sure you want to reset the league?")) return;
    await supabase.rpc("reset_scores");
    currentRound = 1;
    await loadData();
    showToast("League reset complete");
  }

  async function exportAllCSV(){
    const { data } = await supabase.from("scores").select("*");
    downloadCSV("all_scores", toCSV(data));
  }
  async function exportLeaderboardCSV(){
    const totals = players.map((name,i)=>{
      const vals = playerScores[i].filter(v=>v!==null).sort((a,b)=>b-a).slice(0,5);
      return { Player:name, Total: vals.reduce((a,b)=>a+b,0), Trophies:trophies[i] };
    });
    downloadCSV("leaderboard", toCSV(totals));
  }
  function exportStatsCSV(){
    const rows = players.map((name,i)=>{
      const vals = playerScores[i].filter(v=>v!==null);
      return {
        Player: name,
        Rounds: vals.length,
        Average: vals.length ? (vals.reduce((a,b)=>a+b)/vals.length).toFixed(1) : "",
        Best: vals.length ? Math.max(...vals) : "",
        Worst: vals.length ? Math.min(...vals) : "",
        Trophies: trophies[i]
      };
    });
    downloadCSV("stats", toCSV(rows));
  }
  function downloadCSV(filename, csv){
    const blob = new Blob([csv], { type:"text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
  }

  function renderStatsGrid(){
    const grid = document.getElementById("statsGrid");
    grid.innerHTML="";
    players.forEach((name,i)=>{
      const vals = playerScores[i].filter(v=>v!==null);
      const card = document.createElement("div");
      card.className = "stats-card";
      card.innerHTML = `
        <h4>${name}</h4>
        <p>Rounds: ${vals.length}</p>
        <p>Avg: ${vals.length ? (vals.reduce((a,b)=>a+b)/vals.length).toFixed(1) : "-"}</p>
        <p>Best: ${vals.length ? Math.max(...vals) : "-"}</p>
        <p>Worst: ${vals.length ? Math.min(...vals) : "-"}</p>
        <p>üèÜ ${trophies[i]}</p>`;
      grid.appendChild(card);
    });
  }

  document.getElementById("darkSwitch").addEventListener("change", function(){
    document.body.classList.toggle("dark-mode", this.checked);
  });

</script>

</body>
</html>
