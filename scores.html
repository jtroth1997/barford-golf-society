<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Barford Golf Society Handicap Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --green: #083d0b;
  --gold: #d4af37;
  --cream: #f7f7f5;
  --dark: #1b1b1b;
  --white: #ffffff;
  --silver: #c0c0c0;
  --bronze: #cd7f32;
  --highlight: #e9f5ec;
}
body {
  font-family: "Inter", sans-serif;
  background: linear-gradient(135deg, var(--cream) 40%, #e7ece7);
  color: var(--dark);
  margin: 0;
  padding: 0;
}
header {
  background: linear-gradient(to right, var(--green), #145214);
  color: var(--gold);
  text-align: center;
  padding: 20px;
  font-size: 1.8rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.topbar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  padding: 16px;
  background: var(--white);
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  position: sticky;
  top: 0;
  z-index: 10;
}
input[type=password], input[type=number] {
  font-family: inherit;
  border-radius: 6px;
  border: 1px solid #ccc;
  padding: 8px;
  transition: border 0.2s, box-shadow 0.2s;
}
input[type=password]:focus, input[type=number]:focus {
  border-color: var(--gold);
  box-shadow: 0 0 5px rgba(212,175,55,0.4);
  outline: none;
}
.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  font-size: 0.9rem;
}
.btn:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.btn:active { transform: scale(0.98); }
.btn-unlock { background: var(--gold); color: var(--dark); }
.btn-lock   { background: var(--green); color: var(--white); }
.btn-calc   { background: #ffcc00; color: var(--dark); }
.btn-next, .btn-prev { background: #ddd; color: var(--dark); }
.btn-reset { background: #b22222; color: var(--white); }
.btn-add { background: var(--silver); color: var(--dark); }
.btn-pass { background: var(--bronze); color: var(--white); }

main {
  padding: 20px;
  max-width: 1100px;
  margin: auto;
}
.round-info {
  text-align: center;
  margin-bottom: 15px;
  font-weight: 600;
  color: var(--green);
}
.progress-bar {
  width: 80%;
  height: 10px;
  background: #ddd;
  border-radius: 10px;
  margin: 8px auto 20px;
  overflow: hidden;
}
.progress-bar div {
  height: 100%;
  width: 0%;
  background: var(--gold);
  transition: width 0.5s ease;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--white);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  animation: fadeIn 0.6s ease;
}
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(10px);}
  to {opacity: 1; transform: translateY(0);}
}
th, td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid #f1f1f1;
}
th {
  background: var(--green);
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.9rem;
}
tbody tr:nth-child(even) { background: #f8f8f8; }
tbody tr:hover { background: var(--highlight); }
.blur-locked { filter: blur(6px); pointer-events: none; opacity: 0.6; }
@media (max-width: 700px) {
  th, td { font-size: 12px; padding: 8px; }
  .btn { font-size: 0.8rem; padding: 6px 10px; }
}
</style>
</head>
<body>

<header>üèåÔ∏è Barford Golf Society Handicap Calculator</header>
<div class="topbar">
  <input type="password" id="pwInput" placeholder="Enter password">
  <button class="btn btn-unlock" onclick="unlockInputs()">Unlock</button>
  <button class="btn btn-lock" onclick="lockInputs()">Lock</button>
  <button class="btn btn-calc" onclick="calculateHandicaps()">Calculate</button>
  <button class="btn btn-prev" onclick="prevRound()">‚óÄ Prev</button>
  <button class="btn btn-next" id="nextBtn" onclick="nextRound()">Next ‚ñ∂</button>
  <button class="btn btn-add" onclick="addPlayer()">+ Player</button>
  <button class="btn btn-pass" onclick="changePassword()">Change Password</button>
  <button class="btn btn-reset" id="resetBtn" style="display:none" onclick="confirmReset()">Reset League</button>
</div>

<main>
  <div class="round-info">
    <h3 id="roundHeader">Round 1 of 7</h3>
    <div class="progress-bar"><div id="progressFill"></div></div>
  </div>

  <div id="tableContainer">
    <table>
      <thead>
        <tr>
          <th>Rank</th><th>Player</th><th id="hcpHeader">Round 1 HCP</th><th>Points</th>
          <th>Adj</th><th id="newHcpHeader">Next HCP</th><th>Total (Best 5)</th><th>DNP</th>
        </tr>
      </thead>
      <tbody id="playersTable"></tbody>
    </table>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = window.supabase.createClient(
  "https://tzzkgfehtnuizamzlbgr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ"
);
let PASSWORD = "westbrom1997";
let unlocked = false;
let currentRound = 1;
const maxRounds = 7;
let players = [];
let currentHcp = [];
let nextHcp = [];
let playerScores = [];
let lastAdj = [];

async function loadData() {
  const { data, error } = await supabase.from("scores").select("*").order("player", { ascending: true });
  if (error) { console.error(error); return; }
  if (!data.length) {
    console.log("No players in Supabase, using defaults");
    players = ["Brad Davies","Will Lovell","Richard Jones","David Hardcastle","Tim Oliver"];
    currentHcp = new Array(players.length).fill(0);
    nextHcp = new Array(players.length).fill(null);
    playerScores = players.map(()=>Array(maxRounds).fill(null));
    lastAdj = new Array(players.length).fill("");
  } else {
    players = data.map(r=>r.player);
    currentHcp = data.map(r=>r.handicap||0);
    nextHcp = data.map(r=>r.next_handicap||0);
    playerScores = data.map(()=>Array(maxRounds).fill(null));
    lastAdj = data.map(r=>r.adj ? (r.adj>0?`+${r.adj}`:r.adj):"");
  }
  renderLeaderboard();
}

async function saveData() {
  for (let i=0;i<players.length;i++){
    const player=players[i];
    const total=playerScores[i].filter(v=>v!==null).sort((a,b)=>b-a).slice(0,5).reduce((a,b)=>a+b,0);
    const pts=playerScores[i][currentRound-1]||0;
    const adj=lastAdj[i]?parseInt(lastAdj[i]):0;
    const next=nextHcp[i]??currentHcp[i];
    await supabase.from("scores").upsert({
      player:player,round:currentRound,handicap:currentHcp[i],
      points:pts,adj:adj,next_handicap:next,total:total,updated_at:new Date().toISOString()
    },{onConflict:['player']});
  }
}

function stablefordAdj(pts){if(pts>=43)return-3;if(pts>=38)return-2;if(pts>=31)return-1;
  if(pts>=26)return 0;if(pts>=21)return+1;if(pts>=16)return+2;return+3;}

function unlockInputs(){const pw=document.getElementById("pwInput").value;if(pw!==PASSWORD)return alert("Wrong password");unlocked=true;renderLeaderboard();}
function lockInputs(){unlocked=false;renderLeaderboard();}

function calculateHandicaps(){
  if(!unlocked)return alert("Unlock first");
  for(let i=0;i<players.length;i++){
    const hcp=parseFloat(document.getElementById(`hcp_${i}`).value)||0;
    const pts=parseInt(document.getElementById(`points_${i}`).value);
    if(isNaN(pts))continue;
    const adj=stablefordAdj(pts);
    const next=Math.max(0,hcp+adj);
    playerScores[i][currentRound-1]=pts;
    lastAdj[i]=(adj>0?"+":"")+adj;
    currentHcp[i]=hcp;nextHcp[i]=next;
  }
  renderLeaderboard();saveData();
}

function calculateTotals(){
  return players.map((n,i)=>{
    const s=playerScores[i].filter(v=>v!==null);
    const total=s.sort((a,b)=>b-a).slice(0,5).reduce((a,b)=>a+b,0);
    return {i,name:n,total};
  }).sort((a,b)=>b.total-a.total);
}

function renderLeaderboard(){
  const tbody=document.getElementById("playersTable");
  tbody.innerHTML="";
  const totals=calculateTotals();
  totals.forEach((p,rank)=>{
    const i=p.i;const tr=document.createElement("tr");
    tr.innerHTML=`<td>${rank===0?"ü•á":rank===1?"ü•à":rank===2?"ü•â":rank+1}</td>
    <td>${p.name}</td>
    <td><input type="number" id="hcp_${i}" value="${currentHcp[i]}" ${unlocked?"":"disabled"}></td>
    <td><input type="number" id="points_${i}" value="${playerScores[i][currentRound-1]??""}" ${unlocked?"":"disabled"}></td>
    <td>${lastAdj[i]}</td><td>${nextHcp[i]??""}</td><td>${p.total}</td>
    <td><input type="checkbox" disabled ${playerScores[i][currentRound-1]==null?"checked":""}></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("hcpHeader").textContent=`Round ${currentRound} HCP`;
  document.getElementById("newHcpHeader").textContent=`Next HCP`;
  document.getElementById("roundHeader").textContent=`Round ${currentRound} of ${maxRounds}`;
  document.getElementById("progressFill").style.width=(currentRound/maxRounds*100)+"%";
}

function nextRound(){if(currentRound<maxRounds){for(let i=0;i<players.length;i++){currentHcp[i]=nextHcp[i]??currentHcp[i];lastAdj[i]="";}currentRound++;renderLeaderboard();}}
function prevRound(){if(currentRound>1){currentRound--;renderLeaderboard();}}

function addPlayer(){const name=prompt("Enter player name:");if(!name)return;players.push(name);currentHcp.push(0);nextHcp.push(null);playerScores.push(Array(maxRounds).fill(null));lastAdj.push("");saveData();renderLeaderboard();}
function changePassword(){const oldPw=prompt("Enter current password:");if(oldPw!==PASSWORD)return alert("Incorrect password");const newPw=prompt("Enter new password:");if(newPw){PASSWORD=newPw;alert("Password changed!");}}
function confirmReset(){const pw=prompt("Enter password to reset league:");if(pw!==PASSWORD)return alert("Incorrect password");supabase.from("scores").delete().neq("id",0);alert("League reset!");loadData();}

loadData();
</script>
</body>
</html>
