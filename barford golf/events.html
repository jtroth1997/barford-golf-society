<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Events | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --green:#005a2b;--gold:#d4af37;--light-bg:#f7f7f5;--card:#fff;
}
body{font-family:"Inter",sans-serif;margin:0;background:var(--light-bg);color:#1b1b1b;}
header,footer{background:var(--green);color:#fff;padding:15px 0;}
.header-container{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto;padding:0 20px;}
.site-title{color:var(--gold);}
.site-nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0;}
.site-nav a{color:#fff;text-decoration:none;font-weight:600;}
.site-nav a:hover,.active{color:var(--gold);}
.container{max-width:1100px;margin:40px auto;padding:0 20px;}
.event-card{background:var(--card);padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.event-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.event-name{color:var(--green);font-size:1.3rem;font-weight:700;}
.rsvp-form{margin-top:15px;border-top:1px solid #ccc;padding-top:15px;}
label{display:block;margin-top:8px;font-weight:600;}
select,input[type="text"],input[type="date"],button{padding:8px;border-radius:6px;border:1px solid #ccc;font-family:inherit;}
button{background:var(--green);color:#fff;font-weight:600;cursor:pointer;margin-top:10px;}
button:hover{background:#0a6b34;}
button.danger{background:#b22222;}
.hidden{display:none;}
.notice{background:#ffeecc;color:#333;padding:10px;border-radius:6px;margin:10px 0;font-size:0.95rem;}
footer{text-align:center;color:var(--gold);border-top:4px solid var(--gold);margin-top:40px;padding:20px;}
#createEventForm{background:#fff;padding:20px;border-radius:10px;margin-bottom:30px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
.small{font-size:.9rem;color:#666;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width: 700px){ .row{grid-template-columns:1fr;} }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html" class="active">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <h2>Events</h2>

  <!-- Admin Event Creator -->
  <div id="adminCreate">
    <h3>Create a New Event (Admin Only)</h3>
    <div id="adminLogin">
      <input type="password" id="adminPw" placeholder="Enter admin password">
      <button type="button" id="unlockBtn">Unlock</button>
      <p class="small">Creating events is password protected.</p>
    </div>

    <div id="createEventForm" class="hidden">
      <div class="row">
        <div>
          <label>Event Name</label>
          <input type="text" id="eventName" required>
        </div>
        <div>
          <label>Location</label>
          <input type="text" id="eventLocation" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Date</label>
          <input type="date" id="eventDate" required>
        </div>
        <div>
          <label>Price (¬£)</label>
          <input type="text" id="eventPrice" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Round Number</label>
          <select id="eventRound">
            <option value="1">Round 1</option>
            <option value="2">Round 2</option>
            <option value="3">Round 3</option>
            <option value="4">Round 4</option>
            <option value="5">Round 5</option>
            <option value="6">Round 6</option>
            <option value="7">Round 7</option>
          </select>
        </div>
      </div>

      <button type="button" id="createEventBtn">Create Event</button>
      <button type="button" id="lockBtn" class="danger">Lock</button>
    </div>
  </div>

  <h2 style="margin-top:40px;">Upcoming Events</h2>
  <div id="eventList"></div>
</div>

<footer><p>¬© 2025 Barford Golf Society</p></footer>

<script>
/* =========================
   CONFIG & DATA SOURCING
   ========================= */
const ADMIN_PASSWORD = "westbrom1997";
let rsvps  = JSON.parse(localStorage.getItem('bgsRsvps')  || '[]');
let events = JSON.parse(localStorage.getItem('bgsEvents') || '[]');

const FALLBACK_NAMES = [
  "Brad Davies","Will Lovell","Richard Jones","David Hardcastle","Tim Oliver","John Hawkes","Mike Cook","Colin Oliver",
  "Gary Moyce","David Jordan","Nick Benbow","Simon Morgan","Wes Lacey","Chris Oliver","Burt Pickering","Chris Harris",
  "Derek Lewis","Liz Oliver","Jack Troth","Lucie Byerley","David Pritchard","Robert Pocknell","John Close","Nick Wright",
  "Matt Oliver","Vince Hall","Elliot Hobbs","Will Hunt","Martc Taylor","Simon Meade","Emma Saywell","Cam Tolley",
  "John Blackwell","Bekim","Zac Lovell","Clive Irwin"
];

// Pull the player list from Scores (golfCalcData) if present, else fallback.
function hydratePlayers() {
  // If we've cached bgsPlayers (objects {name, handicap}) use that first
  let cached = JSON.parse(localStorage.getItem('bgsPlayers') || '[]');
  if (Array.isArray(cached) && cached.length && cached[0]?.name) return cached;

  // Try the calculator blob
  const calc = JSON.parse(localStorage.getItem('golfCalcData') || '{}');
  if (calc && Array.isArray(calc.players) && calc.players.length) {
    const arr = calc.players.map((name, i) => ({
      name,
      handicap: (Array.isArray(calc.currentHcp) && calc.currentHcp[i] != null) ? calc.currentHcp[i] : 0
    }));
    localStorage.setItem('bgsPlayers', JSON.stringify(arr));
    return arr;
  }

  // Fallback static list
  const arr = FALLBACK_NAMES.map(n => ({ name: n, handicap: 0 }));
  localStorage.setItem('bgsPlayers', JSON.stringify(arr));
  return arr;
}

let players = hydratePlayers();

// Listen for changes from Scores page (if open in another tab)
window.addEventListener('storage', (e) => {
  if (e.key === 'bgsPlayers' || e.key === 'golfCalcData') {
    players = hydratePlayers();
    renderEvents();
  }
});

/* =========================
   ADMIN GATE
   ========================= */
const adminLogin = document.getElementById("adminLogin");
const createForm = document.getElementById("createEventForm");

// Always start locked
localStorage.removeItem("bgsAdminUnlocked");

document.getElementById("unlockBtn").addEventListener("click", () => {
  const pw = document.getElementById("adminPw").value.trim();
  if (pw === ADMIN_PASSWORD) {
    adminLogin.classList.add("hidden");
    createForm.classList.remove("hidden");
    alert("‚úÖ Admin access granted!");
  } else {
    alert("‚ùå Incorrect password");
  }
});

document.getElementById("lockBtn").addEventListener("click", () => {
  createForm.classList.add("hidden");
  adminLogin.classList.remove("hidden");
  document.getElementById("adminPw").value = "";
  alert("üîí Admin panel locked.");
});

/* =========================
   CREATE EVENT
   ========================= */
document.getElementById("createEventBtn").addEventListener("click", () => {
  const name = document.getElementById("eventName").value.trim();
  const location = document.getElementById("eventLocation").value.trim();
  const date = document.getElementById("eventDate").value;
  const price = document.getElementById("eventPrice").value.trim();
  const round = document.getElementById("eventRound").value;

  if (!name || !location || !date || !price) {
    alert("‚ö†Ô∏è Please fill in all fields before creating the event.");
    return;
  }

  const newEvent = { name, location, date, price, round };
  events.push(newEvent);
  localStorage.setItem("bgsEvents", JSON.stringify(events));
  alert(`üèåÔ∏è Event "${name}" created successfully!`);

  // reset form
  document.getElementById("eventName").value = "";
  document.getElementById("eventLocation").value = "";
  document.getElementById("eventDate").value = "";
  document.getElementById("eventPrice").value = "";
  document.getElementById("eventRound").value = "1";

  renderEvents();
});

/* =========================
   RENDER EVENTS
   ========================= */
function renderEvents() {
  const list = document.getElementById("eventList");
  if (!events.length) {
    list.innerHTML = "<p>No events yet.</p>";
    return;
  }

  list.innerHTML = "";

  // helpful notice if we have no players
  if (!players.length) {
    const n = document.createElement('div');
    n.className = 'notice';
    n.innerHTML = '‚ö†Ô∏è No player names found. Please open the <strong>Scores</strong> page first and ensure data is saved.';
    list.appendChild(n);
  }

  events
    .slice()
    .sort((a,b)=>new Date(a.date) - new Date(b.date))
    .forEach(ev => {
      const safeId = ev.name.replace(/[^a-zA-Z0-9_-]/g, "_");
      const div = document.createElement("div");
      div.className = "event-card";

      // Build options once
      const playerOptions = players.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

      div.innerHTML = `
        <div class="event-header">
          <div>
            <div class="event-name">${ev.name}</div>
            <div>${ev.location} ‚Äî ${ev.date}</div>
            <div><strong>Round:</strong> ${ev.round}</div>
          </div>
          <div><strong>Price:</strong> ¬£${ev.price}</div>
        </div>

        <form class="rsvp-form" onsubmit="submitRSVP(event,'${ev.name}','${safeId}')">
          <h4>RSVP for this Event</h4>

          <label>Your Name</label>
          <select id="playerSelect_${safeId}" onchange="onPlayerChange('${safeId}')">
            <option value="">Select member</option>
            ${playerOptions}
          </select>
          <span id="handicapDisplay_${safeId}" style="margin-left:10px;color:#555;"></span>

          <label><input type="checkbox" id="guestCheck_${safeId}" onchange="toggleGuest('${safeId}')"> Guest?</label>
          <input type="text" id="guestName_${safeId}" class="hidden" placeholder="Enter guest name">

          <label>Buggy?</label>
          <select id="buggy_${safeId}" onchange="toggleBuggy('${safeId}')">
            <option>No</option><option>Yes</option>
          </select>

          <div id="buggyPartnerGroup_${safeId}" class="hidden">
            <label>Buggy Partner</label>
            <select id="partner_${safeId}">
              <option value="">Select partner</option>
              ${playerOptions}
            </select>
            <p class="small">Selecting a partner will automatically RSVP them too.</p>
          </div>

          <label>Attending?</label>
          <select id="attend_${safeId}"><option>Yes</option><option>No</option></select>

          <button type="submit">Submit RSVP</button>
        </form>

        <div class="rsvp-list" id="rsvpList_${safeId}"></div>
      `;
      list.appendChild(div);

      // Initial render of list for this event
      renderRSVPList(ev.name, safeId);
    });
}

/* =========================
   FORM HELPERS
   ========================= */
function toggleBuggy(safeId) {
  const show = document.getElementById(`buggy_${safeId}`).value === "Yes";
  document.getElementById(`buggyPartnerGroup_${safeId}`).classList.toggle("hidden", !show);
}

function onPlayerChange(safeId) {
  // update handicap display
  const sel = document.getElementById(`playerSelect_${safeId}`);
  const p = players.find(x => x.name === sel.value);
  document.getElementById(`handicapDisplay_${safeId}`).textContent = p ? `Handicap: ${p.handicap}` : '';

  // also refresh partner options so you can't pick yourself
  const partnerSel = document.getElementById(`partner_${safeId}`);
  if (!partnerSel) return;
  const current = partnerSel.value;
  partnerSel.innerHTML = `<option value="">Select partner</option>` +
    players
      .filter(x => x.name !== sel.value) // exclude self
      .map(x => `<option value="${x.name}">${x.name}</option>`).join('');
  // try to keep previous choice if still valid
  if ([...partnerSel.options].some(o=>o.value===current)) partnerSel.value = current;
}

function toggleGuest(safeId) {
  const chk = document.getElementById(`guestCheck_${safeId}`);
  document.getElementById(`guestName_${safeId}`).classList.toggle("hidden", !chk.checked);
}

/* =========================
   RSVP SUBMIT
   ========================= */
function submitRSVP(e, eventName, safeId) {
  e.preventDefault();

  const playerSel = document.getElementById(`playerSelect_${safeId}`);
  const guestChk  = document.getElementById(`guestCheck_${safeId}`);
  const guestName = document.getElementById(`guestName_${safeId}`).value.trim();
  const buggy     = document.getElementById(`buggy_${safeId}`).value;
  const partner   = document.getElementById(`partner_${safeId}`)?.value || "";
  const attend    = document.getElementById(`attend_${safeId}`).value;

  // Determine RSVP name & handicap
  const chosenName = guestChk.checked ? guestName : playerSel.value;
  if (!chosenName) return alert("Please select or enter a name");

  const playerObj = players.find(x => x.name === playerSel.value);
  const handicap  = guestChk.checked ? "Guest" : (playerObj ? playerObj.handicap : 0);

  // MAIN RSVP
  const mainRSVP = { event: eventName, attend, name: chosenName, handicap, buggy, partner };
  // Upsert (avoid duplicates)
  upsertRsvp(mainRSVP);

  // AUTO PARTNER RSVP (only if buggy Yes + partner chosen + partner is a member)
  if (buggy === "Yes" && partner) {
    const partnerObj = players.find(x => x.name === partner);
    const partnerRSVP = {
      event: eventName,
      attend: "Yes",
      name: partner,
      handicap: partnerObj ? partnerObj.handicap : 0,
      buggy: "Yes",
      partner: chosenName
    };
    upsertRsvp(partnerRSVP);
  }

  localStorage.setItem("bgsRsvps", JSON.stringify(rsvps));
  renderRSVPList(eventName, safeId);
  alert("‚úÖ RSVP saved");
}

function upsertRsvp(newOne) {
  const idx = rsvps.findIndex(r => r.event === newOne.event && r.name === newOne.name);
  if (idx >= 0) {
    rsvps[idx] = newOne;
  } else {
    rsvps.push(newOne);
  }
}

/* =========================
   RSVP LIST RENDER
   ========================= */
function renderRSVPList(eventName, safeId) {
  const data = rsvps.filter(r => r.event === eventName);
  const div  = document.getElementById(`rsvpList_${safeId}`);
  if (!data.length) {
    div.innerHTML = "<em>No RSVPs yet.</em>";
    return;
  }
  div.innerHTML = "<strong>Attendees:</strong><ul>" +
    data
      .filter(d => d.attend === "Yes")
      .map(d => `<li>${d.name} (${d.handicap}) ${d.buggy === "Yes" ? "üõ∫" : ""} ${d.partner ? `‚Äî partner: ${d.partner}` : ""}</li>`)
      .join('') +
    "</ul>";
}

/* =========================
   INIT
   ========================= */
renderEvents();
</script>
</body>
</html>
