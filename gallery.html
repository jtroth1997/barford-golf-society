<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gallery | Barford Golf Society</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --green:#005a2b; --gold:#d4af37; --ink:#1b1b1b; --bg:#f7f7f5; --btn-radius:6px; --tile-radius:12px; --shadow:0 4px 10px rgba(0,0,0,.1);
}
body { font-family:"Inter",sans-serif; background:var(--bg); color:var(--ink); margin:0; }
.site-header, footer { background:var(--green); color:#fff; padding:15px 0; }
.header-container { display:flex; justify-content:space-between; align-items:center; max-width:1100px; margin:0 auto; padding:0 20px; }
.site-title { color:var(--gold); margin:0; font-size:1.5rem; }
.site-nav ul { list-style:none; display:flex; gap:20px; margin:0; padding:0; }
.site-nav a { color:#fff; text-decoration:none; font-weight:600; }
.site-nav a:hover, .site-nav .active { color:var(--gold); }

/* Banner slideshow */
.banner { position:relative; width:100%; height:60vh; min-height:340px; background:#000; overflow:hidden; display:flex; align-items:center; justify-content:center; }
.banner img { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; opacity:0; transition:opacity 1s ease-in-out; cursor:pointer; }
.banner img.active { opacity:1; }
.arrow { position:absolute; top:50%; transform:translateY(-50%); color:#fff; font-size:2.2rem; background:rgba(0,0,0,0.45); border-radius:50%; padding:8px 14px; cursor:pointer; user-select:none; z-index:10; transition:background .2s; }
.arrow.left{ left:20px; } .arrow.right{ right:20px; }
.arrow:hover{ background:rgba(0,0,0,.75); }

/* Page layout */
.container { max-width:1100px; margin:40px auto; padding:0 20px; }
.upload-box { background:#fff; padding:20px; border-radius:var(--tile-radius); box-shadow:var(--shadow); text-align:center; }
.upload-box h2 { color:var(--green); margin:0 0 10px; }
.preview { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:12px; }
.preview-item { position:relative; width:150px; height:100px; border-radius:var(--tile-radius/2); overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.08); }
.preview-item img { width:100%; height:100%; object-fit:cover; }
.preview-item button { position:absolute; top:4px; right:4px; background:rgba(0,0,0,0.5); border:none; color:#fff; border-radius:50%; width:24px; height:24px; cursor:pointer; }
.btn { background:var(--green); color:#fff; border:none; border-radius:var(--btn-radius); padding:10px 16px; font-weight:700; cursor:pointer; transition:filter .2s; margin-top:12px; }
.btn:hover { filter:brightness(1.05); }
.btn.red { background:#b22222; } .btn.red:hover { filter:brightness(1.1); }

/* Gallery grid */
.gallery-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-top:28px; }
.tile { background:#fff; border-radius:var(--tile-radius); box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; }
.tile img { width:100%; height:180px; object-fit:cover; cursor:pointer; }
.tile .tile-actions { padding:10px; display:flex; justify-content:center; gap:8px; border-top:1px solid #eee; }

/* Lightbox */
.lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
.lightbox img { max-width:90%; max-height:85%; object-fit:contain; border-radius:10px; }
.lightbox .close { position:absolute; top:18px; right:30px; color:#fff; font-size:2rem; cursor:pointer; }
.lightbox .lb-arrow { position:absolute; top:50%; transform:translateY(-50%); color:#fff; font-size:2.2rem; background:rgba(255,255,255,.15); border-radius:50%; padding:8px 14px; cursor:pointer; user-select:none; }
.lightbox .lb-left{ left:30px; } .lightbox .lb-right{ right:30px; }
.lightbox .lb-arrow:hover { background:rgba(255,255,255,.3); }

footer { text-align:center; color:var(--gold); border-top:4px solid var(--gold); margin-top:40px; padding:20px; }
@media(max-width:600px){ .banner{height:40vh;} .site-title{font-size:1.2rem;} }
</style>
</head>
<body>
<header class="site-header">
  <div class="header-container">
    <h1 class="site-title">Barford Golf Society</h1>
    <nav class="site-nav">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="scores.html">Scores</a></li>
        <li><a href="gallery.html" class="active">Gallery</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="banner" id="banner">
  <div class="arrow left" onclick="prevSlide()">&#10094;</div>
  <div class="arrow right" onclick="nextSlide()">&#10095;</div>
</div>

<div class="container">
  <div class="upload-box">
    <h2>Upload Your Golf Photos</h2>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <div class="preview" id="preview"></div>
    <button id="approveBtn" class="btn" style="display:none">Approve Uploads</button>
  </div>

  <h3 style="color: var(--green); text-align: center; margin-top: 32px;">Gallery</h3>
  <div class="gallery-grid" id="galleryGrid"></div>
</div>

<div class="lightbox" id="lightbox">
  <span class="close" onclick="closeLightbox()">×</span>
  <div class="lb-arrow lb-left" onclick="lbPrev()">&#10094;</div>
  <img id="lightboxImg" src="">
  <div class="lb-arrow lb-right" onclick="lbNext()">&#10095;</div>
</div>

<footer><p>© 2025 Barford Golf Society</p></footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://tzzkgfehtnuizamzlbgr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6emtnZmVodG51aXphbXpsYmdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MzY5ODAsImV4cCI6MjA3ODAxMjk4MH0.2mf4RMbJJvPo0NApywlrDyHuqAMfMyEWxgOS2ZSP4KQ';
const BUCKET_NAME = 'gallery-images';
const UPLOAD_PATH = 'uploads/';
const ADMIN_PASSWORD = 'westbrom1997';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let gallery = [];
let previewFiles = [];
let currentIndex = 0;
let lightboxIndex = 0;

const banner = document.getElementById('banner');
const previewEl = document.getElementById('preview');
const approveBtn = document.getElementById('approveBtn');
const grid = document.getElementById('galleryGrid');
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightboxImg');

async function loadGallery() {
  const { data: objects, error } = await supabase.storage.from(BUCKET_NAME).list(UPLOAD_PATH, { limit:1000 });
  if(error){ console.error(error); return; }
  // Rebuild gallery from Supabase live storage
  gallery = objects.filter(f => !f.name.endsWith('/')).map(f => ({
    url: supabase.storage.from(BUCKET_NAME).getPublicUrl(UPLOAD_PATH + f.name).data.publicUrl,
    path: UPLOAD_PATH + f.name
  }));
  renderBanner();
  renderGrid();
}

function renderBanner(){
  banner.querySelectorAll('img.banner-img, p.empty').forEach(n=>n.remove());
  if(!gallery.length){
    const p = document.createElement('p'); p.textContent = 'No photos yet'; p.style.color='#fff'; p.style.textAlign='center'; p.style.margin='0 auto';
    banner.appendChild(p); return;
  }
  gallery.forEach((item,i)=>{
    const img=document.createElement('img'); img.className='banner-img'; img.src=item.url;
    img.classList.toggle('active',i===currentIndex); img.addEventListener('click',()=>openLightbox(i));
    banner.appendChild(img);
  });
}

function nextSlide(){ if(!gallery.length)return; currentIndex=(currentIndex+1)%gallery.length; updateBannerActive(); }
function prevSlide(){ if(!gallery.length)return; currentIndex=(currentIndex-1+gallery.length)%gallery.length; updateBannerActive(); }
function updateBannerActive(){ banner.querySelectorAll('img.banner-img').forEach((img,i)=>img.classList.toggle('active',i===currentIndex)); }
setInterval(nextSlide,5000);

function renderGrid(){
  grid.innerHTML='';
  gallery.forEach((item,i)=>{
    const tile=document.createElement('div'); tile.className='tile';
    const img=document.createElement('img'); img.src=item.url; img.alt=`Photo ${i+1}`; img.addEventListener('click',()=>openLightbox(i));
    const actions=document.createElement('div'); actions.className='tile-actions';
    const delBtn=document.createElement('button'); delBtn.className='btn red'; delBtn.textContent='Delete';
    delBtn.addEventListener('click',async e=>{
      e.stopPropagation();
      const pw = prompt('Enter admin password to delete this photo:');
      if(pw!==ADMIN_PASSWORD){ alert('Incorrect password.'); return; }
      if(!confirm('Delete this photo?')) return;
      const { error } = await supabase.storage.from(BUCKET_NAME).remove([item.path]);
      if(error){ console.error(error); alert('Error deleting photo.'); return; }
      await loadGallery(); // reload gallery after delete
    });
    actions.appendChild(delBtn); tile.appendChild(img); tile.appendChild(actions); grid.appendChild(tile);
  });
}

function openLightbox(i){ lightboxIndex=i; lightboxImg.src=gallery[i].url; lightbox.style.display='flex'; }
function closeLightbox(){ lightbox.style.display='none'; }
function lbNext(){ if(!gallery.length) return; lightboxIndex=(lightboxIndex+1)%gallery.length; lightboxImg.src=gallery[lightboxIndex].url; }
function lbPrev(){ if(!gallery.length) return; lightboxIndex=(lightboxIndex-1+gallery.length)%gallery.length; lightboxImg.src=gallery[lightboxIndex].url; }

document.getElementById('fileInput').addEventListener('change', e=>{
  previewEl.innerHTML=''; previewFiles=Array.from(e.target.files);
  previewFiles.forEach((file,idx)=>{
    const rd=new FileReader();
    rd.onload=()=>{
      const wrapper=document.createElement('div'); wrapper.className='preview-item';
      const img=document.createElement('img'); img.src=rd.result; wrapper.appendChild(img);
      const btn=document.createElement('button'); btn.textContent='×'; btn.title='Remove photo';
      btn.addEventListener('click',()=>{
        previewFiles.splice(idx,1); wrapper.remove(); if(!previewFiles.length) approveBtn.style.display='none';
      }); wrapper.appendChild(btn); previewEl.appendChild(wrapper);
    }; rd.readAsDataURL(file);
  });
  approveBtn.style.display=previewFiles.length?'inline-block':'none';
});

async function approveUploads(){
  if(!previewFiles.length) return alert('No photos selected.');
  try{
    for(const file of previewFiles){
      const filePath = UPLOAD_PATH + Date.now()+'_'+file.name;
      const { error } = await supabase.storage.from(BUCKET_NAME).upload(filePath,file,{ contentType:file.type });
      if(error){ console.error(error); alert('Upload failed'); return; }
      const url = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath).data.publicUrl;
      gallery.push({url,path:filePath});
    }
    previewFiles=[]; previewEl.innerHTML=''; approveBtn.style.display='none';
    await loadGallery();
    alert('✅ Photos uploaded!');
  }catch(err){ console.error(err); alert('Upload error'); }
}
approveBtn.addEventListener('click',approveUploads);

loadGallery();
window.nextSlide=nextSlide;
window.prevSlide=prevSlide;
window.lbNext=lbNext;
window.lbPrev=lbPrev;
window.closeLightbox=closeLightbox;
</script>
</body>
</html>
